<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>案件進度追蹤系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 添加 SortableJS 程式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            padding-bottom: 90px; /* 增加底部內邊距以容納動態內容 */
        }
        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
        }
        .nav-link i {
            font-size: 1.5rem;
            margin-bottom: 0.2rem;
        }
        .fixed-bottom {
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        .case-card {
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .sort-icon {
            cursor: pointer;
        }
        .sort-icon i {
            font-size: 1.5rem; /* 增大圖示尺寸 */
            vertical-align: middle; /* 輕微垂直對齊調整 */
        }
        .progress-item {
            border-left: 3px solid #0d6efd;
            padding-left: 15px;
            margin-bottom: 15px;
        }
        .file-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            object-fit: contain;
        }
        .video-preview {
            max-width: 100%;
            margin-top: 10px;
        }
        /* 檔案預覽模態框樣式 */
        #file-preview-modal {
            z-index: 1060 !important; /* 確保在其他模態框上方 */
        }
        .modal-backdrop + .modal-backdrop {
            z-index: 1059; /* 第二個backdrop的z-index */
        }
        /* 改善手機顯示 */
        @media (max-width: 768px) {
            .card-img-top {
                max-height: 150px;
                object-fit: contain;
            }
            .modal-dialog-centered {
                align-items: center;
            }
        }
        
        /* 檔案容器樣式 */
        .file-container {
            position: relative;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .file-container.loading::before {
            content: "載入中...";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.1);
            z-index: 1;
        }
        
        /* 錯誤覆蓋樣式 */
        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.05);
            z-index: 2;
        }
        
        .retry-btn {
            padding: 0.25rem 0.5rem;
            line-height: 1;
        }
        
        .fallback-link {
            text-align: center;
            padding: 10px;
        }
        
        /* 設定提示樣式 */
        .deployment-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
        }
        
        .person-tag {
            padding: 5px 10px;
            margin: 2px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }
        
        .person-tag:hover {
            filter: brightness(1.1);
        }
        
        .tag-input-container {
            min-height: 38px;
            padding: 0.25rem 0.5rem;
            cursor: text;
        }
        
        .tag-input {
            outline: none;
            min-width: 60px;
            padding: 0.25rem;
            height: 28px;
        }
        
        .tag-area {
            gap: 0.25rem;
        }
        
        .tag-suggestions {
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            display: none;
            margin-top: 2px;
        }
        
        .tag-suggestion-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        
        .tag-suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .create-tag-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #007bff;
        }
        
        .create-tag-option:hover {
            background-color: #f8f9fa;
        }
        
        /* 收藏按鈕樣式 */
        .favorite-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
            padding: 2px;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .favorite-icon.inactive {
            color: #adb5bd;
            background-color: white;
        }
        
        .favorite-icon.active {
            color: #ffc107;
            background-color: #fff8e1;
        }
        
        /* 刪除按鈕樣式 */
        .delete-icon {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
            padding: 5px;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dc3545;
            background-color: white;
        }
        
        .delete-icon:hover {
            transform: scale(1.1);
            background-color: #fee;
        }
        
        .inline-tag {
            display: inline-flex;
            align-items: center;
            margin: 2px;
            padding: 3px 8px;
            border-radius: 12px;
            white-space: nowrap;
        }
        
        .inline-tag .tag-remove {
            margin-left: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        #related-people-candidates, #progress-people-candidates {
            min-height: 10px;
        }
        
        #selected-related-people, #selected-progress-people {
            padding: 5px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            min-height: 40px;
        }
        .content-text {
            white-space: pre-wrap; /* 保留空白和換行，並自動換行 */
        }
        .person-tag {
            position: relative;
            cursor: grab;
        }
        
        .person-tag.dragging {
            opacity: 0.5;
        }
        
        .droppable-area {
            min-height: 40px;
            transition: background-color 0.3s;
        }
        
        .droppable-area.drag-over {
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .person-delete-btn {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
        }
        
        .person-delete-btn:hover {
            opacity: 1;
        }

        /* 相關人選項刪除按鈕樣式 */
        .person-delete-icon {
            margin-left: 5px;
            cursor: pointer;
            opacity: 0.9;
            font-size: 1.2rem;
            font-weight: bold;
            color: #dc3545; /* 紅色 */
        }
        
        .person-delete-icon:hover {
            opacity: 1;
        }
        /* 模態框樣式 - 修復疊加模態框問題 */
        .modal {
            z-index: 1050;
        }
        .modal-backdrop {
            z-index: 1040;
        }
        /* 通知模態框應該顯示在最上層 */
        #notification-modal {
            z-index: 1060;
        }
        #notification-modal + .modal-backdrop {
            z-index: 1055;
        }
        .modal-backdrop + .modal-backdrop {
            z-index: 1045; /* 第二個backdrop的z-index */
        }

        /* 類別標籤篩選區域樣式 */
        .category-filter-container {
            position: relative;
            overflow: hidden;
        }

        .category-tags-scroll {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            padding: 5px 0;
            cursor: grab;
        }

        .category-tags-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .category-tags-scroll.active {
            cursor: grabbing;
        }

        .category-tags {
            display: inline-flex;
            flex-wrap: nowrap;
            gap: 10px;
            padding: 0 5px;
        }

        .category-tag {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            user-select: none;
        }

        .category-tag.active {
            background-color: #0d6efd;
            color: white;
        }

        .category-tag:not(.active) {
            background-color: white;
            color: #6c757d;
            border: 1px solid #6c757d;
        }

        .category-tag .count {
            margin-left: 5px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #6c757d;
            color: #ffffff;
            border-radius: 50%;
            min-width: 1.5rem;
            min-height: 1.5rem;
            padding: 0.1rem;
        }

        .category-tag.active .count {
            background-color: rgba(255, 255, 255, 0.3);
            color: #ffffff;
        }

        /* 星號圖標樣式 */
        .favorite-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
            padding: 2px;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .favorite-icon.inactive {
            color: #6c757d;
        }

        .favorite-icon.active {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <!-- 設定頁面 -->
    <div id="settings-page" class="container mt-3">
        <h2 class="mb-3">設定</h2>
        <form id="settings-form" class="mb-4">
            <div class="mb-3">
                <label for="sheets-id" class="form-label">Google Sheets ID</label>
                <input type="text" class="form-control" id="sheets-id" required autocomplete="off">
                <div class="form-text">預設: 1sUFpwV6m5Zr6rdXNHQ2pQ5QZ4XDd1EmmbKyLjIfyVHk</div>
            </div>
            <div class="mb-3">
                <label for="drive-folder-id" class="form-label">Google Drive 資料夾 ID</label>
                <input type="text" class="form-control" id="drive-folder-id" required autocomplete="off">
                <div class="form-text">預設: 1r-pUcaRNAGzwfDhvElBERmEhB6IX2SnD</div>
            </div>
            <button type="submit" class="btn btn-primary">儲存設定</button>
        </form>
    </div>

    <!-- 新增案件頁面 -->
    <div id="add-case-page" class="container mt-3 d-none">
        <h2 class="mb-3">新增案件</h2>
        <form id="add-case-form">
            <div class="mb-3">
                <label for="case-title" class="form-label">案件標題</label>
                <input type="text" class="form-control" id="case-title" required autocomplete="off">
            </div>
            
            <!-- 相關人選擇區域 -->
            <div class="mb-3">
                <label class="form-label">相關人</label>
                <div class="position-relative">
                    <div class="form-control d-flex flex-wrap align-items-center tag-input-container" id="case-tag-container">
                        <div id="case-tags-area" class="d-flex flex-wrap tag-area"></div>
                        <input type="text" class="tag-input border-0 flex-grow-1" id="related-person-input" placeholder="輸入相關人姓名" autocomplete="off">
                    </div>
                    <div class="position-absolute w-100 tag-suggestions" id="related-people-candidates"></div>
                </div>
            </div>
            
            <!-- 類別選擇區域 -->
            <div class="mb-3">
                <label class="form-label">類別</label>
                <div class="position-relative">
                    <div class="form-control d-flex flex-wrap align-items-center tag-input-container" id="case-category-container">
                        <div id="case-categories-area" class="d-flex flex-wrap tag-area"></div>
                        <input type="text" class="tag-input border-0 flex-grow-1" id="category-input" placeholder="輸入類別名稱" autocomplete="off">
                    </div>
                    <div class="position-absolute w-100 tag-suggestions" id="categories-candidates"></div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="case-content" class="form-label">案件內容</label>
                <textarea class="form-control" id="case-content" rows="4" required autocomplete="off"></textarea>
            </div>
            
            <div class="mb-3">
                <label for="case-files" class="form-label">上傳檔案 (圖片或影片)</label>
                <input class="form-control" type="file" id="case-files" multiple accept="image/*,video/*">
                <!-- 新增進度條 -->
                <div class="progress mt-2 d-none" id="case-upload-progress-container" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="case-upload-progress-bar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div id="case-upload-status" class="form-text mt-1"></div> <!-- 狀態文字 -->
                <div id="file-preview-container" class="mt-2"></div>
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-3">新增案件</button>
        </form>
    </div>

    <!-- 案件列表頁面 -->
    <div id="cases-page" class="container mt-3 d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>案件列表</h2>
            <div>
                <span class="sort-icon" id="date-sort">
                    <i class="bi bi-sort-down"></i>
                </span>
                <span class="sort-icon ms-2" id="date-filter-icon">
                    <i class="bi bi-funnel"></i>
                </span>
                <span class="sort-icon ms-2" id="category-order-icon">
                    <i class="bi bi-list-ol"></i>
                </span>
            </div>
        </div>

        <!-- 關鍵字搜尋 -->
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="keyword-search" placeholder="輸入關鍵字..." autocomplete="off">
            <button class="btn btn-outline-secondary" type="button" id="search-button">搜尋</button>
            <button class="btn btn-outline-danger" type="button" id="clear-search-button">清除</button>
        </div>
        
        <!-- 類別標籤篩選區域 -->
        <div class="mb-3 category-filter-container">
            <div class="category-tags-scroll">
                <div class="category-tags" id="category-tags">
                    <!-- 類別標籤將由JavaScript動態生成 -->
                </div>
            </div>
        </div>
        
        <!-- 日期篩選 -->
        <div class="card mb-3 d-none" id="date-filter-container">
            <div class="card-body">
                <h5 class="card-title">日期篩選</h5>
                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="date-filter-type" id="date-range" value="range" checked>
                        <label class="form-check-label" for="date-range">日期範圍</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="date-filter-type" id="date-month" value="month">
                        <label class="form-check-label" for="date-month">月份</label>
                    </div>
                </div>
                <!-- 日期範圍篩選 -->
                <div id="date-range-filter">
                    <div class="row">
                        <div class="col-6">
                            <label for="date-from" class="form-label">從</label>
                            <input type="date" class="form-control" id="date-from">
                        </div>
                        <div class="col-6">
                            <label for="date-to" class="form-label">到</label>
                            <input type="date" class="form-control" id="date-to">
                        </div>
                    </div>
                </div>
                <!-- 月份篩選 -->
                <div id="date-month-filter" class="d-none">
                    <label for="month-select" class="form-label">選擇月份</label>
                    <input type="month" class="form-control" id="month-select">
                </div>
                <button class="btn btn-primary mt-2" id="apply-filter">套用篩選</button>
            </div>
        </div>
        
        <!-- 案件列表 -->
        <div id="cases-container">
            <!-- 案件將由JavaScript生成 -->
        </div>
    </div>

    <!-- 案件詳情頁面 -->
    <div id="case-details-page" class="container mt-3 d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-sm btn-outline-secondary" id="back-to-cases">
                <i class="bi bi-arrow-left"></i> 返回
            </button>
            <button class="btn btn-success btn-sm" id="mark-as-completed">標記為完成</button>
        </div>
        
        <div id="case-info" class="card mb-3">
            <!-- 案件資訊將由JavaScript生成 -->
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>進度記錄</h4>
            <div>
                <button class="btn btn-primary btn-sm" id="add-progress">
                    <i class="bi bi-plus"></i> 新增進度
                </button>
                <span class="sort-icon ms-2" id="progress-sort">
                    <i class="bi bi-sort-down"></i>
                </span>
            </div>
        </div>
        
        <div id="progress-container">
            <!-- 進度記錄將由JavaScript生成 -->
        </div>
    </div>

    <!-- 已完成案件頁面 -->
    <div id="completed-page" class="container mt-3 d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>已完成案件</h2>
            <div>
                <span class="sort-icon" id="completed-sort">
                    <i class="bi bi-sort-down"></i>
                </span>
                <span class="sort-icon ms-2" id="completed-date-filter-icon">
                    <i class="bi bi-funnel"></i>
                </span>
            </div>
        </div>

        <!-- 關鍵字搜尋 (已完成) -->
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="completed-keyword-search" placeholder="輸入關鍵字..." autocomplete="off">
            <button class="btn btn-outline-secondary" type="button" id="completed-search-button">搜尋</button>
            <button class="btn btn-outline-danger" type="button" id="completed-clear-search-button">清除</button>
        </div>
        
        <!-- 已完成案件日期篩選 -->
        <div class="card mb-3 d-none" id="completed-date-filter-container">
            <div class="card-body">
                <h5 class="card-title">日期篩選</h5>
                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="completed-date-filter-type" id="completed-date-range" value="range" checked>
                        <label class="form-check-label" for="completed-date-range">日期範圍</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="completed-date-filter-type" id="completed-date-month" value="month">
                        <label class="form-check-label" for="completed-date-month">月份</label>
                    </div>
                </div>
                <!-- 日期範圍篩選 -->
                <div id="completed-date-range-filter">
                    <div class="row">
                        <div class="col-6">
                            <label for="completed-date-from" class="form-label">從</label>
                            <input type="date" class="form-control" id="completed-date-from">
                        </div>
                        <div class="col-6">
                            <label for="completed-date-to" class="form-label">到</label>
                            <input type="date" class="form-control" id="completed-date-to">
                        </div>
                    </div>
                </div>
                <!-- 月份篩選 -->
                <div id="completed-date-month-filter" class="d-none">
                    <label for="completed-month-select" class="form-label">選擇月份</label>
                    <input type="month" class="form-control" id="completed-month-select">
                </div>
                <button class="btn btn-primary mt-2" id="apply-completed-filter">套用篩選</button>
            </div>
        </div>
        
        <div id="completed-cases-container">
            <!-- 已完成案件將由JavaScript生成 -->
        </div>
    </div>

    <!-- 模態框 -->
    <!-- 新增進度模態框 -->
    <div class="modal fade" id="add-progress-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增進度</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="progress-form">
                        <!-- 將 d-none class 添加到日期輸入的父級 div -->
                        <div class="mb-3 d-none">
                            <label for="progress-date" class="form-label">日期</label>
                            <input type="datetime-local" class="form-control" id="progress-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="progress-content" class="form-label">進度內容</label>
                            <textarea class="form-control" id="progress-content" rows="4" required autocomplete="off"></textarea>
                        </div>
                        
                        <!-- 相關人選擇區域 -->
                        <div class="mb-3">
                            <label class="form-label">相關人</label>
                            <div class="position-relative">
                                <div class="form-control d-flex flex-wrap align-items-center tag-input-container" id="progress-tag-container">
                                    <div id="progress-tags-area" class="d-flex flex-wrap tag-area"></div>
                                    <input type="text" class="tag-input border-0 flex-grow-1" id="progress-person-input" placeholder="輸入相關人姓名" autocomplete="off">
                                </div>
                                <div class="position-absolute w-100 tag-suggestions" id="progress-people-candidates"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="progress-files" class="form-label">上傳檔案 (圖片或影片)</label>
                            <input class="form-control" type="file" id="progress-files" multiple accept="image/*,video/*">
                            <!-- 新增進度條 -->
                            <div class="progress mt-2 d-none" id="progress-upload-progress-container" style="height: 25px;">
                                 <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progress-upload-progress-bar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <div id="progress-upload-status" class="form-text mt-1"></div> <!-- 狀態文字 -->
                            <div id="progress-file-preview" class="mt-2"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-progress">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 檔案預覽模態框 -->
    <div class="modal fade" id="file-preview-modal" tabindex="-1" aria-labelledby="file-preview-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="file-preview-modal-label">檔案預覽</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center" id="file-preview-modal-content">
                    <!-- 預覽內容會由JavaScript動態生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新增相關人模態框 -->
    <div class="modal fade" id="add-person-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增相關人</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-person-form">
                        <div class="mb-3">
                            <label for="person-name" class="form-label">相關人姓名</label>
                            <input type="text" class="form-control" id="person-name" required autocomplete="off">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-person">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部導航欄 -->
    <nav class="nav nav-pills fixed-bottom nav-justified">
        <a class="nav-link" href="#" id="nav-add-case">
            <i class="bi bi-plus-square"></i>
            <span>新增案件</span>
        </a>
        <a class="nav-link active" href="#" id="nav-cases">
            <i class="bi bi-briefcase"></i>
            <span>案件</span>
        </a>
        <a class="nav-link" href="#" id="nav-completed">
            <i class="bi bi-check-square"></i>
            <span>案件(完成)</span>
        </a>
        <a class="nav-link" href="#" id="nav-settings">
            <i class="bi bi-gear"></i>
            <span>設定</span>
        </a>
    </nav>

    <!-- 通用模態通知框 -->
    <div class="modal fade" id="notification-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notification-title">通知</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notification-message">
                    <!-- 通知內容 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 程式碼 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局變數
        let currentCaseId = null;
        let cases = [];
        let completedCases = [];
        let people = []; // 恢復 people 全局變數
        let categories = []; // 新增類別全局變數
        let dateSort = 'desc';
        let progressSort = 'desc';
        let completedSort = 'desc';
        let completedProgressSort = 'desc'; // 新增：已完成案件詳情內的進度排序
        let currentCategoryId = null; // 新增：當前選定的類別ID
        
        // 新增變數: 存儲所有原始案件資料，用於前端篩選
        let allCases = [];
        let allCompletedCases = [];
        
        // Google Apps Script 設定
        const DEFAULT_SHEET_ID = '1sUFpwV6m5Zr6rdXNHQ2pQ5QZ4XDd1EmmbKyLjIfyVHk';
        const DEFAULT_DRIVE_FOLDER_ID = '1r-pUcaRNAGzwfDhvElBERmEhB6IX2SnD';
        let sheetsId = localStorage.getItem('sheetsId') || DEFAULT_SHEET_ID;
        let driveFolderId = localStorage.getItem('driveFolderId') || DEFAULT_DRIVE_FOLDER_ID;
        
        // 通知模態框
        let notificationModal = null;
        
        // DOM 元素
        const pages = {
            settings: document.getElementById('settings-page'),
            addCase: document.getElementById('add-case-page'),
            cases: document.getElementById('cases-page'),
            caseDetails: document.getElementById('case-details-page'),
            completed: document.getElementById('completed-page')
        };
        
        const navLinks = {
            addCase: document.getElementById('nav-add-case'),
            cases: document.getElementById('nav-cases'),
            completed: document.getElementById('nav-completed'),
            settings: document.getElementById('nav-settings')
        };

        // 獲取對比顏色（確保文字在背景上可見）
        function getContrastColor(hexColor) {
            // 如果沒有提供顏色，返回黑色
            if (!hexColor) return '#000000';
            
            // 移除 # 號
            hexColor = hexColor.replace('#', '');
            
            // 如果提供的是縮寫形式 (例如：#ABC)，轉換為完整形式 (例如：#AABBCC)
            if (hexColor.length === 3) {
                hexColor = hexColor[0] + hexColor[0] + hexColor[1] + hexColor[1] + hexColor[2] + hexColor[2];
            }
            
            // 解析 RGB 值
            const r = parseInt(hexColor.substr(0, 2), 16);
            const g = parseInt(hexColor.substr(2, 2), 16);
            const b = parseInt(hexColor.substr(4, 2), 16);
            
            // 計算亮度
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            // 根據亮度返回黑色或白色
            return brightness > 128 ? '#000000' : '#FFFFFF';
        }
        
        // 初始化應用程式
        document.addEventListener('DOMContentLoaded', function() {
            console.log('===== 應用程序初始化開始 =====');
            
            // 添加類別標籤排序診斷函數
            window.checkCategoryOrdering = function() {
                console.log('===== 類別排序診斷開始 =====');
                console.log('目前類別總數:', categories.length);
                
                // 檢查類別數據是否包含order屬性
                const hasOrderProperty = categories.some(c => c.order !== undefined);
                console.log('類別數據包含order屬性:', hasOrderProperty);
                
                // 輸出所有類別的order值
                console.log('所有類別的order值:');
                categories.forEach((cat, index) => {
                    console.log(`${index + 1}. ${cat.name} (ID: ${cat.id}) - order: ${cat.order}, type: ${typeof cat.order}`);
                });
                
                // 檢查是否按order排序 
                let isOrderSorted = true;
                for (let i = 1; i < categories.length; i++) {
                    const prevOrder = typeof categories[i-1].order === 'number' ? 
                        categories[i-1].order : parseInt(categories[i-1].order) || 9999;
                    const currOrder = typeof categories[i].order === 'number' ? 
                        categories[i].order : parseInt(categories[i].order) || 9999;
                        
                    if (prevOrder > currOrder) {
                        isOrderSorted = false;
                        console.log(`排序異常: 位置 ${i-1} (${categories[i-1].name}, order=${prevOrder}) > 位置 ${i} (${categories[i].name}, order=${currOrder})`);
                    }
                }
                console.log('類別數據是否按order排序:', isOrderSorted);
                
                // 檢查模態框中的順序
                const modalItems = document.querySelectorAll('#sortable-categories .list-group-item');
                console.log('模態框中類別數:', modalItems.length);
                
                if (modalItems.length > 0) {
                    console.log('模態框中的類別順序:');
                    Array.from(modalItems).forEach((item, index) => {
                        const categoryId = item.dataset.id;
                        const category = categories.find(c => c.id === categoryId);
                        console.log(`${index + 1}. ${category ? category.name : 'unknown'} (ID: ${categoryId}), order: ${category ? category.order : 'N/A'}`);
                    });
                }
                
                // 檢查標籤區域中的順序
                const tagItems = document.querySelectorAll('#category-tags .category-tag[data-category-id]');
                console.log('標籤區域中類別數:', tagItems.length);
                
                if (tagItems.length > 0) {
                    console.log('標籤區域中的類別順序:');
                    Array.from(tagItems).forEach((item, index) => {
                        const categoryId = item.dataset.categoryId;
                        const category = categories.find(c => c.id === categoryId);
                        console.log(`${index + 1}. ${category ? category.name : 'unknown'} (ID: ${categoryId}), order: ${category ? category.order : 'N/A'}`);
                    });
                }
                
                console.log('===== 類別排序診斷結束 =====');
                return '診斷完成，請檢查控制台輸出';
            };
            
            console.log('添加了類別排序診斷函數，可以在控制台執行 checkCategoryOrdering() 進行診斷');
            
            // 初始化模態框
            notificationModal = new bootstrap.Modal(document.getElementById('notification-modal'));
            
            // 初始化設定頁面
            document.getElementById('sheets-id').value = sheetsId;
            document.getElementById('drive-folder-id').value = driveFolderId;
            
            // 檢查是否已完成設定
            if (!localStorage.getItem('sheetsId') || !localStorage.getItem('driveFolderId')) {
                showPage('settings');
            } else {
                // 載入案件資料
                loadData();
                showPage('cases');
            }
            
            // 設定日期篩選類型切換
            document.querySelectorAll('input[name="date-filter-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'range') {
                        document.getElementById('date-range-filter').classList.remove('d-none');
                        document.getElementById('date-month-filter').classList.add('d-none');
                    } else {
                        document.getElementById('date-range-filter').classList.add('d-none');
                        document.getElementById('date-month-filter').classList.remove('d-none');
                    }
                });
            });
            
            // 設定已完成案件日期篩選類型切換
            document.querySelectorAll('input[name="completed-date-filter-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'range') {
                        document.getElementById('completed-date-range-filter').classList.remove('d-none');
                        document.getElementById('completed-date-month-filter').classList.add('d-none');
                    } else {
                        document.getElementById('completed-date-range-filter').classList.add('d-none');
                        document.getElementById('completed-date-month-filter').classList.remove('d-none');
                    }
                });
            });
            
            // 初始設定隱藏所有日期篩選區域
            document.getElementById('date-filter-container').classList.add('d-none');
            document.getElementById('completed-date-filter-container').classList.add('d-none');
            
            // 初始化標籤輸入功能
            initTagInputs();
            
            // 設定事件監聽器
            setupEventListeners();
            
            // 初始化類別標籤區域的拖曳滑動功能
            enableDragScroll();
        });
        
        // 啟用拖曳滑動功能
        function enableDragScroll() {
            const container = document.querySelector('.category-tags-scroll');
            if (!container) return;
            
            let isDown = false;
            let startX;
            let scrollLeft;
            
            // 滑鼠事件
            container.addEventListener('mousedown', (e) => {
                // 如果點擊的是拖曳把手，則不啟用滑動功能
                if (e.target.classList.contains('drag-handle')) {
                    return;
                }
                
                isDown = true;
                container.classList.add('active');
                // startX = e.pageX - container.offsetLeft; // 舊的
                startX = e.clientX - container.getBoundingClientRect().left; // 新的
                scrollLeft = container.scrollLeft;
                container.style.cursor = 'grabbing';
            });
            
            container.addEventListener('mouseleave', () => {
                isDown = false;
                container.classList.remove('active');
                container.style.cursor = 'grab';
            });
            
            container.addEventListener('mouseup', () => {
                isDown = false;
                container.classList.remove('active');
                container.style.cursor = 'grab';
            });
            
            container.addEventListener('mousemove', (e) => {
                if(!isDown) return;
                e.preventDefault();
                // const x = e.pageX - container.offsetLeft; // 舊的
                const x = e.clientX - container.getBoundingClientRect().left; // 新的
                const walk = (x - startX) * 1.5; // 滾動速度
                container.scrollLeft = scrollLeft - walk;
            });
            
            // 觸控事件（支持移動設備）
            container.addEventListener('touchstart', (e) => {
                // 如果點擊的是拖曳把手，則不啟用滑動功能
                if (e.target.classList.contains('drag-handle')) {
                    return;
                }
                
                isDown = true;
                container.classList.add('active');
                // startX = e.touches[0].pageX - container.offsetLeft; // 舊的
                startX = e.touches[0].clientX - container.getBoundingClientRect().left; // 新的
                scrollLeft = container.scrollLeft;
            });
            
            container.addEventListener('touchend', () => {
                isDown = false;
                container.classList.remove('active');
            });
            
            container.addEventListener('touchcancel', () => {
                isDown = false;
                container.classList.remove('active');
            });
            
            container.addEventListener('touchmove', (e) => {
                if(!isDown) return;
                e.preventDefault();
                // const x = e.touches[0].pageX - container.offsetLeft; // 舊的
                const x = e.touches[0].clientX - container.getBoundingClientRect().left; // 新的
                const walk = (x - startX) * 1.5;
                container.scrollLeft = scrollLeft - walk;
            });
        }
        
        // 設定事件監聽器
        function setupEventListeners() {
            console.log('設定事件監聽器...');
            
            // 導航事件
            if (navLinks.addCase) navLinks.addCase.addEventListener('click', () => showPage('addCase'));
            if (navLinks.cases) navLinks.cases.addEventListener('click', () => showPage('cases'));
            if (navLinks.completed) navLinks.completed.addEventListener('click', () => showPage('completed'));
            if (navLinks.settings) navLinks.settings.addEventListener('click', () => showPage('settings'));
            
            // 設定相關
            const settingsForm = document.getElementById('settings-form');
            if (settingsForm) settingsForm.addEventListener('submit', saveSettings);
            
            // 案件表單相關
            const addCaseForm = document.getElementById('add-case-form');
            if (addCaseForm) {
                addCaseForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    // 移除所有具體處理邏輯，避免重複處理
                });
            }
            
            // 相關人搜尋和選擇相關
            const relatedPersonInput = document.getElementById('related-person-input');
            if (relatedPersonInput) {
                relatedPersonInput.addEventListener('input', function() {
                    searchRelatedPeople(this.value);
                });
            }
            
            const addRelationBtn = document.getElementById('add-relation-btn');
            if (addRelationBtn) {
                addRelationBtn.addEventListener('click', function() {
                    openAddPersonModal('case');
                });
            }
            
            const progressPersonInput = document.getElementById('progress-person-input');
            if (progressPersonInput) {
                progressPersonInput.addEventListener('input', function() {
                    searchProgressPeople(this.value);
                });
            }
            
            const addProgressRelationBtn = document.getElementById('add-progress-relation-btn');
            if (addProgressRelationBtn) {
                addProgressRelationBtn.addEventListener('click', function() {
                    openAddPersonModal('progress');
                });
            }
            
            const savePersonBtn = document.getElementById('save-person');
            if (savePersonBtn) savePersonBtn.addEventListener('click', savePerson);
            
            const caseFiles = document.getElementById('case-files');
            if (caseFiles) caseFiles.addEventListener('change', previewFiles);
            
            // 案件列表相關
            const backToCasesBtn = document.getElementById('back-to-cases');
            if (backToCasesBtn) backToCasesBtn.addEventListener('click', () => showPage('cases'));
            
            const markAsCompletedBtn = document.getElementById('mark-as-completed');
            if (markAsCompletedBtn) markAsCompletedBtn.addEventListener('click', markCaseAsCompleted);
            
            const dateSortBtn = document.getElementById('date-sort');
            if (dateSortBtn) dateSortBtn.addEventListener('click', toggleCasesSort);
            
            const dateFilterIconBtn = document.getElementById('date-filter-icon');
            if (dateFilterIconBtn) dateFilterIconBtn.addEventListener('click', toggleDateFilter);
            
            const applyFilterBtn = document.getElementById('apply-filter');
            if (applyFilterBtn) applyFilterBtn.addEventListener('click', applyDateFilter);
            
            const completedSortBtn = document.getElementById('completed-sort');
            if (completedSortBtn) completedSortBtn.addEventListener('click', toggleCompletedSort);
            
            const completedDateFilterIconBtn = document.getElementById('completed-date-filter-icon');
            if (completedDateFilterIconBtn) completedDateFilterIconBtn.addEventListener('click', toggleCompletedDateFilter);
            
            const applyCompletedFilterBtn = document.getElementById('apply-completed-filter');
            if (applyCompletedFilterBtn) applyCompletedFilterBtn.addEventListener('click', applyCompletedDateFilter);
            
            const searchBtn = document.getElementById('search-button');
            if (searchBtn) searchBtn.addEventListener('click', () => performSearch(false));
            
            const clearSearchBtn = document.getElementById('clear-search-button');
            if (clearSearchBtn) clearSearchBtn.addEventListener('click', () => clearSearch(false));
            
            const completedSearchBtn = document.getElementById('completed-search-button');
            if (completedSearchBtn) completedSearchBtn.addEventListener('click', () => performSearch(true));
            
            const completedClearSearchBtn = document.getElementById('completed-clear-search-button');
            if (completedClearSearchBtn) completedClearSearchBtn.addEventListener('click', () => clearSearch(true));
            
            // 進度相關
            const addProgressBtn = document.getElementById('add-progress');
            if (addProgressBtn) addProgressBtn.addEventListener('click', openAddProgressModal);
            
            const progressSortBtn = document.getElementById('progress-sort');
            if (progressSortBtn) progressSortBtn.addEventListener('click', toggleProgressSort);
            
            const progressFiles = document.getElementById('progress-files');
            if (progressFiles) progressFiles.addEventListener('change', previewProgressFiles);
            
            const saveProgressBtn = document.getElementById('save-progress');
            if (saveProgressBtn) saveProgressBtn.addEventListener('click', saveProgress);
            
            console.log('事件監聽器設定完成');
        }

        // 執行關鍵字搜尋
        function performSearch(isCompleted) {
            const keyword = isCompleted 
                ? document.getElementById('completed-keyword-search').value.trim()
                : document.getElementById('keyword-search').value.trim();
            loadData(null, keyword); // 傳遞關鍵字給 loadData
        }

        // 清除關鍵字搜尋
        function clearSearch(isCompleted) {
            if (isCompleted) {
                document.getElementById('completed-keyword-search').value = '';
            } else {
                document.getElementById('keyword-search').value = '';
                // 同時清除類別過濾
                if (currentCategoryId !== null) {
                    currentCategoryId = null;
                    updateCategoryTagsSelection();
                }
            }
            loadData(); // 不帶關鍵字重新載入
        }
        
        // 顯示頁面
        function showPage(pageId) {
            // 隱藏所有頁面
            Object.values(pages).forEach(page => page.classList.add('d-none'));
            
            // 移除所有導航項的活動狀態
            Object.values(navLinks).forEach(link => link.classList.remove('active'));
            
            // 顯示選定的頁面並設定相應的導航項為活動狀態
            pages[pageId].classList.remove('d-none');
            if (pageId !== 'caseDetails') {
                navLinks[pageId].classList.add('active');
            } else {
                navLinks.cases.classList.add('active');
            }
            
            // 清除相關人選擇區域，避免切換頁面時保留上次選擇
            const caseTagsArea = document.getElementById('case-tags-area');
            const progressTagsArea = document.getElementById('progress-tags-area');
            const relatedPersonInput = document.getElementById('related-person-input');
            const progressPersonInput = document.getElementById('progress-person-input');
            const relatedPeopleCandidates = document.getElementById('related-people-candidates');
            const progressPeopleCandidates = document.getElementById('progress-people-candidates');
            
            // 清空案件相關人區域
            if (caseTagsArea) caseTagsArea.innerHTML = '';
            if (relatedPersonInput) relatedPersonInput.value = '';
            if (relatedPeopleCandidates) relatedPeopleCandidates.innerHTML = '';
            
            // 清空進度相關人區域
            if (progressTagsArea) progressTagsArea.innerHTML = '';
            if (progressPersonInput) progressPersonInput.value = '';
            if (progressPeopleCandidates) progressPeopleCandidates.innerHTML = '';
            
            // 特殊頁面處理
            if (pageId === 'addCase') {
                resetCaseForm();
            } else if (pageId === 'cases') {
                // 當切換到案件列表頁時，渲染類別標籤和案件列表
                renderCategoryTags();
                renderCasesList();
            } else if (pageId === 'completed') {
                // 當切換到已完成案件頁時，重置類別篩選並渲染已完成案件
                currentCategoryId = null; // 重置類別篩選
                renderCompletedCases();
            }
        }
        
        // 保存設定
        function saveSettings(e) {
            e.preventDefault();
            const newSheetsId = document.getElementById('sheets-id').value.trim();
            const newDriveFolderId = document.getElementById('drive-folder-id').value.trim();
            
            if (!newSheetsId || !newDriveFolderId) {
                showNotification('請填寫所有必填欄位', '錯誤');
                return;
            }
            
            // 測試能否訪問指定的 Google Sheets
            showLoading('正在測試設定...');
            
            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading();
                    
                    if (response && response.success) {
                        // 保存設定到本地存儲
                        localStorage.setItem('sheetsId', newSheetsId);
                        localStorage.setItem('driveFolderId', newDriveFolderId);
                        
                        sheetsId = newSheetsId;
                        driveFolderId = newDriveFolderId;
                        
                        // 顯示工作表標題修復信息
                        if (response.fixedSheets && response.fixedSheets.length > 0) {
                            const fixedSheetsMsg = response.fixedSheets.map(
                                sheet => `${sheet.name}: ${sheet.action}`
                            ).join('\n');
                            
                            console.log('修復了以下工作表的標題行:', fixedSheetsMsg);
                            showNotification(`設定已儲存！已自動修復 ${response.fixedSheets.length} 個工作表的標題行。`);
                        } else {
                            showNotification('設定已儲存！');
                        }
                        
                        // 載入資料
                        loadData();
                        
                        // 跳轉到案件頁面
                        showPage('cases');
                    } else {
                        showNotification('設定測試失敗：' + (response && response.error ? response.error : '未知錯誤') + '\n請確認 ID 是否正確，以及您是否有權限訪問該資源。', '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .initializeSheets(newSheetsId);
        }

        // 載入資料
        function loadData(callback, keyword = '') { // 添加 keyword 參數，預設為空字串
            showLoading('載入案件資料中...');
            console.log(`開始載入資料，關鍵字: '${keyword}'`); // 記錄關鍵字

            google.script.run
                .withSuccessHandler(function(stringResponse) {
                    console.log('從後端收到資料回應');
                    
                    let response = null;
                    try {
                        if (stringResponse) {
                            response = JSON.parse(stringResponse);
                            console.log('成功解析後端資料');
                            // 檢查數據完整性
                            if (response && response.cases) {
                                console.log(`收到進行中案件: ${response.cases.length} 個`);
                            } 
                            if (response && response.completedCases) {
                                console.log(`收到已完成案件: ${response.completedCases.length} 個`);
                            }
                            if (response && response.people) {
                                console.log(`收到相關人: ${response.people.length} 個`);
                                console.log(`相關人詳情:`, JSON.stringify(response.people, null, 2));
                            } else {
                                console.warn('後端回應中沒有相關人資料');
                            }
                        } else {
                            console.error('後端返回空回應');
                            showNotification('伺服器未返回任何資料', '錯誤');
                            hideLoading();
                            return;
                        }
                    } catch (parseError) {
                        console.error('解析後端回應時發生錯誤:', parseError);
                        showNotification('解析伺服器回應時發生錯誤', '錯誤');
                        hideLoading();
                        return;
                    }
                    
                    if (response && response.success) {
                        // 讀取localStorage中的已完成案件ID清單
                        let completedCaseIds = JSON.parse(localStorage.getItem('completedCaseIds') || '[]');
                        console.log('從localStorage讀取的已完成案件ID:', completedCaseIds);
                        
                        // 更新本地資料
                        const rawCases = response.cases || [];
                        const rawCompletedCases = response.completedCases || [];
                        
                        // 更新相關人資料
                        people = response.people || [];
                        console.log(`已載入 ${people.length} 個相關人資料`);
                        console.log(`相關人資料在people變數中:`, people);
                        
                        // 更新類別資料
                        categories = response.categories || [];
                        console.log(`已載入 ${categories.length} 個類別資料`);
                        console.log(`類別資料在categories變數中:`, categories);
                        
                        // [新增] 輸出案件原始資料進行檢查
                        if (rawCases.length > 0) {
                            console.log(`第一個案件原始數據: `, JSON.stringify(rawCases[0]));
                        }
                        
                        // [新增] 檢查案件中的類別數據，如果沒有則嘗試從H欄獲取
                        rawCases.forEach(caseItem => {
                            console.log(`處理案件 ID ${caseItem.id} 的類別資料`);
                            
                            // 如果沒有類別欄位但有H欄資料，嘗試解析
                            if (!caseItem.categories && caseItem.categories !== null) {
                                if (typeof caseItem.categories === 'undefined') {
                                    console.warn(`案件 ${caseItem.id} 沒有 categories 屬性`);
                                    caseItem.categories = [];
                                }
                            }
                            
                            // 如果類別是字串，嘗試解析
                            if (typeof caseItem.categories === 'string' && caseItem.categories.trim() !== '') {
                                try {
                                    caseItem.categories = JSON.parse(caseItem.categories);
                                    console.log(`案件 ${caseItem.id} 類別欄位成功解析為:`, caseItem.categories);
                                } catch (e) {
                                    console.error(`案件 ${caseItem.id} 類別欄位解析失敗:`, e);
                                    caseItem.categories = [];
                                }
                            }
                            
                            // 確保類別是數組
                            if (!Array.isArray(caseItem.categories)) {
                                console.warn(`案件 ${caseItem.id} 類別不是數組，將其轉換為數組`);
                                if (caseItem.categories) {
                                    // 如果有值但不是數組，封裝成數組
                                    caseItem.categories = [caseItem.categories];
                                } else {
                                    // 如果沒有值，設為空數組
                                    caseItem.categories = [];
                                }
                            }
                            
                            console.log(`案件 ${caseItem.id} 最終類別資料:`, caseItem.categories);
                        });
                        
                        // [新增] 同樣處理已完成案件
                        rawCompletedCases.forEach(caseItem => {
                            console.log(`處理已完成案件 ID ${caseItem.id} 的類別資料`);
                            
                            // 如果沒有類別欄位但有H欄資料，嘗試解析
                            if (!caseItem.categories && caseItem.categories !== null) {
                                if (typeof caseItem.categories === 'undefined') {
                                    console.warn(`已完成案件 ${caseItem.id} 沒有 categories 屬性`);
                                    caseItem.categories = [];
                                }
                            }
                            
                            // 如果類別是字串，嘗試解析
                            if (typeof caseItem.categories === 'string' && caseItem.categories.trim() !== '') {
                                try {
                                    caseItem.categories = JSON.parse(caseItem.categories);
                                    console.log(`已完成案件 ${caseItem.id} 類別欄位成功解析為:`, caseItem.categories);
                                } catch (e) {
                                    console.error(`已完成案件 ${caseItem.id} 類別欄位解析失敗:`, e);
                                    caseItem.categories = [];
                                }
                            }
                            
                            // 確保類別是數組
                            if (!Array.isArray(caseItem.categories)) {
                                console.warn(`已完成案件 ${caseItem.id} 類別不是數組，將其轉換為數組`);
                                if (caseItem.categories) {
                                    // 如果有值但不是數組，封裝成數組
                                    caseItem.categories = [caseItem.categories];
                                } else {
                                    // 如果沒有值，設為空數組
                                    caseItem.categories = [];
                                }
                            }
                            
                            console.log(`已完成案件 ${caseItem.id} 最終類別資料:`, caseItem.categories);
                        });
                        
                        // === 更詳細的調試案件刪除狀態 ===
                        console.log("====== 檢查字符串'TRUE'是否正確匹配 ======");
                        if (rawCases && rawCases.length > 0) {
                            // 找出那些isDeleted是TRUE但可能沒有被過濾的案件
                            rawCases.forEach((c, index) => {
                                // 優先檢查字符串'TRUE'
                                if (c.isDeleted === 'TRUE' || String(c.isDeleted).toUpperCase() === 'TRUE') {
                                    console.log(`特別注意: 這個案件有字符串'TRUE'值: ID=${c.id}, 標題=${c.title}, isDeleted值:`, 
                                                c.isDeleted, 
                                                `類型: ${typeof c.isDeleted}`, 
                                                `String值檢查: ${String(c.isDeleted)}`,
                                                `toUpperCase: ${String(c.isDeleted).toUpperCase()}`,
                                                `toLowerCase: ${String(c.isDeleted).toLowerCase()}`);
                                }
                            });
                        }
                        // === 詳細調試結束 ===
                        
                        // === 調試案件刪除狀態開始 ===
                        console.log("====== 調試案件刪除過濾 ======");
                        // 檢查刪除狀態
                        if (rawCases && rawCases.length > 0) {
                            // 輸出前5個案件的刪除狀態和類型
                            console.log("檢查原始案件的刪除狀態 (前5個):");
                            rawCases.slice(0, 5).forEach((c, index) => {
                                console.log(`案件 ${index+1} - ID: ${c.id}, 標題: ${c.title}, isDeleted: ${c.isDeleted}, 類型: ${typeof c.isDeleted}`);
                            });
                            
                            // 檢查所有被標記為刪除的案件
                            const deletedCases = rawCases.filter(c => c.isDeleted === 'true' || c.isDeleted === 'TRUE' || c.isDeleted === true);
                            console.log(`標記為已刪除的案件數量: ${deletedCases.length}`);
                            if (deletedCases.length > 0) {
                                console.log("已刪除案件詳情:");
                                deletedCases.forEach(c => console.log(`ID: ${c.id}, 標題: ${c.title}, isDeleted: ${c.isDeleted}, 類型: ${typeof c.isDeleted}`));
                            }
                        }
                        // === 調試案件刪除狀態結束 ===
                        
                        // 處理進行中案件 - 排除已完成的案件和localStorage中標記為已完成的案件和已刪除的案件
                        let filteredCases = rawCases.filter(c => {
                            // 排除已標記為完成的案件
                            if (c.completed === true) return false;
                            // 排除在localStorage中標記為已完成的案件
                            if (completedCaseIds.includes(c.id)) return false;
                            
                            // 排除被標記為已刪除的案件 - 使用更簡單直接的檢查方法
                            // 如果isDeleted是undefined或null，視為未刪除
                            if (c.isDeleted === undefined || c.isDeleted === null) {
                                return true;
                            }
                            
                            const isDeletedStr = String(c.isDeleted).toUpperCase();
                            if (isDeletedStr === 'TRUE' || c.isDeleted === true) {
                                console.log(`過濾掉已刪除案件: ID=${c.id}, 標題=${c.title}, isDeleted=${c.isDeleted}, 轉換後=${isDeletedStr}`);
                                return false;
                            }
                            return true;
                        });
                        
                        // 處理已完成案件 - 合併從後端獲取的已完成案件和localStorage中標記為已完成的案件
                        let filteredCompletedCases = [...rawCompletedCases];
                        
                        // 排除被標記為已刪除的已完成案件
                        filteredCompletedCases = filteredCompletedCases.filter(c => {
                            // 如果isDeleted是undefined或null，視為未刪除
                            if (c.isDeleted === undefined || c.isDeleted === null) {
                                return true;
                            }
                            
                            const isDeletedStr = String(c.isDeleted).toUpperCase();
                            if (isDeletedStr === 'TRUE' || c.isDeleted === true) {
                                console.log(`過濾掉已刪除的已完成案件: ID=${c.id}, 標題=${c.title}, isDeleted=${c.isDeleted}, 轉換後=${isDeletedStr}`);
                                return false;
                            }
                            return true;
                        });
                        
                        // 將localStorage中標記為已完成但還未在後端更新的案件添加到已完成案件列表
                        completedCaseIds.forEach(caseId => {
                            const caseToComplete = rawCases.find(c => c.id === caseId && c.completed !== true);
                            if (caseToComplete) {
                                // 檢查此案件是否已被刪除
                                const isDeleted = caseToComplete.isDeleted === true || 
                                                  caseToComplete.isDeleted === 'true' || 
                                                  String(caseToComplete.isDeleted).toUpperCase() === 'TRUE';
                                
                                // 只有未被刪除的案件才添加到已完成列表
                                if (!isDeleted && !filteredCompletedCases.some(c => c.id === caseId)) {
                                    const completedCase = {...caseToComplete, completed: true};
                                    filteredCompletedCases.push(completedCase);
                                    console.log(`從localStorage標記案件 ${caseId} (${completedCase.title}) 為已完成`);
                                } else if (isDeleted) {
                                    console.log(`跳過已刪除的案件 ${caseId} (${caseToComplete.title})`);
                                }
                            }
                        });
                        
                        // 保存所有案件資料到全局變數，用於前端篩選
                        allCases = filteredCases;
                        allCompletedCases = filteredCompletedCases;
                        
                        console.log(`已載入並保存 ${allCases.length} 個進行中案件和 ${allCompletedCases.length} 個已完成案件的全局列表`);
                        
                        // 檢查每個案件的收藏狀態（調試用）
                        console.log("========= 進行中案件收藏狀態檢查 =========");
                        allCases.forEach(caseItem => {
                            console.log(`案件ID: ${caseItem.id}, 標題: ${caseItem.title}, isFavorite: ${caseItem.isFavorite}, 類型: ${typeof caseItem.isFavorite}`);
                        });
                        console.log("========= 已完成案件收藏狀態檢查 =========");
                        allCompletedCases.forEach(caseItem => {
                            console.log(`案件ID: ${caseItem.id}, 標題: ${caseItem.title}, isFavorite: ${caseItem.isFavorite}, 類型: ${typeof caseItem.isFavorite}`);
                        });
                        
                        // 更新收藏案件列表
                        favoriteCaseIds = [];
                        // 從進行中案件中獲取收藏狀態
                        allCases.forEach(caseItem => {
                            if (caseItem.isFavorite === true) {
                                favoriteCaseIds.push(caseItem.id);
                            }
                        });
                        // 從已完成案件中獲取收藏狀態
                        allCompletedCases.forEach(caseItem => {
                            if (caseItem.isFavorite === true) {
                                favoriteCaseIds.push(caseItem.id);
                            }
                        });
                        console.log(`已載入 ${favoriteCaseIds.length} 個收藏案件ID: ${favoriteCaseIds.join(', ')}`);
                        
                        // [新增] 手動關聯案件與類別
                        associateCasesWithCategories();
                        
                        // 如果有關鍵字或類別篩選，則應用篩選
                        if (keyword) {
                            console.log(`使用關鍵字 "${keyword}" 從後端篩選資料`);
                            // 關鍵字查詢已由後端完成篩選，直接使用結果
                            cases = filteredCases;
                            completedCases = filteredCompletedCases;
                        } else if (currentCategoryId) {
                            console.log(`使用類別 ID "${currentCategoryId}" 在前端篩選資料`);
                            // 使用本地篩選函數
                            filterCasesByCategory(currentCategoryId);
                        } else {
                            // 無篩選，使用全部資料
                            cases = filteredCases;
                            completedCases = filteredCompletedCases;
                        }
                        
                        console.log(`當前顯示 ${cases.length} 個進行中案件和 ${completedCases.length} 個已完成案件`);
                        
                        // 渲染類別標籤（無論當前在哪一頁）
                        renderCategoryTags();
                        
                        // 根據當前頁面渲染適當的列表
                        const currentPage = getCurrentPage();
                        console.log(`當前頁面: ${currentPage}`);
                        
                        if (currentPage === 'cases') {
                            renderCasesList();
                        } else if (currentPage === 'completed') {
                            renderCompletedCases();
                        } else if (currentPage === 'case-details' && currentCaseId) {
                            // 檢查當前查看的案件是否已被標記為完成
                            if (completedCaseIds.includes(currentCaseId)) {
                                // 如果是，返回到已完成案件頁面
                                showNotification('此案件已標記為完成，正在跳轉到已完成案件頁面');
                                showPage('completed');
                            } else {
                                renderCaseDetails(currentCaseId);
                            }
                        } else if (currentPage === 'settings') {
                            console.log('準備渲染相關人列表 (當前在設定頁面)');
                            // 渲染相關人列表
                            renderPeopleList();
                        } else {
                            console.log(`未處理頁面的渲染: ${currentPage}`);
                        }
                        
                        // 隱藏載入指示器
                        hideLoading();
                        
                        // 所有資料處理完成後執行回呼函數
                        if (typeof callback === 'function') {
                            console.log('執行資料載入完成後的回呼函數');
                            callback();
                        }
                    } else {
                        console.error('後端回應錯誤:', response ? response.error : '未知錯誤');
                        showNotification('載入資料失敗: ' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                        hideLoading();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('與伺服器通訊失敗:', error);
                    showNotification('與伺服器通訊失敗: ' + error, '錯誤');
                    hideLoading();
                })
                .getAllCases(sheetsId, keyword); // 將 keyword 傳遞給後端
        }

        // 使用前端本地篩選取代後端篩選函數
        function filterCasesByCategory(categoryId) {
            console.log(`開始在前端篩選類別 ID: ${categoryId} 的案件`);
            
            if (!categoryId) {
                // 取消篩選，顯示所有案件
                console.log('未指定類別ID，顯示所有案件');
                cases = [...allCases];
                completedCases = [...allCompletedCases];
                currentCategoryId = null;
            } else {
                // 根據類別ID篩選案件
                console.log(`以類別 "${categoryId}" 篩選案件`);
                
                // 調試：檢查一個範例案件的類別格式
                if (allCases.length > 0) {
                    const sampleCase = allCases[0];
                    console.log('案件類別資料範例:', {
                        id: sampleCase.id,
                        title: sampleCase.title,
                        categories: sampleCase.categories,
                        categoriesType: typeof sampleCase.categories
                    });
                }
                
                // 篩選進行中案件
                cases = allCases.filter(caseItem => {
                    // 檢查類別欄位是否存在
                    if (!caseItem.categories) {
                        return false;
                    }
                    
                    // 處理字串格式 (JSON字串)
                    if (typeof caseItem.categories === 'string') {
                        try {
                            const categoriesArray = JSON.parse(caseItem.categories);
                            if (Array.isArray(categoriesArray)) {
                                return categoriesArray.includes(categoryId);
                            }
                        } catch (e) {
                            console.warn('解析案件類別JSON時出錯:', caseItem.id, e);
                        }
                        return false;
                    }
                    
                    // 處理陣列格式
                    if (Array.isArray(caseItem.categories)) {
                        return caseItem.categories.includes(categoryId) || 
                               caseItem.categories.some(cat => 
                                   (typeof cat === 'object' && cat.id === categoryId)
                               );
                    }
                    
                    // 處理單一值
                    if (typeof caseItem.categories === 'object') {
                        return caseItem.categories.id === categoryId;
                    }
                    
                    return false;
                });
                
                // 篩選已完成案件
                completedCases = allCompletedCases.filter(caseItem => {
                    // 檢查類別欄位是否存在
                    if (!caseItem.categories) {
                        return false;
                    }
                    
                    // 處理字串格式 (JSON字串)
                    if (typeof caseItem.categories === 'string') {
                        try {
                            const categoriesArray = JSON.parse(caseItem.categories);
                            if (Array.isArray(categoriesArray)) {
                                return categoriesArray.includes(categoryId);
                            }
                        } catch (e) {
                            console.warn('解析已完成案件類別JSON時出錯:', caseItem.id, e);
                        }
                        return false;
                    }
                    
                    // 處理陣列格式
                    if (Array.isArray(caseItem.categories)) {
                        return caseItem.categories.includes(categoryId) || 
                               caseItem.categories.some(cat => 
                                   (typeof cat === 'object' && cat.id === categoryId)
                               );
                    }
                    
                    // 處理單一值
                    if (typeof caseItem.categories === 'object') {
                        return caseItem.categories.id === categoryId;
                    }
                    
                    return false;
                });
                
                currentCategoryId = categoryId;
            }
            
            console.log(`篩選後得到 ${cases.length} 個進行中案件和 ${completedCases.length} 個已完成案件`);
            
            // 更新類別標籤的選定狀態
            updateCategoryTagsSelection();
            
            // 渲染案件列表
            renderCasesList();
        }
        
        // 渲染類別標籤
        function renderCategoryTags() {
            console.log('開始渲染類別標籤');

            // 在渲染前嘗試從localStorage應用保存的類別順序
            try {
                const savedCategories = JSON.parse(localStorage.getItem('categoriesWithOrder'));
                
                if (savedCategories && savedCategories.length > 0 && 
                    categories && categories.length === savedCategories.length) {
                    console.log('嘗試從localStorage應用類別排序...');
                    
                    // 確認localStorage中的類別與當前類別一致
                    const currentIds = [...categories].map(c => c.id).sort();
                    const savedIds = [...savedCategories].map(c => c.id).sort();
                    
                    // 檢查ID是否一致
                    const idsMatch = currentIds.length === savedIds.length && 
                                    currentIds.every((id, idx) => id === savedIds[idx]);
                    
                    if (idsMatch) {
                        console.log('localStorage中的類別ID與當前類別ID一致，將應用localStorage中的排序');
                        
                        // 合併當前數據和localStorage中的排序
                        for (let i = 0; i < categories.length; i++) {
                            const current = categories[i];
                            const saved = savedCategories.find(c => c.id === current.id);
                            
                            if (saved && saved.order !== undefined) {
                                // 只更新order屬性
                                current.order = saved.order;
                                console.log(`從cache更新類別 ${current.name} 的order為 ${current.order}`);
                            }
                        }
                        
                        // 對categories進行排序
                        categories.sort((a, b) => {
                            const orderA = typeof a.order === 'number' ? a.order : parseInt(a.order) || 9999;
                            const orderB = typeof b.order === 'number' ? b.order : parseInt(b.order) || 9999;
                            return orderA - orderB;
                        });
                        
                        console.log('已從localStorage應用類別排序');
                    } else {
                        console.log('localStorage中的類別ID與當前不匹配');
                    }
                }
            } catch (e) {
                console.error('讀取localStorage中的類別數據時出錯:', e);
            }
            
            const container = document.getElementById('category-tags');
            if (!container) {
                console.error('找不到類別標籤容器元素');
                return;
            }

            container.innerHTML = '';

            // 首先添加"全部"標籤
            const allTag = document.createElement('div');
            allTag.className = 'category-tag' + (currentCategoryId === null ? ' active' : '');
            allTag.innerHTML = `全部 <span class="count">${allCases.length}</span>`;
            allTag.addEventListener('click', function() {
                if (currentCategoryId !== null) {
                    // 使用前端篩選替代後端載入
                    filterCasesByCategory(null);
                }
            });
            container.appendChild(allTag);

            // 過濾出活躍的類別
            const activeCategories = categories.filter(category => category.isActive);
            console.log(`渲染 ${activeCategories.length} 個活躍類別標籤`);
            
            // 計算每個類別的案件數量
            const categoryCounts = {};
            
            // 更新類別計數函數 - 適配各種可能的類別格式
            function updateCategoryCount(categoryId) {
                categoryCounts[categoryId] = (categoryCounts[categoryId] || 0) + 1;
            }
            
            allCases.forEach(caseItem => {
                // 若案件有類別欄位
                if (caseItem.categories) {
                    // 處理字串格式 (JSON字串)
                    if (typeof caseItem.categories === 'string') {
                        try {
                            const categoriesArray = JSON.parse(caseItem.categories);
                            if (Array.isArray(categoriesArray)) {
                                categoriesArray.forEach(catId => updateCategoryCount(catId));
                            }
                        } catch (e) {
                            console.warn('計算類別數量時解析類別JSON出錯:', caseItem.id, e);
                        }
                    } 
                    // 處理陣列格式
                    else if (Array.isArray(caseItem.categories)) {
                        caseItem.categories.forEach(category => {
                            if (typeof category === 'string') {
                                updateCategoryCount(category);
                            } else if (typeof category === 'object' && category.id) {
                                updateCategoryCount(category.id);
                            }
                        });
                    }
                    // 處理單一物件
                    else if (typeof caseItem.categories === 'object' && caseItem.categories.id) {
                        updateCategoryCount(caseItem.categories.id);
                    }
                }
            });
            
            console.log('計算得到的類別數量:', categoryCounts);

            // 渲染每個類別標籤
            activeCategories.forEach(category => {
                const tagElement = document.createElement('div');
                tagElement.className = 'category-tag' + (currentCategoryId === category.id ? ' active' : '');
                tagElement.setAttribute('data-category-id', category.id);
                
                const count = categoryCounts[category.id] || 0;
                tagElement.innerHTML = `${category.name} <span class="count">${count}</span>`;
                
                // 設置標籤顏色
                if (!tagElement.classList.contains('active')) {
                    tagElement.style.borderColor = '#6c757d';
                    tagElement.style.color = '#6c757d';
                }
                
                // 添加點擊事件 - 使用前端篩選替代後端載入
                tagElement.addEventListener('click', function() {
                    const categoryId = this.getAttribute('data-category-id');
                    if (currentCategoryId !== categoryId) {
                        filterCasesByCategory(categoryId);
                    }
                });
                
                container.appendChild(tagElement);
            });
            
            console.log('類別標籤渲染完成');
        }

        // 更新類別標籤的選定狀態
        function updateCategoryTagsSelection() {
            const tags = document.querySelectorAll('.category-tag');
            tags.forEach(tag => {
                const categoryId = tag.getAttribute('data-category-id');
                if ((categoryId && categoryId === currentCategoryId) || (!categoryId && currentCategoryId === null)) {
                    tag.classList.add('active');
                    // 重設樣式以確保活躍標籤有正確的顏色
                    tag.style.borderColor = '';
                    tag.style.color = '';
                                } else {
                    tag.classList.remove('active');
                    // 如果不是活躍的，使用灰色外框和灰色字體
                    tag.style.borderColor = '#6c757d';
                    tag.style.color = '#6c757d';
                }
            });
        }
        
        // 移除相關人資料載入及處理函數

        // 載入相關人資料 - 删除整個函數
        // 填充相關人選擇項 - 删除整個函數
        // 新增相關人標籤 - 删除整個函數
        // 搜尋相關人 (案件表單) - 删除整個函數
        // 搜尋相關人 (進度表單) - 删除整個函數
        // 打開新增相關人模態框 - 删除整個函數
        // 保存新相關人 - 删除整個函數

        // 直接創建相關人 - 删除整個函數

        // 準備上傳的檔案
        function prepareFilesForUpload(fileList) {
            const files = [];
            for (let i = 0; i < fileList.length; i++) {
                const file = fileList[i];
                const fileType = file.type.startsWith('image/') ? 'image' : 'video';
                
                files.push({
                    name: file.name,
                    type: fileType,
                    mimeType: file.type
                });
            }
            return files;
        }
        
        // 預覽檔案
        function previewFiles() {
            const fileInput = document.getElementById('case-files');
            const previewContainer = document.getElementById('file-preview-container');
            previewContainer.innerHTML = '';
            
            if (fileInput.files.length > 0) {
                // 創建一個行容器
                const rowContainer = document.createElement('div');
                rowContainer.className = 'row mt-3';
                previewContainer.appendChild(rowContainer);
                
                for (const file of fileInput.files) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // 創建列容器
                        const colContainer = document.createElement('div');
                        colContainer.className = 'col-md-4 mb-3';
                        
                        // 創建卡片
                        const card = document.createElement('div');
                        card.className = 'card h-100';
                        
                        // 創建卡片內容
                        if (file.type.startsWith('image/')) {
                            // 創建圖片預覽
                            card.innerHTML = `
                                <div class="file-container" style="height: 150px; overflow: hidden;">
                                    <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;" />
                                </div>
                                <div class="card-body p-2">
                                    <p class="card-text small mb-1 text-truncate" title="${file.name}">${file.name}</p>
                                    <p class="card-text small text-muted">${formatFileSize(file.size)}</p>
                                </div>
                            `;
                        } else if (file.type.startsWith('video/')) {
                            // 創建影片預覽
                            card.innerHTML = `
                                <div class="file-container" style="height: 150px; overflow: hidden;">
                                    <video src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;"></video>
                                </div>
                                <div class="card-body p-2">
                                    <p class="card-text small mb-1 text-truncate" title="${file.name}">${file.name}</p>
                                    <p class="card-text small text-muted">${formatFileSize(file.size)}</p>
                                </div>
                            `;
                        } else {
                            // 其他檔案類型
                            card.innerHTML = `
                                <div class="card-body p-3 text-center">
                                    <i class="bi bi-file-earmark fs-1 text-muted"></i>
                                    <p class="card-text small mt-2 mb-0 text-truncate" title="${file.name}">${file.name}</p>
                                    <p class="card-text small text-muted">${formatFileSize(file.size)}</p>
                                </div>
                            `;
                        }
                        
                        // 設置點擊事件，預覽文件
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', function() {
                            previewFileInModal(e.target.result, file);
                        });
                        
                        // 添加卡片到列容器，再添加到行容器
                        colContainer.appendChild(card);
                        rowContainer.appendChild(colContainer);
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 在模態框中預覽文件
        function previewFileInModal(dataUrl, file) {
            // 獲取或創建模態框
            let filePreviewModal = document.getElementById('file-preview-modal');
            if (!filePreviewModal) {
                // 如果模態框不存在，則創建它
                filePreviewModal = document.createElement('div');
                filePreviewModal.className = 'modal fade';
                filePreviewModal.id = 'file-preview-modal';
                filePreviewModal.setAttribute('tabindex', '-1');
                filePreviewModal.setAttribute('aria-labelledby', 'file-preview-modal-label');
                filePreviewModal.setAttribute('aria-hidden', 'true');
                
                filePreviewModal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="file-preview-modal-label">檔案預覽</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center" id="file-preview-modal-content">
                                <!-- 預覽內容會由JavaScript動態生成 -->
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(filePreviewModal);
            }
            
            // 設置模態框標題
            document.getElementById('file-preview-modal-label').textContent = file.name;
            
            // 預覽內容
            const modalContent = document.getElementById('file-preview-modal-content');
            modalContent.innerHTML = '';
            
            if (file.type.startsWith('image/')) {
                // 圖片預覽
                modalContent.innerHTML = `
                    <img src="${dataUrl}" class="img-fluid" style="max-height: 70vh;">
                `;
            } else if (file.type.startsWith('video/')) {
                // 影片預覽
                modalContent.innerHTML = `
                    <video src="${dataUrl}" controls class="img-fluid" style="max-height: 70vh;"></video>
                `;
            } else {
                // 其他檔案類型
                modalContent.innerHTML = `
                    <div class="p-5 text-center">
                        <i class="bi bi-file-earmark fs-1"></i>
                        <p class="mt-3">${file.name}</p>
                        <a href="${file.previewUrl}" target="_blank" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-box-arrow-up-right me-1"></i>在新分頁開啟
                        </a>
                    </div>
                `;
            }
            
            // 創建模態框實例並手動設置其 z-index
            const modalElement = document.getElementById('file-preview-modal');
            
            // 確保模態框顯示在最上層
            setTimeout(() => {
                modalElement.style.zIndex = '1060';
                const backdrops = document.querySelectorAll('.modal-backdrop');
                if (backdrops.length > 1) {
                    backdrops[backdrops.length - 1].style.zIndex = '1059';
                }
            }, 10);
            
            // 顯示模態框
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // 預覽進度檔案
        function previewProgressFiles() {
            const fileInput = document.getElementById('progress-files');
            const previewContainer = document.getElementById('progress-file-preview');
            previewContainer.innerHTML = '';
            
            if (fileInput.files.length > 0) {
                // 創建一個行容器
                const rowContainer = document.createElement('div');
                rowContainer.className = 'row mt-3';
                previewContainer.appendChild(rowContainer);
                
                for (const file of fileInput.files) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // 創建列容器
                        const colContainer = document.createElement('div');
                        colContainer.className = 'col-md-4 mb-3';
                        
                        // 創建卡片
                        const card = document.createElement('div');
                        card.className = 'card h-100';
                        
                        // 創建卡片內容
                        if (file.type.startsWith('image/')) {
                            // 創建圖片預覽
                            card.innerHTML = `
                                <div class="file-container" style="height: 150px; overflow: hidden;">
                                    <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;" />
                                </div>
                                <div class="card-body p-2">
                                    <p class="card-text small mb-1 text-truncate" title="${file.name}">${file.name}</p>
                                    <p class="card-text small text-muted">${formatFileSize(file.size)}</p>
                                </div>
                            `;
                        } else if (file.type.startsWith('video/')) {
                            // 創建影片預覽
                            card.innerHTML = `
                                <div class="file-container" style="height: 150px; overflow: hidden;">
                                    <video src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;"></video>
                                </div>
                                <div class="card-body p-2">
                                    <p class="card-text small mb-1 text-truncate" title="${file.name}">${file.name}</p>
                                    <p class="card-text small text-muted">${formatFileSize(file.size)}</p>
                                </div>
                            `;
                        } else {
                            // 其他檔案類型
                            card.innerHTML = `
                                <div class="card-body p-3 text-center">
                                    <i class="bi bi-file-earmark fs-1 text-muted"></i>
                                    <p class="card-text small mt-2 mb-0 text-truncate" title="${file.name}">${file.name}</p>
                                    <p class="card-text small text-muted">${formatFileSize(file.size)}</p>
                                </div>
                            `;
                        }
                        
                        // 設置點擊事件，預覽文件
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', function() {
                            previewFileInModal(e.target.result, file);
                        });
                        
                        // 添加卡片到列容器，再添加到行容器
                        colContainer.appendChild(card);
                        rowContainer.appendChild(colContainer);
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }
        
        // 渲染案件列表
        function renderCasesList() {
            const container = document.getElementById('cases-container');
            container.innerHTML = '';
            
            // 渲染前檢查每個案件的收藏狀態（調試用）
            console.log("========= 渲染前案件收藏狀態檢查 =========");
            cases.forEach((caseItem, index) => {
                console.log(`[${index}] 案件ID: ${caseItem.id}, 標題: ${caseItem.title}, isFavorite: ${caseItem.isFavorite}, 類型: ${typeof caseItem.isFavorite}, 是否在favoriteCaseIds中: ${favoriteCaseIds.includes(caseItem.id)}`);
            });
            
            // 排序案件
            const sortedCases = [...cases].sort((a, b) => {
                // 先按照「我的最愛」狀態排序
                const aIsFavorite = a.isFavorite === true;
                const bIsFavorite = b.isFavorite === true;
                
                if (aIsFavorite && !bIsFavorite) return -1; // a是收藏，b不是，a排前面
                if (!aIsFavorite && bIsFavorite) return 1;  // a不是收藏，b是，b排前面
                
                // 如果收藏狀態相同，再按日期排序
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateSort === 'desc' ? dateB - dateA : dateA - dateB;
            });
            
            if (sortedCases.length === 0) {
                const noDataMessage = currentCategoryId === null 
                    ? '<div class="alert alert-info">目前沒有進行中的案件</div>' 
                    : '<div class="alert alert-info">此類別下目前沒有進行中的案件</div>';
                container.innerHTML = noDataMessage;
                return;
            }
            
            // 渲染每個案件
            sortedCases.forEach(caseItem => {
                // 生成相關人標籤HTML
                let relatedPeopleHTML = '';
                if (caseItem.relatedPeople && caseItem.relatedPeople.length > 0) {
                    relatedPeopleHTML = '<div class="mt-2">';
                    caseItem.relatedPeople.forEach(personId => {
                        // 如果是ID，則查找並顯示名稱
                        if (typeof personId === 'string') {
                            // 嘗試在活躍相關人列表中查找
                            const personObj = people.find(p => p && p.id === personId);
                            
                            if (personObj) {
                                // 使用找到的相關人資訊
                                const backgroundColor = personObj.color || '#CCCCCC';
                                const textColor = getContrastColor(backgroundColor);
                                relatedPeopleHTML += `<span class="badge me-1 mb-1" style="background-color: ${backgroundColor}; color: ${textColor};">${personObj.name}</span>`;
                            } else {
                                // 如果找不到，顯示替代文字
                                relatedPeopleHTML += `<span class="badge me-1 mb-1" style="background-color: #CCCCCC; color: #000000;">已刪除的相關人(${personId})</span>`;
                            }
                        }
                    });
                    relatedPeopleHTML += '</div>';
                }
                
                // 生成類別標籤HTML
                let categoriesHTML = '';
                if (caseItem.categories && caseItem.categories.length > 0) {
                    categoriesHTML = '<div class="mt-2">';
                    caseItem.categories.forEach(categoryId => {
                        // 如果是ID，則查找並顯示名稱
                        if (typeof categoryId === 'string') {
                            // 嘗試在活躍類別列表中查找
                            const categoryObj = categories.find(c => c && c.id === categoryId);
                            
                            if (categoryObj) {
                                // 使用找到的類別資訊
                                const backgroundColor = '#0d6efd';
                                const textColor = '#FFFFFF';
                                categoriesHTML += `<span class="badge me-1 mb-1" style="background-color: ${backgroundColor}; color: ${textColor};">${categoryObj.name}</span>`;
                            } else {
                                // 如果找不到，顯示替代文字
                                categoriesHTML += `<span class="badge me-1 mb-1" style="background-color: #CCCCCC; color: #000000;">已刪除的類別(${categoryId})</span>`;
                            }
                        }
                    });
                    categoriesHTML += '</div>';
                }
                
                const card = document.createElement('div');
                // 添加 mb-3 使卡片間有間距，並添加 data-case-id
                card.className = 'card case-card mb-3'; 
                card.style.cursor = 'pointer'; // 添加鼠標指針樣式
                card.setAttribute('data-case-id', caseItem.id); // 將 caseId 儲存在卡片上
                card.style.position = 'relative'; // 為了絕對定位星號圖標
                
                // 判斷是否為我的最愛
                const isFavorite = caseItem.isFavorite === true;
                
                // 顯示標題、日期和相關人
                card.innerHTML = `
                    <i class="bi bi-star-fill favorite-icon ${isFavorite ? 'active' : 'inactive'}" data-case-id="${caseItem.id}"></i>
                    <i class="bi bi-trash delete-icon" data-case-id="${caseItem.id}"></i>
                    <div class="card-body">
                        <h5 class="card-title">${caseItem.title}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">${formatDateTime(caseItem.date)}</h6>
                        ${relatedPeopleHTML}
                        ${categoriesHTML}
                    </div>
                `;
                
                container.appendChild(card);
                
                // 為星號圖標添加點擊事件
                const favoriteIcon = card.querySelector('.favorite-icon');
                favoriteIcon.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡，避免觸發卡片的點擊事件
                    toggleFavorite(this.getAttribute('data-case-id'));
                });
                
                // 為刪除圖示添加點擊事件
                const deleteIcon = card.querySelector('.delete-icon');
                deleteIcon.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡，避免觸發卡片的點擊事件
                    showDeleteConfirmation('案件', this.getAttribute('data-case-id'), function(caseId) {
                        console.log(`確認刪除案件ID: ${caseId}`);
                        
                        // 顯示載入指示器
                        showLoading('正在刪除案件...');
                        
                        // 調用後端API標記案件為已刪除
                        google.script.run
                            .withSuccessHandler(function(response) {
                                hideLoading();
                                
                                try {
                                    const result = JSON.parse(response);
                                    
                                    if (result && result.success) {
                                        console.log(`案件 ${caseId} 已標記為刪除:`, result.message);
                                        
                                        // 從前端數據中移除案件
                                        const caseIndex = cases.findIndex(c => c.id === caseId);
                                        if (caseIndex !== -1) {
                                            cases.splice(caseIndex, 1);
                                        }
                                        
                                        const allCaseIndex = allCases.findIndex(c => c.id === caseId);
                                        if (allCaseIndex !== -1) {
                                            allCases.splice(allCaseIndex, 1);
                                        }
                                        
                                        // 重新渲染案件列表
                                        renderCasesList();
                                        
                                        // 顯示通知
                                        showNotification('案件已刪除！');
                                    } else {
                                        console.error('標記案件為已刪除失敗:', result);
                                        showNotification('刪除案件失敗：' + (result && result.error ? result.error : '未知錯誤'), '錯誤');
                                    }
                                } catch (e) {
                                    console.error('解析刪除案件回應時發生錯誤:', e);
                                    showNotification('處理伺服器回應時出錯', '錯誤');
                                }
                            })
                            .withFailureHandler(function(error) {
                                hideLoading();
                                console.error('與伺服器通訊失敗:', error);
                                showNotification('與伺服器通訊失敗：' + error, '錯誤');
                            })
                            .markCaseAsDeleted(sheetsId, caseId);
                    });
                });
                
                // 為整張卡片添加點擊事件
                card.addEventListener('click', function() {
                    // 從卡片的 data-* 屬性獲取 caseId
                    viewCaseDetails(this.getAttribute('data-case-id')); 
                });
            });
        }
        
        // 獲取最新進度
        function getLatestProgress(caseItem) {
            if (!caseItem.progress || caseItem.progress.length === 0) {
                return '尚無進度';
            }
            
            // 按日期排序進度記錄
            const sortedProgress = [...caseItem.progress].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;
            });
            
            return truncateText(sortedProgress[0].content, 50);
        }
        
        // 截斷文字
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) {
                return text;
            }
            return text.substring(0, maxLength) + '...';
        }
        
        // 格式化日期時間
        function formatDateTime(dateTime) {
            const date = new Date(dateTime);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // 切換案件排序
        function toggleCasesSort() {
            dateSort = dateSort === 'desc' ? 'asc' : 'desc';
            
            // 更新排序圖標
            document.getElementById('date-sort').innerHTML = 
                dateSort === 'desc' ? '<i class="bi bi-sort-down"></i>' : '<i class="bi bi-sort-up"></i>';
            
            // 重新渲染案件列表
            renderCasesList();
        }
        
        // 切換進度排序
        function toggleProgressSort() {
            progressSort = progressSort === 'desc' ? 'asc' : 'desc';
            
            // 更新排序圖標
            document.getElementById('progress-sort').innerHTML = 
                progressSort === 'desc' ? '<i class="bi bi-sort-down"></i>' : '<i class="bi bi-sort-up"></i>';
            
            // 重新渲染進度列表
            renderProgressList();
        }
        
        // 切換已完成案件排序
        function toggleCompletedSort() {
            completedSort = completedSort === 'desc' ? 'asc' : 'desc';
            
            // 更新排序圖標
            document.getElementById('completed-sort').innerHTML = 
                completedSort === 'desc' ? '<i class="bi bi-sort-down"></i>' : '<i class="bi bi-sort-up"></i>';
            
            // 重新渲染完成案件列表
            renderCompletedCases();
        }
        
        // 切換收藏狀態
        function toggleFavorite(caseId) {
            // 顯示載入指示器
            showLoading('正在更新收藏狀態...');
            
            console.log(`準備切換案件ID: ${caseId} 的收藏狀態`);
            
            // 找到相應案件，記錄當前狀態（調試用）
            const caseInAllCases = allCases.find(c => c.id === caseId);
            const caseInAllCompleted = allCompletedCases.find(c => c.id === caseId);
            
            if (caseInAllCases) {
                console.log(`切換前進行中案件狀態: ID: ${caseId}, isFavorite: ${caseInAllCases.isFavorite}, 類型: ${typeof caseInAllCases.isFavorite}`);
            } else if (caseInAllCompleted) {
                console.log(`切換前已完成案件狀態: ID: ${caseId}, isFavorite: ${caseInAllCompleted.isFavorite}, 類型: ${typeof caseInAllCompleted.isFavorite}`);
            } else {
                console.log(`找不到案件ID: ${caseId}的案件記錄`);
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    try {
                        const result = JSON.parse(response);
                        
                        if (result && result.success) {
                            console.log(`案件 ${caseId} 收藏狀態更新成功:`, result.isFavorite);
                            
                            const isFavorite = result.isFavorite;
                            
                            // 1. 更新案件陣列中的狀態
                            const updateCaseIsFavorite = (caseArray, id) => {
                                const index = caseArray.findIndex(c => c.id === id);
                                if (index !== -1) {
                                    console.log(`在陣列中找到案件 ${id}，將isFavorite從 ${caseArray[index].isFavorite} 更新為 ${isFavorite}`);
                                    caseArray[index].isFavorite = isFavorite;
                                    return true;
                                }
                                return false;
                            };
                            
                            updateCaseIsFavorite(allCases, caseId);
                            updateCaseIsFavorite(allCompletedCases, caseId);
                            updateCaseIsFavorite(cases, caseId);
                            updateCaseIsFavorite(completedCases, caseId);
                            
                            // 2. 更新favoriteCaseIds陣列
                            if (isFavorite) {
                                if (!favoriteCaseIds.includes(caseId)) {
                                    favoriteCaseIds.push(caseId);
                                }
                            } else {
                                const index = favoriteCaseIds.indexOf(caseId);
                                if (index !== -1) {
                                    favoriteCaseIds.splice(index, 1);
                                }
                            }
                            
                            // 3. 重新渲染列表以更新UI
                            if (getCurrentPage() === 'cases') {
                                renderCasesList();
                            } else if (getCurrentPage() === 'completed') {
                                renderCompletedCases();
                            }
                        } else {
                            console.error('更新收藏狀態失敗:', result);
                            showNotification('更新收藏狀態失敗：' + (result && result.error ? result.error : '未知錯誤'), '錯誤');
                        }
                    } catch (e) {
                        console.error('解析回應時發生錯誤:', e);
                        showNotification('解析伺服器回應時發生錯誤', '錯誤');
                    }
                    
                    hideLoading();
                })
                .withFailureHandler(function(error) {
                    console.error('與伺服器通訊失敗:', error);
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                    hideLoading();
                })
                .toggleCaseFavorite(sheetsId, caseId);
        }

        // 查看案件詳情
        function viewCaseDetails(caseId) {
            currentCaseId = caseId;
            const caseItem = cases.find(c => c.id === caseId);
            
            if (!caseItem) {
                alert('案件不存在');
                return;
            }
            
            // 渲染案件資訊
            renderCaseInfo(caseItem);
            
            // 渲染進度列表
            renderProgressList();
            
            // 顯示案件詳情頁面
            showPage('caseDetails');
        }
        
        // 渲染案件資訊
        function renderCaseInfo(caseItem) {
            console.log("開始渲染案件詳情:", caseItem);
            console.log("相關人資訊:", caseItem.relatedPeople, "類型:", typeof caseItem.relatedPeople);
            
            const container = document.getElementById('case-info');
            
            // 獲取相關人名稱
            let relatedPeopleHTML = '';
            if (caseItem.relatedPeople && caseItem.relatedPeople.length > 0) {
                relatedPeopleHTML = `
                <div class="mb-3 mt-2">
                    <strong>相關人：</strong>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                        ${caseItem.relatedPeople.map(person => {
                            // 如果是ID，則查找並顯示名稱；如果已經是包含name的對象則直接使用
                            if (typeof person === 'string') {
                                // 嘗試在當前的活躍相關人列表中查找
                                const personObj = people.find(p => p && p.id === person);
                                if (personObj) {
                                    return `<span class="person-tag" style="background-color: ${personObj.color || '#CCCCCC'}; color: ${getContrastColor(personObj.color || '#CCCCCC')};">${personObj.name}</span>`;
                                }
                                
                                // 如果找不到，可能是被刪除的相關人，顯示 'p1', 'p2' 等ID或替代文字
                                return `<span class="person-tag" style="background-color: #CCCCCC; color: #000000;">已刪除的相關人(${person})</span>`;
                            } else if (person.name && person.id) {
                                return `<span class="person-tag" style="background-color: ${person.color || '#CCCCCC'}; color: ${getContrastColor(person.color || '#CCCCCC')};">${person.name}</span>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                </div>`;
            }
            
            // 獲取類別名稱
            let categoriesHTML = '';
            if (caseItem.categories && caseItem.categories.length > 0) {
                categoriesHTML = `
                <div class="mb-3">
                    <strong>類別：</strong>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                        ${caseItem.categories.map(category => {
                            // 如果是ID，則查找並顯示名稱；如果已經是包含name的對象則直接使用
                            if (typeof category === 'string') {
                                // 嘗試在當前的活躍類別列表中查找
                                const categoryObj = categories.find(c => c && c.id === category);
                                if (categoryObj) {
                                    return `<span class="person-tag" style="background-color: ${categoryObj.color || '#CCCCCC'}; color: ${getContrastColor(categoryObj.color || '#CCCCCC')};">${categoryObj.name}</span>`;
                                }
                                
                                // 如果找不到，可能是被刪除的類別，顯示替代文字
                                return `<span class="person-tag" style="background-color: #CCCCCC; color: #000000;">已刪除的類別(${category})</span>`;
                            } else if (category.name && category.id) {
                                return `<span class="person-tag" style="background-color: ${category.color || '#CCCCCC'}; color: ${getContrastColor(category.color || '#CCCCCC')};">${category.name}</span>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                </div>`;
            }
            
            // 確保files是陣列物件，而非字串
            let filesArray = [];
            if (caseItem.files) {
                console.log("原始檔案資訊類型:", typeof caseItem.files);
                if (typeof caseItem.files === 'string') {
                    try {
                        // 如果files是字串，嘗試解析為JSON
                        filesArray = JSON.parse(caseItem.files);
                        console.log("解析後的檔案資訊:", filesArray);
                        } catch (e) {
                        console.error("解析files字串時出錯:", e);
                        filesArray = [];
                    }
                } else if (Array.isArray(caseItem.files)) {
                    // 已經是陣列，直接使用
                    filesArray = caseItem.files;
                    console.log("檔案資訊已經是陣列:", filesArray);
                }
            }
            console.log("處理後的檔案資訊:", filesArray);
            
            // 渲染案件基本資訊
            container.innerHTML = `
                <div class="card-body">
                    <h4 class="card-title">${caseItem.title}</h4>
                    <h6 class="card-subtitle mb-2 text-muted">${formatDateTime(caseItem.date)}</h6>
                    ${relatedPeopleHTML}
                    ${categoriesHTML}
                    <p class="card-text content-text">${caseItem.content}</p>
                </div>
            `;
            
            // 渲染附件（使用與進度記錄相同的方法）
            if (filesArray && filesArray.length > 0) {
                console.log("開始渲染附件，數量:", filesArray.length);
                
                const filesSection = document.createElement('div');
                filesSection.className = 'card-body border-top';
                filesSection.innerHTML = `<h5>附件</h5>`;
                
                const filesList = document.createElement('div');
                filesList.className = 'row';
                
                filesArray.forEach((file, index) => {
                    console.log(`渲染第 ${index+1} 個檔案:`, file);
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'col-md-4 mb-3';
                    
                    if (file.type === 'image') {
                        // 使用新的圖片渲染函數
                        renderImageItem(fileItem, file);
                    } else if (file.type === 'video') {
                        // 使用新的影片渲染函數
                        renderVideoItem(fileItem, file);
                    } else {
                        // 其他類型檔案
                        renderFileItem(fileItem, file);
                    }
                    
                    filesList.appendChild(fileItem);
                    
                    // 添加點擊預覽事件
                    const cardElement = fileItem.querySelector('.card');
                    if (cardElement) {
                        cardElement.addEventListener('click', function() {
                            console.log("點擊了檔案:", file);
                            openFilePreview(file);
                        });
                    } else {
                        console.warn("找不到卡片元素，無法添加點擊事件");
                    }
                });
                
                filesSection.appendChild(filesList);
                container.appendChild(filesSection);
                console.log("附件渲染完成");
            } else {
                console.log("此案件沒有附件");
            }
        }
        
        // 渲染圖片項目
        function renderImageItem(container, file) {
            container.innerHTML = `
                <div class="card h-100">
                    <div class="file-container" style="height: 150px;"> <!-- 設定固定高度 -->
                        <iframe src="${file.previewUrl}" 
                                style="width: 100%; height: 100%; border: none;" 
                                frameborder="0" 
                                loading="lazy">
                        </iframe>
                    </div>
                    <div class="card-body p-2">
                        <p class="card-text small mb-1">${file.name}</p>
                        <a href="${file.previewUrl}" target="_blank" class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation();"> 
                            <i class="bi bi-box-arrow-up-right"></i> 開啟
                        </a>
                    </div>
                </div>
            `;
        }
        
        // 處理基本圖片錯誤
        function handleBasicImageError(container, fileId, url, event) {
            // 簡化錯誤處理，因為 iframe 自身會處理大部分錯誤
            console.error('圖片 iframe 載入失敗事件:', event);
            console.error(`圖片載入失敗 - File ID: ${fileId}, URL: ${url}`);
            // 可以選擇在這裡添加一個簡單的錯誤提示或重試按鈕
            // container.innerHTML = `<div class="error-overlay"><p>無法載入圖片</p></div>`;
        }
        
        // 重新載入圖片
        function reloadImage(fileId, url, event) {
            // 簡化或移除，iframe 通常不需要手動重載
            if (event) {
                event.stopPropagation();
            }
            console.log('重新載入 iframe: ', fileId, url);
            // 可以嘗試重新設置 iframe 的 src
            const iframe = event.target.closest('.card').querySelector('iframe');
            if (iframe) {
                const currentSrc = iframe.src;
                iframe.src = ''; // 清空 src
                setTimeout(() => { iframe.src = currentSrc; }, 50); // 延遲重新設置 src
            }
        }
        
        // 渲染影片項目
        function renderVideoItem(container, file) {
            container.innerHTML = `
                <div class="card h-100">
                    <div class="file-container" style="height: 150px;"> <!-- 設定固定高度 -->
                        <iframe src="${file.previewUrl}" 
                                style="width: 100%; height: 100%; border: none;" 
                                frameborder="0" 
                                allowfullscreen 
                                loading="lazy">
                        </iframe>
                    </div>
                    <div class="card-body p-2">
                        <p class="card-text small mb-1">${file.name}</p>
                        <a href="${file.previewUrl}" target="_blank" class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation();">
                            <i class="bi bi-box-arrow-up-right"></i> 開啟
                        </a>
                    </div>
                </div>
            `;
        }
        
        // 處理基本影片錯誤
        function handleBasicVideoError(container, fileId, url, event) {
            // 簡化錯誤處理
            console.error('影片 iframe 載入失敗事件:', event);
            console.error(`影片載入失敗 - File ID: ${fileId}, URL: ${url}`);
            // container.innerHTML = `<div class="error-overlay"><p>無法載入影片</p></div>`;
        }
        
        // 重新載入影片
        function reloadVideo(fileId, url, event) {
            // 簡化或移除
            if (event) {
                event.stopPropagation();
            }
            console.log('重新載入 iframe: ', fileId, url);
            const iframe = event.target.closest('.card').querySelector('iframe');
            if (iframe) {
                const currentSrc = iframe.src;
                iframe.src = ''; 
                setTimeout(() => { iframe.src = currentSrc; }, 50);
            }
        }
        
        // 渲染一般檔案項目
        function renderFileItem(container, file) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-body p-2">
                        <i class="bi bi-file-earmark fs-4"></i>
                        <p class="card-text small">${file.name}</p>
                        <a href="${file.downloadUrl || file.url}" target="_blank" class="btn btn-sm btn-primary">開啟</a>
                    </div>
                </div>
            `;
        }
        
        // 處理圖片載入錯誤
        function handleImageError(imgElement, file) {
            console.error('圖片載入失敗:', imgElement.src);
            
            // 依序嘗試不同的URL格式
            if (imgElement.src === file.viewUrl && file.thumbnailUrl) {
                imgElement.src = file.thumbnailUrl;
                return; // 嘗試縮圖
            } else if ((imgElement.src === file.viewUrl || imgElement.src === file.thumbnailUrl) && file.downloadUrl) {
                imgElement.src = file.downloadUrl;
                return; // 嘗試下載連結
            } else if ((imgElement.src === file.viewUrl || imgElement.src === file.thumbnailUrl || imgElement.src === file.downloadUrl) && file.mediaUrl) {
                imgElement.src = file.mediaUrl;
                return; // 嘗試媒體連結
            } else if (imgElement.src !== file.url && file.url) {
                imgElement.src = file.url;
                return; // 嘗試原始URL
            }
            
            // 所有URL都失敗，顯示錯誤訊息
            const container = imgElement.parentNode;
            container.classList.remove('loading');
            container.innerHTML = `
                <div class="fallback-link">
                    <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                    <p class="mt-2">無法載入圖片</p>
                    <a href="${file.downloadUrl || file.url}" target="_blank" class="btn btn-sm btn-primary">在新分頁開啟</a>
                </div>
            `;
        }
        
        // 處理影片載入錯誤
        function handleVideoError(container, file) {
            console.error('影片載入失敗:', file.url);
            
            if (container.querySelector('iframe') && file.url && !file.url.includes('/preview')) {
                // 如果是iframe失敗，嘗試改用video標籤
                container.innerHTML = `
                    <video src="${file.url}" controls class="card-img-top video-preview"
                           onloadeddata="this.parentNode.classList.remove('loading')"
                           onerror="this.parentNode.innerHTML='<div class=\\'fallback-link\\'><i class=\\'bi bi-film text-muted\\' style=\\'font-size: 2rem;\\'></i><p class=\\'mt-2\\'>無法載入影片</p><a href=\\'${file.downloadUrl || file.mediaUrl || file.url}\\' target=\\'_blank\\' class=\\'btn btn-sm btn-primary\\'>在新分頁開啟</a></div>';">
                    </video>
                `;
                return;
            }
            
            // 最終失敗，提供下載連結
            container.classList.remove('loading');
            container.innerHTML = `
                <div class="fallback-link">
                    <i class="bi bi-film text-muted" style="font-size: 2rem;"></i>
                    <p class="mt-2">無法載入影片</p>
                    <a href="${file.downloadUrl || file.mediaUrl || file.url}" target="_blank" class="btn btn-sm btn-primary">在新分頁開啟</a>
                </div>
            `;
        }
        
        // 渲染檔案附件
        function renderFileAttachments(files, container) {
            if (!files || !files.length || !container) return;
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-attachment mb-2';
                
                if (file.type === 'image') {
                    // 使用相同的圖片渲染函數
                    renderImageItem(fileItem, file);
                } else if (file.type === 'video') {
                    // 使用相同的影片渲染函數
                    renderVideoItem(fileItem, file);
                } else {
                    // 其他類型檔案
                    renderFileItem(fileItem, file);
                }
                
                container.appendChild(fileItem);
                
                // 添加點擊預覽事件
                const cardElement = fileItem.querySelector('.card');
                if (cardElement) {
                    cardElement.addEventListener('click', function() {
                        openFilePreview(file);
                    });
                }
            });
        }
        
        // 在新標籤頁開啟檔案
        function openFileInNewTab(file) {
            if (file && file.url) {
                window.open(file.url, '_blank');
            }
        }
        
        // 在模態框中預覽檔案
        function openFilePreview(file) {
            if (!file || !file.previewUrl) { // 檢查 previewUrl 是否存在
                console.error('缺少檔案或檔案預覽 URL');
                showNotification('無法預覽此檔案，缺少必要的資訊。', '錯誤');
                return;
            }
            
            // 如果有其他已打開的模態框，先關閉當前所有模態框
            const currentModals = document.querySelectorAll('.modal.show');
            currentModals.forEach(modalEl => {
                const bsModal = bootstrap.Modal.getInstance(modalEl);
                if (bsModal) {
                    // 使用 hide 方法而不是 dispose，這樣不會完全銷毀模態框
                    bsModal.hide();
                }
            });
            
            const modalContent = document.getElementById('file-preview-modal-content');
            modalContent.innerHTML = '';
            
            // 在模態框的標題中顯示檔案名稱
            document.getElementById('file-preview-modal-label').textContent = file.name;
            
            if (file.type === 'image' || file.type === 'video') { // 合併圖片和影片的處理
                // 在模態框中顯示 iframe 預覽
                modalContent.innerHTML = `
                    <div class="file-container" style="height: 70vh; background-color: #eee;"> <!-- 設定背景色以區分 -->
                        <iframe src="${file.previewUrl}" 
                                style="width: 100%; height: 100%; border: none;" 
                                frameborder="0" 
                                allowfullscreen 
                                loading="lazy">
                        </iframe>
                    </div>
                    <div class="mt-3 text-center">
                        <a href="${file.previewUrl}" target="_blank" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-box-arrow-up-right me-1"></i>在新分頁開啟
                        </a>
                    </div>
                `;
            } else {
                // 其他類型檔案，提供下載連結
                modalContent.innerHTML = `
                    <div class="p-5 text-center">
                        <i class="bi bi-file-earmark fs-1"></i>
                        <p class="mt-3">${file.name}</p>
                        <a href="${file.previewUrl}" target="_blank" class="btn btn-primary mt-3">開啟檔案</a>
                    </div>
                `;
            }
            
            // 創建模態框實例並手動設置其 z-index
            const modalElement = document.getElementById('file-preview-modal');
            
            // 確保模態框顯示在最上層
            setTimeout(() => {
                modalElement.style.zIndex = '1060';
                const backdrops = document.querySelectorAll('.modal-backdrop');
                if (backdrops.length > 1) {
                    backdrops[backdrops.length - 1].style.zIndex = '1059';
                }
            }, 10);
            
            // 顯示模態框
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // 處理模態框基本錯誤
        function handleModalBasicError(container, type, event) {
            // 這個函數現在可能不太需要了，因為 iframe 錯誤通常不會觸發外部的 onerror
            console.error(`模態框 ${type} iframe 載入失敗事件:`, event);
            container.classList.remove('loading'); // 移除 loading 狀態（如果還有的話）
            container.innerHTML = `
                <div class="error-overlay d-flex flex-column justify-content-center align-items-center text-center p-3">
                    <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 3rem;"></i>
                    <p class="mt-3 mb-2">無法載入預覽</p>
                    <p class="small text-muted">請嘗試在新分頁開啟。</p>
                </div>
            `;
        }
        
        // 重新載入模態框內容
        function reloadModalContent(url, type) {
            // 簡化：通常不需要為 iframe 手動添加重載按鈕
            console.log('重新載入模態框 iframe: ', url, type);
            const iframe = document.querySelector('#file-preview-modal-content iframe');
            if (iframe) {
                iframe.src = iframe.src; // 重新載入 iframe
            }
        }
        
        // 渲染進度列表
        function renderProgressList() {
            const container = document.getElementById('progress-container');
            container.innerHTML = '';
            
            const caseItem = cases.find(c => c.id === currentCaseId);
            
            if (!caseItem || !caseItem.progress || caseItem.progress.length === 0) {
                container.innerHTML = '<div class="alert alert-info">目前沒有進度記錄</div>';
                return;
            }
            
            // 過濾掉已刪除的進度
            const validProgress = caseItem.progress.filter(p => {
                // 如果isDeleted是undefined或null，視為未刪除
                if (p.isDeleted === undefined || p.isDeleted === null) {
                    return true;
                }
                
                const isDeletedStr = String(p.isDeleted).toUpperCase();
                if (isDeletedStr === 'TRUE' || p.isDeleted === true) {
                    console.log(`過濾掉已刪除進度: ID=${p.id}, 日期=${p.date}, isDeleted=${p.isDeleted}, 轉換後=${isDeletedStr}`);
                    return false;
                }
                return true;
            });
            
            // 如果過濾後沒有進度記錄
            if (validProgress.length === 0) {
                container.innerHTML = '<div class="alert alert-info">目前沒有進度記錄</div>';
                return;
            }
            
            // 排序進度
            const sortedProgress = [...validProgress].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return progressSort === 'desc' ? dateB - dateA : dateA - dateB;
            });
            
            // 渲染每個進度
            sortedProgress.forEach(progress => {
                console.log(`[進度 ID: ${progress.id}] 開始渲染進度項目:`, progress);
                
                // 獲取進度相關人
                const progressRelatedPeoples = progress.relatedPeople.map(pid => {
                    // 嘗試在當前的活躍相關人列表中查找
                    const person = people.find(p => p && p.id === pid);
                    
                    // 如果找不到或資料無效，建立一個默認物件
                    if (!person) {
                        return {
                            id: pid,
                            name: `已刪除的相關人(${pid})`,
                            color: '#CCCCCC'
                        };
                    }
                    
                    return person;
                }).filter(Boolean); // 過濾掉不存在的相關人
                
                const progressItem = document.createElement('div');
                progressItem.className = 'card mb-3 progress-item';
                progressItem.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">${formatDateTime(progress.date)}</h5>
                        </div>
                        <p class="card-text content-text">${progress.content}</p>
                        ${progressRelatedPeoples.length > 0 ? `
                        <div class="mt-2">
                            <div class="d-flex flex-wrap gap-1">
                                ${progressRelatedPeoples.map(person => 
                                    `<span class="person-tag" style="background-color: ${person.color}; color: ${getContrastColor(person.color)};">${person.name}</span>`
                                ).join('')}
                            </div>
                        </div>` : ''}
                        <i class="bi bi-trash delete-icon" data-progress-id="${progress.id}"></i>
                    </div>
                `;
                
                // === 新增偵錯：檢查進度檔案資訊 ===
                let progressFilesArray = [];
                if (progress.files) {
                    console.log(`[進度 ID: ${progress.id}] 原始檔案資訊類型:`, typeof progress.files);
                    if (typeof progress.files === 'string') {
                        try {
                            progressFilesArray = JSON.parse(progress.files);
                            console.log(`[進度 ID: ${progress.id}] 解析後的檔案資訊:`, progressFilesArray);
                        } catch (e) {
                            console.error(`[進度 ID: ${progress.id}] 解析 files 字串時出錯:`, e);
                            progressFilesArray = [];
                        }
                    } else if (Array.isArray(progress.files)) {
                        progressFilesArray = progress.files;
                        console.log(`[進度 ID: ${progress.id}] 檔案資訊已經是陣列:`, progressFilesArray);
                    } else {
                         console.warn(`[進度 ID: ${progress.id}] 未知的檔案資訊類型:`, typeof progress.files);
                    }
                } else {
                     console.log(`[進度 ID: ${progress.id}] 此進度沒有檔案資訊`);
                }
                console.log(`[進度 ID: ${progress.id}] 處理後的檔案資訊:`, progressFilesArray);
                // === 結束新增偵錯 ===

                // 添加檔案預覽 (使用解析後的 progressFilesArray)
                if (progressFilesArray && progressFilesArray.length > 0) {
                    console.log(`[進度 ID: ${progress.id}] 開始渲染 ${progressFilesArray.length} 個附件`);
                    const filesContainer = document.createElement('div');
                    filesContainer.className = 'card-body pt-0';
                    
                    const filesList = document.createElement('div');
                    filesList.className = 'row';
                    
                    progressFilesArray.forEach((file, index) => {
                        console.log(`[進度 ID: ${progress.id}] 渲染第 ${index + 1} 個檔案:`, file);
                        const fileItem = document.createElement('div');
                        fileItem.className = 'col-md-4 mb-2';
                        
                        if (file.type === 'image') {
                            renderImageItem(fileItem, file);
                        } else if (file.type === 'video') {
                            renderVideoItem(fileItem, file);
                        } else {
                            renderFileItem(fileItem, file);
                        }
                        
                        filesList.appendChild(fileItem);
                        
                        // 添加點擊預覽事件
                        const cardElement = fileItem.querySelector('.card');
                        if (cardElement) {
                            cardElement.addEventListener('click', function() {
                                console.log(`[進度 ID: ${progress.id}] 點擊了檔案:`, file);
                                openFilePreview(file);
                            });
                        } else {
                            console.warn(`[進度 ID: ${progress.id}] 找不到卡片元素，無法添加點擊事件`);
                        }
                    });
                    
                    filesContainer.appendChild(filesList);
                    progressItem.appendChild(filesContainer);
                     console.log(`[進度 ID: ${progress.id}] 附件渲染完成`);
                } else {
                     console.log(`[進度 ID: ${progress.id}] 沒有附件需要渲染`);
                }
                
                container.appendChild(progressItem);
                
                // 為刪除圖示添加點擊事件
                const deleteIcon = progressItem.querySelector('.delete-icon');
                if (deleteIcon) {
                    deleteIcon.addEventListener('click', function(e) {
                        e.stopPropagation(); // 阻止事件冒泡
                        const progressId = this.getAttribute('data-progress-id');
                        showDeleteConfirmation('進度', progressId, function(progressId) {
                            console.log(`確認刪除進度 ID: ${progressId}`);
                            
                            // 顯示載入指示器
                            showLoading('正在刪除進度...');
                            
                            // 調用後端API標記進度為已刪除
                            google.script.run
                                .withSuccessHandler(function(response) {
                                    hideLoading();
                                    
                                    try {
                                        const result = JSON.parse(response);
                                        
                                        if (result && result.success) {
                                            console.log(`進度 ${progressId} 已標記為刪除:`, result.message);
                                            
                                            // 從前端數據中移除進度
                                            const progressIndex = caseItem.progress.findIndex(p => p.id === progressId);
                                            if (progressIndex !== -1) {
                                                caseItem.progress.splice(progressIndex, 1);
                                            }
                                            
                                            // 重新渲染進度列表
                                            renderProgressList();
                                            
                                            // 顯示通知
                                            showNotification('進度已刪除！');
                                        } else {
                                            console.error('標記進度為已刪除失敗:', result);
                                            showNotification('刪除進度失敗：' + (result && result.error ? result.error : '未知錯誤'), '錯誤');
                                        }
                                    } catch (e) {
                                        console.error('解析刪除進度回應時發生錯誤:', e);
                                        showNotification('處理伺服器回應時出錯', '錯誤');
                                    }
                                })
                                .withFailureHandler(function(error) {
                                    hideLoading();
                                    console.error('與伺服器通訊失敗:', error);
                                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                                })
                                .markProgressAsDeleted(sheetsId, progressId);
                        });
                    });
                }
            });
             console.log("所有進度項目渲染完成");
        }
        
        // 打開新增進度模態框
        function openAddProgressModal() {
            // 設定當前本地日期時間
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0'); // 月份是 0-indexed
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const localDateTimeString = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            document.getElementById('progress-date').value = localDateTimeString;
            console.log('設定新增進度預設時間為:', localDateTimeString); // 添加日誌

            // 清空進度內容
            document.getElementById('progress-content').value = '';
            
            // 清空檔案
            document.getElementById('progress-files').value = '';
            document.getElementById('progress-file-preview').innerHTML = '';
            
            // 清空相關人選擇區域
            document.getElementById('progress-tags-area').innerHTML = '';
            document.getElementById('progress-person-input').value = '';
            document.getElementById('progress-people-candidates').innerHTML = '';
            
            // 顯示模態框
            const modal = new bootstrap.Modal(document.getElementById('add-progress-modal'));
            modal.show();
        }
        
        // 保存進度
        function saveProgress() {
            const date = document.getElementById('progress-date').value;
            const content = document.getElementById('progress-content').value.trim();
            
            if (!date || !content) {
                showNotification('請填寫日期和進度內容', '錯誤');
                return;
            }
            
            // 獲取選擇的相關人IDs
            const relatedPeople = [];
            document.querySelectorAll('#progress-tags-area .inline-tag').forEach(tag => {
                const personId = tag.dataset.personId;
                if (personId) {
                    relatedPeople.push(personId);
                }
            });
            
            // 處理檔案上傳
            const files = [];
            const fileInput = document.getElementById('progress-files');
            const totalFiles = fileInput.files.length;
            let processedFiles = 0;

            // 顯示進度條
            showUploadProgress('progress');
            
            const processFiles = () => {
                if (totalFiles > 0) {
                    for (let i = 0; i < fileInput.files.length; i++) {
                        const file = fileInput.files[i];
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            const fileType = file.type.startsWith('image/') ? 'image' : 'video';
                            
                            files.push({
                                name: file.name,
                                type: fileType,
                                mimeType: file.type,
                                content: e.target.result
                            });
                            
                            processedFiles++;
                            // 更新進度條
                            updateUploadProgress('progress', processedFiles, totalFiles);
                            
                            // 如果所有檔案都已處理完畢，則提交表單
                            if (processedFiles === totalFiles) {
                                document.getElementById('progress-upload-status').textContent = '檔案讀取完成，準備上傳...';
                                submitProgressToServer(date, content, relatedPeople, files, totalFiles);
                            }
                        };
                        
                        reader.readAsDataURL(file);
                    }
                } else {
                    // 沒有檔案，直接提交
                    submitProgressToServer(date, content, relatedPeople, files, 0);
                }
            };
            
            // 開始處理檔案
            processFiles();
        }
        
        // 提交進度到伺服器
        function submitProgressToServer(date, content, relatedPeople, files, fileCount) {
            const loadingMessage = fileCount > 0 ? `正在儲存進度並上傳 ${fileCount} 個檔案...` : '正在儲存進度...';
            showLoading(loadingMessage);

            const progressData = {
                caseId: currentCaseId,
                date: date,
                content: content,
                relatedPeople: relatedPeople,
                files: files // 這裡傳遞的是包含 base64 content 的物件陣列
            };

            google.script.run
                .withSuccessHandler(function(stringResponse) { // 接收字串回應
                    hideLoading();
                    hideUploadProgress('progress'); // 隱藏進度條
                    console.log('新增進度後端原始回應:', stringResponse);
                    
                    let response = null;
                    try {
                        if(stringResponse) {
                            response = JSON.parse(stringResponse);
                            console.log('新增進度解析後的回應:', response);
                        }
                    } catch (e) {
                        console.error('解析新增進度回應錯誤:', e);
                        showNotification('處理伺服器回應時出錯', '錯誤');
                        return;
                    }

                    if (response && response.success && response.progress) {
                        // 獲取新進度物件
                        const newProgress = response.progress;

                        // 找到當前案件
                        const currentCase = cases.find(c => c.id === currentCaseId);
                        if (currentCase) {
                             console.log('找到當前案件:', currentCase);
                             // 將新進度添加到本地案件資料的 progress 陣列
                             if (!currentCase.progress) {
                                 currentCase.progress = []; // 如果還沒有進度，初始化陣列
                             }
                             currentCase.progress.push(newProgress);
                             console.log('已將新進度添加到本地案件資料:', currentCase.progress);

                             // *只* 重新渲染進度列表
                             console.log('準備重新渲染進度列表...');
                             renderProgressList();
                             console.log('進度列表已重新渲染。');

                            } else {
                             console.error('無法在本地找到當前案件:', currentCaseId, '將重新載入所有資料作為後備。');
                             loadData(); // 作為後備方案，如果找不到案件則重新載入
                        }

                        // 關閉模態框
                        bootstrap.Modal.getInstance(document.getElementById('add-progress-modal')).hide();

                        // 移除進度添加通知
                        // showNotification('進度已添加！');
                        } else {
                        console.error('新增進度失敗或回應格式錯誤:', response);
                        showNotification('新增進度失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                            hideLoading();
                    hideUploadProgress('progress'); // 隱藏進度條
                    console.error('新增進度與伺服器通訊失敗:', error);
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .addProgress(sheetsId, driveFolderId, progressData); // progressData 包含 base64 文件
        }
        
        // 標記案件為已完成
        function markCaseAsCompleted() {
            const selectedCase = currentCaseId ? cases.find(c => c.id === currentCaseId) : null;
            
            if (!currentCaseId || !selectedCase) {
                showNotification('請先選擇一個案件', '提示');
                            return;
                        }
            
            // 顯示確認對話框
            const modalTitle = document.getElementById('notification-title');
            const modalBody = document.getElementById('notification-message');
            const modalFooter = document.getElementById('notification-modal').querySelector('.modal-footer');
            
            // 保存原始的確認按鈕以便稍後恢復
            const originalFooterContent = modalFooter.innerHTML;
            
            modalTitle.textContent = '標記案件為完成';
            modalBody.textContent = `確定要將案件 "${selectedCase.title}" 標記為完成嗎？`;
            
            // 修改模態框底部的按鈕
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-complete-btn">確認完成</button>
            `;
            
            // 添加確認按鈕事件監聽器
            document.getElementById('confirm-complete-btn').addEventListener('click', function() {
                // 隱藏確認視窗
                notificationModal.hide();
                showLoading('正在更新案件狀態...');
                
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response && response.success) {
                            // 儲存已完成案件ID到localStorage，以確保即使頁面重新載入也能保持狀態
                            let completedCaseIds = JSON.parse(localStorage.getItem('completedCaseIds') || '[]');
                            if (!completedCaseIds.includes(currentCaseId)) {
                                completedCaseIds.push(currentCaseId);
                                localStorage.setItem('completedCaseIds', JSON.stringify(completedCaseIds));
                                console.log(`已將案件ID ${currentCaseId} 儲存到localStorage以保持完成狀態`);
                            }
                            
                            // 立即更新前端資料結構
                            const caseIndex = cases.findIndex(c => c.id === currentCaseId);
                            
                            if (caseIndex !== -1) {
                                // 從進行中案件中移除
                                const completedCase = {...cases[caseIndex], completed: true};
                                cases.splice(caseIndex, 1);
                                
                                // 添加到已完成案件
                                // 檢查是否已經存在於已完成案件列表中，避免重複
                                if (!completedCases.some(c => c.id === completedCase.id)) {
                                    completedCases.push(completedCase);
                                }
                                
                                console.log(`案件已在前端標記為完成: ${completedCase.title}`);
                                console.log(`當前進行中案件數: ${cases.length}, 已完成案件數: ${completedCases.length}`);
                                
                                // 還原模態框底部按鈕
                                modalFooter.innerHTML = originalFooterContent;
                                
                                // 顯示通知
                        hideLoading();
                                // showNotification('案件已標記為完成！');
                                
                                // 跳轉到案件頁面
                                showPage('cases');
                            } else {
                                // 還原模態框底部按鈕
                                modalFooter.innerHTML = originalFooterContent;
                                
                                // 如果在前端找不到該案件，則直接重新載入
                                loadData(function() {
                                    hideLoading();
                                    // showNotification('案件已標記為完成！');
                                });
                            }
                        } else {
                            // 還原模態框底部按鈕
                            modalFooter.innerHTML = originalFooterContent;
                            
                            hideLoading();
                            showNotification('更新案件狀態失敗: ' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                        }
                    })
                    .withFailureHandler(function(error) {
                        // 還原模態框底部按鈕
                        modalFooter.innerHTML = originalFooterContent;
                        
                        hideLoading();
                        showNotification('與伺服器通訊失敗: ' + error, '錯誤');
                    })
                    .markCaseAsCompleted(sheetsId, currentCaseId);
            });
            
            // 顯示確認對話框
            notificationModal.show();
        }
        
        // 渲染已完成案件
        function renderCompletedCases() {
            const container = document.getElementById('completed-cases-container');
            container.innerHTML = '';
            
            // 排序案件
            const sortedCases = [...completedCases].sort((a, b) => {
                // 先按照「我的最愛」狀態排序
                const aIsFavorite = a.isFavorite === true;
                const bIsFavorite = b.isFavorite === true;
                
                if (aIsFavorite && !bIsFavorite) return -1; // a是收藏，b不是，a排前面
                if (!aIsFavorite && bIsFavorite) return 1;  // a不是收藏，b是，b排前面
                
                // 如果收藏狀態相同，再按日期排序
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return completedSort === 'desc' ? dateB - dateA : dateA - dateB;
            });
            
            if (sortedCases.length === 0) {
                container.innerHTML = '<div class="alert alert-info">目前沒有已完成的案件</div>';
                return;
            }
            
            // 渲染每個案件
            sortedCases.forEach(caseItem => {
                // 生成相關人標籤HTML
                let relatedPeopleHtml = '';
                if (caseItem.relatedPeople && caseItem.relatedPeople.length > 0) {
                    relatedPeopleHtml = '<div class="mt-2 mb-2">';
                    caseItem.relatedPeople.forEach(personId => {
                        // 嘗試在當前的活躍相關人列表中查找
                        const person = people.find(p => p && p.id === personId);
                        
                        if (person) {
                            const backgroundColor = person.color || '#6c757d';
                                const textColor = getContrastColor(backgroundColor);
                            relatedPeopleHtml += `<span class="badge me-1 mb-1" style="background-color: ${backgroundColor}; color: ${textColor};">${person.name}</span>`;
                            } else {
                                // 如果找不到，顯示替代文字
                            const backgroundColor = '#CCCCCC';
                            const textColor = '#000000';
                            relatedPeopleHtml += `<span class="badge me-1 mb-1" style="background-color: ${backgroundColor}; color: ${textColor};">已刪除的相關人(${personId})</span>`;
                        }
                    });
                    relatedPeopleHtml += '</div>';
                }
                
                // 生成類別標籤HTML
                let categoriesHtml = '';
                if (caseItem.categories && caseItem.categories.length > 0) {
                    categoriesHtml = '<div class="mt-2 mb-2">';
                    caseItem.categories.forEach(categoryId => {
                        // 嘗試在當前的活躍類別列表中查找
                        const category = categories.find(c => c && c.id === categoryId);
                        
                        if (category) {
                            const backgroundColor = category.color || '#6c757d';
                            const textColor = getContrastColor(backgroundColor);
                            categoriesHtml += `<span class="badge me-1 mb-1" style="background-color: ${backgroundColor}; color: ${textColor};">${category.name}</span>`;
                                } else {
                                // 如果找不到，顯示替代文字
                            const backgroundColor = '#CCCCCC';
                            const textColor = '#000000';
                            categoriesHtml += `<span class="badge me-1 mb-1" style="background-color: ${backgroundColor}; color: ${textColor};">已刪除的類別(${categoryId})</span>`;
                        }
                    });
                    categoriesHtml += '</div>';
                }
                
                const card = document.createElement('div');
                card.className = 'card case-card mb-3';
                card.style.position = 'relative'; // 為了絕對定位星號圖標
                
                // 判斷是否為我的最愛
                const isFavorite = caseItem.isFavorite === true;
                
                card.innerHTML = `
                    <i class="bi bi-star-fill favorite-icon ${isFavorite ? 'active' : 'inactive'}" data-case-id="${caseItem.id}"></i>
                    <i class="bi bi-trash delete-icon" data-case-id="${caseItem.id}"></i>
                    <div class="card-body">
                        <h5 class="card-title">${caseItem.title} <span class="badge bg-success">已完成</span></h5>
                        <h6 class="card-subtitle mb-2 text-muted">${formatDateTime(caseItem.date)}</h6>
                        ${relatedPeopleHtml}
                        ${categoriesHtml}
                        <button class="btn btn-outline-secondary btn-sm view-completed-case" data-case-id="${caseItem.id}">查看詳情</button>
                        <button class="btn btn-outline-warning btn-sm cancel-completion" data-case-id="${caseItem.id}">取消完成</button>
                    </div>
                `;
                
                container.appendChild(card);
                
                // 為星號圖標添加點擊事件
                const favoriteIcon = card.querySelector('.favorite-icon');
                favoriteIcon.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    toggleFavorite(this.getAttribute('data-case-id'));
                });
                
                // 為刪除圖示添加點擊事件
                const deleteIcon = card.querySelector('.delete-icon');
                deleteIcon.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡，避免觸發卡片的點擊事件
                    showDeleteConfirmation('案件', this.getAttribute('data-case-id'), function(caseId) {
                        console.log(`確認刪除案件ID: ${caseId}`);
                        
                        // 顯示載入指示器
                        showLoading('正在刪除案件...');
                        
                        // 調用後端API標記案件為已刪除
                        google.script.run
                            .withSuccessHandler(function(response) {
                                hideLoading();
                                
                                try {
                                    const result = JSON.parse(response);
                                    
                                    if (result && result.success) {
                                        console.log(`案件 ${caseId} 已標記為刪除:`, result.message);
                                        
                                        // 從前端數據中移除已完成案件
                                        const completedCaseIndex = completedCases.findIndex(c => c.id === caseId);
                                        if (completedCaseIndex !== -1) {
                                            completedCases.splice(completedCaseIndex, 1);
                                        }
                                        
                                        const allCompletedCaseIndex = allCompletedCases.findIndex(c => c.id === caseId);
                                        if (allCompletedCaseIndex !== -1) {
                                            allCompletedCases.splice(allCompletedCaseIndex, 1);
                                        }
                                        
                                        // 重新渲染已完成案件列表
                                        renderCompletedCases();
                                        
                                        // 顯示通知
                                        showNotification('已完成案件已成功刪除！');
                                    } else {
                                        console.error('標記案件為已刪除失敗:', result);
                                        showNotification('刪除案件失敗：' + (result && result.error ? result.error : '未知錯誤'), '錯誤');
                                    }
                                } catch (e) {
                                    console.error('解析刪除案件回應時發生錯誤:', e);
                                    showNotification('處理伺服器回應時出錯', '錯誤');
                                }
                            })
                            .withFailureHandler(function(error) {
                                hideLoading();
                                console.error('與伺服器通訊失敗:', error);
                                showNotification('與伺服器通訊失敗：' + error, '錯誤');
                            })
                            .markCaseAsDeleted(sheetsId, caseId);
                    });
                });
                
                // 添加查看詳情按鈕事件
                card.querySelector('.view-completed-case').addEventListener('click', function() {
                    viewCompletedCaseDetails(this.getAttribute('data-case-id'));
                });
                
                // 添加取消完成按鈕事件
                card.querySelector('.cancel-completion').addEventListener('click', function() {
                    cancelCaseCompletion(this.getAttribute('data-case-id'));
                });
            });
        }
        
        // 提交案件到伺服器
        function submitCaseToServer(title, content, date, relatedPeople, categories, files, fileCount) {
            // 顯示相關人資訊
            console.log('準備提交案件，相關人資訊:', JSON.stringify(relatedPeople), '類型:', typeof relatedPeople, '長度:', relatedPeople.length);
            console.log('準備提交案件，類別資訊:', JSON.stringify(categories), '類型:', typeof categories, '長度:', categories.length);
            
            const loadingMessage = fileCount > 0 ? `正在儲存案件並上傳 ${fileCount} 個檔案...` : '正在儲存案件...';
            showLoading(loadingMessage);

            const fileInput = document.getElementById('case-files');
            if (fileCount > 0) {
                // 讀取文件內容
                let processedFiles = 0;
                const fileContents = [];

                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const fileType = file.type.startsWith('image/') ? 'image' : 'video';
                        
                        fileContents.push({
                            name: file.name,
                            type: fileType,
                            mimeType: file.type,
                            content: e.target.result
                        });

                        processedFiles++;
                        // 更新進度條
                        updateUploadProgress('case', processedFiles, fileCount);

                        if (processedFiles === fileCount) {
                            // 所有檔案都已處理，可以提交資料
                            const caseData = {
                                title: title,
                                content: content,
                                date: date,
                                relatedPeople: relatedPeople,
                                categories: categories,
                                files: fileContents
                            };
                            
                            console.log('完成處理所有檔案，準備提交案件資料');
                            console.log('案件資料中的相關人:', JSON.stringify(caseData.relatedPeople));
                            console.log('案件資料中的類別:', JSON.stringify(caseData.categories));
                            
                            submitCaseData(caseData);
                        }
                    };

                    reader.readAsDataURL(file);
                }
            } else {
                // 無檔案，直接提交
                const caseData = {
                    title: title,
                    content: content,
                    date: date,
                    relatedPeople: relatedPeople,
                    categories: categories,
                    files: []
                };
                
                submitCaseData(caseData);
            }
        }

        // 提交案件資料到伺服器
        function submitCaseData(caseData) {
            console.log('開始提交案件資料到伺服器');
            console.log('案件資料摘要:', {
                title: caseData.title,
                content: caseData.content.substring(0, 50) + (caseData.content.length > 50 ? '...' : ''),
                date: caseData.date,
                relatedPeople: JSON.stringify(caseData.relatedPeople),
                filesCount: caseData.files ? caseData.files.length : 0
            });
            
            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading();
                    hideUploadProgress('case'); // 隱藏進度條
                        
                    console.log('伺服器返回結果:', response);
                            
                    if (response && response.success) {
                        console.log('案件新增成功，案件ID:', response.caseId);
                        // 重新載入案件資料
                            loadData();
                        
                        // 重置表單
                        resetCaseForm();
                        
                        // 跳轉到案件列表
                        showPage('cases');
                        
                        // showNotification('案件已新增！'); // <<< 將此行註解掉
                        } else {
                        console.error('新增案件失敗:', response);
                        showNotification('新增案件失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    hideUploadProgress('case'); // 隱藏進度條
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .addCase(sheetsId, driveFolderId, caseData);
        }
        
        // 重置案件表單
        function resetCaseForm() {
            const titleElem = document.getElementById('case-title');
            const contentElem = document.getElementById('case-content');
            const relatedPersonInput = document.getElementById('related-person-input');
            const relatedPeopleCandidates = document.getElementById('related-people-candidates');
            const selectedRelatedPeople = document.getElementById('selected-related-people');
            const caseFiles = document.getElementById('case-files');
            const filePreviewContainer = document.getElementById('file-preview-container');
            
            // 檢查每個元素是否存在後再操作
            if (titleElem) titleElem.value = '';
            if (contentElem) contentElem.value = '';
            
            // 重置相關人選擇 (如果相關元素存在)
            if (relatedPersonInput) relatedPersonInput.value = '';
            if (relatedPeopleCandidates) relatedPeopleCandidates.innerHTML = '';
            if (selectedRelatedPeople) selectedRelatedPeople.innerHTML = '';
            
            // 清空檔案 (如果相關元素存在)
            if (caseFiles) caseFiles.value = '';
            if (filePreviewContainer) filePreviewContainer.innerHTML = '';
        }
        
        // 應用日期篩選
        function applyDateFilter() {
            const filterType = document.querySelector('input[name="date-filter-type"]:checked').value;
            let startDate, endDate, month;
            
            if (filterType === 'range') {
                startDate = document.getElementById('date-from').value;
                endDate = document.getElementById('date-to').value;
                
                if (!startDate || !endDate) {
                    showNotification('請選擇日期範圍', '錯誤');
                    return;
                }
            } else if (filterType === 'month') {
                month = document.getElementById('month-select').value;
                
                if (!month) {
                    showNotification('請選擇月份', '錯誤');
                    return;
                }
            }
            
            showLoading('正在篩選案件...');
            
            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading();
                    
                    if (response && response.success) {
                        // 更新案件列表
                        cases = response.cases || [];
                                renderCasesList();
                    } else {
                        showNotification('篩選案件失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .filterCasesByDate(sheetsId, filterType, startDate, endDate, month);
        }
        
        // 應用已完成案件日期篩選
        function applyCompletedDateFilter() {
            const filterType = document.querySelector('input[name="completed-date-filter-type"]:checked').value;
            let startDate, endDate, month;
            
            if (filterType === 'range') {
                startDate = document.getElementById('completed-date-from').value;
                endDate = document.getElementById('completed-date-to').value;
                
                if (!startDate || !endDate) {
                    showNotification('請選擇日期範圍', '錯誤');
                    return;
                }
            } else if (filterType === 'month') {
                month = document.getElementById('completed-month-select').value;
                
                if (!month) {
                    showNotification('請選擇月份', '錯誤');
                    return;
                }
            }
            
            showLoading('正在篩選案件...');
            
            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading();
                    
                    if (response && response.success) {
                        // 更新已完成案件列表
                        completedCases = response.cases || [];
                                renderCompletedCases();
                    } else {
                        showNotification('篩選案件失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .filterCompletedCasesByDate(sheetsId, filterType, startDate, endDate, month);
        }
        
        // 切換日期篩選顯示/隱藏
        function toggleDateFilter() {
            const filterContainer = document.getElementById('date-filter-container');
            filterContainer.classList.toggle('d-none');
        }
        
        // 切換已完成案件日期篩選顯示/隱藏
        function toggleCompletedDateFilter() {
            const filterContainer = document.getElementById('completed-date-filter-container');
            filterContainer.classList.toggle('d-none');
        }
        
        // 顯示載入中提示
        function showLoading(message) {
            // 檢查是否已存在載入中提示
            let loadingEl = document.getElementById('loading-indicator');
            
            if (!loadingEl) {
                loadingEl = document.createElement('div');
                loadingEl.id = 'loading-indicator';
                loadingEl.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-50';
                loadingEl.style.zIndex = '9999';
                
                loadingEl.innerHTML = `
                    <div class="bg-white p-4 rounded shadow">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary me-3" role="status">
                                <span class="visually-hidden">載入中...</span>
                    </div>
                            <div id="loading-message">${message || '載入中...'}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(loadingEl);
                        } else {
                document.getElementById('loading-message').textContent = message || '載入中...';
                loadingEl.classList.remove('d-none');
            }
        }
        
        // 隱藏載入中提示
        function hideLoading() {
            const loadingEl = document.getElementById('loading-indicator');
            if (loadingEl) {
                loadingEl.classList.add('d-none');
            }
        }

        // 顯示通知模態框替代alert
        function showNotification(message, title = '通知') {
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;
            notificationModal.show();
        }

        // 顯示刪除確認模態框
        function showDeleteConfirmation(itemType, itemId, callback) {
            const modalTitle = document.getElementById('notification-title');
            const modalBody = document.getElementById('notification-message');
            const modalFooter = document.getElementById('notification-modal').querySelector('.modal-footer');
            
            // 保存原始的確認按鈕以便稍後恢復
            const originalFooterContent = modalFooter.innerHTML;
            
            modalTitle.textContent = '確認刪除';
            modalBody.textContent = `您確定要刪除此${itemType}嗎?`;
            
            // 修改模態框底部的按鈕
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">確認刪除</button>
            `;
            
            // 添加確認按鈕事件監聽器
            document.getElementById('confirm-delete-btn').addEventListener('click', function() {
                // 隱藏確認視窗
                notificationModal.hide();
                
                // 執行回調函數
                if (typeof callback === 'function') {
                    callback(itemId);
                }
                
                // 還原模態框底部按鈕
                setTimeout(() => {
                    modalFooter.innerHTML = originalFooterContent;
                }, 300);
            });
            
            // 在模態框關閉時還原底部按鈕
            const modalElement = document.getElementById('notification-modal');
            modalElement.addEventListener('hidden.bs.modal', function onModalHidden() {
                modalFooter.innerHTML = originalFooterContent;
                modalElement.removeEventListener('hidden.bs.modal', onModalHidden);
            }, { once: true });
            
            // 顯示確認對話框
            notificationModal.show();
        }
        
        // 獲取當前頁面
        function getCurrentPage() {
            for (const [id, page] of Object.entries(pages)) {
                if (!page.classList.contains('d-none')) {
                    return id;
                }
            }
            return null;
        }

        // 查看已完成案件詳情
        function viewCompletedCaseDetails(caseId) {
            // 顯示載入中指示器
            showLoading();
            
            try {
                console.log('正在獲取案件詳情，案件ID：', caseId);
                console.log('使用的 sheetsId：', sheetsId);
                
                // 添加除錯信息來幫助診斷
                if (!sheetsId) {
                    console.error('錯誤：sheetsId 為空或未定義');
                    hideLoading();
                    showNotification('無法獲取案件詳情：sheetsId 未定義', '錯誤');
                    return;
                }
                
                if (!caseId) {
                    console.error('錯誤：caseId 為空或未定義');
                    hideLoading();
                    showNotification('無法獲取案件詳情：caseId 未定義', '錯誤');
                    return;
                }
                
                // 調用服務獲取詳細資料
                google.script.run
                    .withSuccessHandler(function(response) {
                        console.log('getCaseDetails 返回的響應：', response);
                        hideLoading();
                        
                        // 確保回傳的數據是對象格式
                        let parsedResponse = response;
                        if (typeof response === 'string') {
                            try {
                                parsedResponse = JSON.parse(response);
                                console.log('成功解析 JSON 響應：', parsedResponse);
                    } catch (e) {
                                console.error('無法解析 JSON 響應：', e);
                                showNotification('獲取案件詳情失敗：無法解析伺服器響應', '錯誤');
                                return;
                            }
                        }
                        
                        if (parsedResponse && parsedResponse.success && parsedResponse.caseDetails) {
                            const caseItem = parsedResponse.caseDetails;
                            
                            // 取得相關人員姓名
                            const relatedPeopleNames = caseItem.relatedPeople.map(pid => {
                                const person = people.find(p => p.id === pid);
                                return person ? person.name : '';
                            }).filter(Boolean).join(', ');
                            
                            // 創建模態框內容
                            const modalContent = `
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title">案件詳情 (已完成)</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="card border-0">
                    <div class="card-body">
                        <h5 class="card-title">${caseItem.title}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">${formatDateTime(caseItem.date)}</h6>
                                            <p class="card-text" style="white-space: pre-wrap;">${caseItem.content}</p>
                                            <div class="mb-3">
                                                <strong>相關人：</strong>
                                                <div class="d-flex flex-wrap mt-1">
                                                    ${caseItem.relatedPeople.map(pid => {
                                                        const person = people.find(p => p.id === pid);
                                                        if (!person) return '';
                                                        const backgroundColor = person.color || '#6c757d';
                                                        const textColor = getContrastColor(backgroundColor);
                                                        return `<span class="badge me-1 mb-1" style="background-color: ${backgroundColor}; color: ${textColor};">${person.name}</span>`;
                                                    }).join('')}
                                                </div>
                                            </div>
                                            ${caseItem.completedDate ? `<p><strong>完成日期：</strong>${formatDateTime(caseItem.completedDate)}</p>` : ''}
                                            ${caseItem.files && caseItem.files.length ? '<p><strong>附件：</strong></p>' : ''}
                                            <div id="case-file-previews" class="d-flex flex-wrap gap-2 mt-2"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5>處理進度</h5>
                                            <span class="sort-icon" id="completed-progress-sort">
                                                <i class="bi bi-sort-down"></i>
                                            </span>
                                        </div>
                                        <div id="progress-list" class="list-group mt-3">
                                            ${caseItem.progress && caseItem.progress.length > 0 ? '' : '<div class="list-group-item">此案件沒有記錄進度</div>'}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                    <button type="button" class="btn btn-warning cancel-completed-case-modal" data-case-id="${caseItem.id}">取消完成</button>
                    </div>
                `;
                
                            // 準備模態框
                            let detailsModal = document.getElementById('case-details-modal');
                            if (!detailsModal) {
                                detailsModal = document.createElement('div');
                                detailsModal.className = 'modal fade';
                                detailsModal.id = 'case-details-modal';
                                detailsModal.setAttribute('tabindex', '-1');
                                detailsModal.innerHTML = `
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(detailsModal);
                            }
                            
                            // 填充模態框內容
                            detailsModal.querySelector('.modal-content').innerHTML = modalContent;
                            
                            // 渲染檔案預覽
                            const filePreviewsContainer = detailsModal.querySelector('#case-file-previews');
                            if (filePreviewsContainer && caseItem.files && caseItem.files.length > 0) {
                                renderFileAttachments(caseItem.files, filePreviewsContainer);
                            }
                            
                            // 渲染進度列表 (獨立成函數以便重用)
                            function renderCompletedProgress(targetContainer, progressItems) {
                                targetContainer.innerHTML = ''; // 清空現有列表
                                if (!progressItems || progressItems.length === 0) {
                                    targetContainer.innerHTML = '<div class="list-group-item">此案件沒有記錄進度</div>';
                                    return;
                                }

                                // 根據 completedProgressSort 排序
                                const sortedProgress = [...progressItems].sort((a, b) => {
                                    const dateA = new Date(a.date);
                                    const dateB = new Date(b.date);
                                    return completedProgressSort === 'desc' ? dateB - dateA : dateA - dateB;
                                });

                                sortedProgress.forEach(progress => {
                                    const progressItem = document.createElement('div');
                                    progressItem.className = 'list-group-item';
                                    
                                    // 生成相關人標籤HTML
                                    let relatedPeopleHtml = '';
                                    if (progress.relatedPeople && progress.relatedPeople.length > 0) {
                                        relatedPeopleHtml = '<div class="mt-2 mb-2"><strong>相關人：</strong><div class="d-flex flex-wrap mt-1">';
                                        progress.relatedPeople.forEach(pid => {
                                            const person = people.find(p => p.id === pid);
                                            if (person) {
                                                const backgroundColor = person.color || '#6c757d';
                                                const textColor = getContrastColor(backgroundColor);
                                                relatedPeopleHtml += `<span class="badge me-1 mb-1" style="background-color: ${backgroundColor}; color: ${textColor};">${person.name}</span>`;
                                            }
                                        });
                                        relatedPeopleHtml += '</div></div>';
                                    }
                                    
                                    let progressContent = `
                                        <div class="d-flex justify-content-between align-items-top">
                                            <div class="w-100">
                                                <p style="white-space: pre-wrap;">${progress.content}</p>
                                                ${relatedPeopleHtml}
                                                <small class="text-muted">${formatDateTime(progress.date)}</small>
                                            </div>
                                        </div>
                                    `;
                                    
                                    // 如果有附件，顯示附件預覽
                                    if (progress.files && progress.files.length > 0) {
                                        progressContent += `<div class="progress-files mt-2"></div>`;
                                    }
                                    
                                    progressItem.innerHTML = progressContent;
                                    targetContainer.appendChild(progressItem);
                                    
                                    // 渲染附件預覽
                                    if (progress.files && progress.files.length > 0) {
                                        const filesContainer = progressItem.querySelector('.progress-files');
                                        if (filesContainer) {
                                            // **** 注意：這裡需要確保 renderFileAttachments 能正確渲染 iframe ****
                                            renderFileAttachments(progress.files, filesContainer); 
                                        }
                                    }
                                });
                            }
                            
                            // 初始渲染進度列表
                            const progressList = detailsModal.querySelector('#progress-list');
                            renderCompletedProgress(progressList, caseItem.progress);

                            // 綁定排序圖標事件
                            const sortIconElement = detailsModal.querySelector('#completed-progress-sort');
                            if (sortIconElement) {
                                // 更新圖標狀態
                                const iconClass = completedProgressSort === 'desc' ? 'bi-sort-down' : 'bi-sort-up';
                                sortIconElement.querySelector('i').className = `bi ${iconClass}`;

                                // 添加點擊事件監聽器 (如果尚未添加)
                                if (!sortIconElement.hasAttribute('data-listener-added')) {
                                    sortIconElement.addEventListener('click', function() {
                                        completedProgressSort = completedProgressSort === 'desc' ? 'asc' : 'desc';
                                        const newIconClass = completedProgressSort === 'desc' ? 'bi-sort-down' : 'bi-sort-up';
                                        this.querySelector('i').className = `bi ${newIconClass}`;
                                        // 重新渲染進度列表
                                        renderCompletedProgress(progressList, caseItem.progress);
                                    });
                                    sortIconElement.setAttribute('data-listener-added', 'true'); // 標記已添加監聽器
                                }
                            }
                            
                            // 綁定取消完成按鈕事件
                            const cancelCompletionButton = detailsModal.querySelector('.cancel-completed-case-modal');
                            if (cancelCompletionButton) {
                                cancelCompletionButton.addEventListener('click', function() {
                                    // 先關閉詳情模態框
                                    bootstrap.Modal.getInstance(detailsModal).hide();
                                    // 調用取消完成功能
                                    cancelCaseCompletion(this.getAttribute('data-case-id'));
                                });
                            }
                            
                            // 顯示模態框
                            const bsModal = new bootstrap.Modal(detailsModal);
                            bsModal.show();
                            
            } else {
                            showNotification('獲取案件詳情失敗: ' + (parsedResponse && parsedResponse.error ? parsedResponse.error : '未知錯誤'), '錯誤');
                        }
                    })
                    .withFailureHandler(function(error) {
                    hideLoading();
                        showNotification('與伺服器通訊失敗: ' + error, '錯誤');
                    })
                    .getCaseDetails(sheetsId, caseId);
            } catch (error) {
                console.error('獲取案件詳情時發生錯誤：', error);
                hideLoading();
                showNotification('獲取案件詳情失敗：' + error.message, '錯誤');
            }
        }

        // 取消案件完成狀態
        function cancelCaseCompletion(caseId) {
            // 找到對應的完成案件
            const caseIndex = completedCases.findIndex(c => c.id === caseId);
            if (caseIndex === -1) {
                showNotification('找不到指定案件', '錯誤');
                return;
            }
            
            // 顯示確認對話框
            document.getElementById('notification-title').textContent = '確認取消案件完成';
            document.getElementById('notification-message').textContent = '確定要將此案件恢復為進行中狀態？';
            
            // 獲取模態框底部按鈕區域並儲存原始內容
            const modalFooter = document.querySelector('#notification-modal .modal-footer');
            const originalFooterContent = modalFooter.innerHTML;
            
            // 修改底部按鈕
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-cancel-completion">確認</button>
            `;
            
            // 當使用者確認時，執行取消完成操作
            document.getElementById('confirm-cancel-completion').addEventListener('click', function() {
                notificationModal.hide();
                
                // 顯示載入提示
                showLoading('正在取消案件完成狀態...');
                
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response && response.success) {
                            // 從localStorage中移除已完成案件ID
                        let completedCaseIds = JSON.parse(localStorage.getItem('completedCaseIds') || '[]');
                            const idIndex = completedCaseIds.indexOf(caseId);
                            if (idIndex !== -1) {
                                completedCaseIds.splice(idIndex, 1);
                                localStorage.setItem('completedCaseIds', JSON.stringify(completedCaseIds));
                                console.log(`已從localStorage移除案件ID ${caseId}`);
                            }
                            
                            // 將案件從已完成移回進行中
                            const caseItem = completedCases[caseIndex];
                            
                            // 移除完成標記
                            delete caseItem.completed;
                            delete caseItem.completedDate;
                            
                            // 將案件添加回進行中列表
                            cases.push(caseItem);
                            
                            // 從已完成列表中移除
                            completedCases.splice(caseIndex, 1);
                            
                            // 重新渲染案件列表
                            renderCasesList();
                            renderCompletedCases();
                            
                            hideLoading();
                            // showNotification('案件已恢復為進行中狀態');
                        } else {
                            hideLoading();
                            showNotification('取消完成狀態失敗: ' + (response ? response.error : '未知錯誤'), '錯誤');
                        }
                        
                        // 還原模態框底部按鈕
                        modalFooter.innerHTML = originalFooterContent;
                })
                .withFailureHandler(function(error) {
                        // 還原模態框底部按鈕
                        modalFooter.innerHTML = originalFooterContent;
                        
                        hideLoading();
                        showNotification('與伺服器通訊失敗: ' + error, '錯誤');
                    })
                    .cancelCaseCompletion(sheetsId, caseId);
            });
            
            // 顯示確認對話框
            notificationModal.show();
        }

        // 更新上傳進度條
        function updateUploadProgress(type, current, total) {
            const containerId = type === 'case' ? 'case-upload-progress-container' : 'progress-upload-progress-container';
            const barId = type === 'case' ? 'case-upload-progress-bar' : 'progress-upload-progress-bar';
            const statusId = type === 'case' ? 'case-upload-status' : 'progress-upload-status';

            const container = document.getElementById(containerId);
            const bar = document.getElementById(barId);
            const status = document.getElementById(statusId);

            if (!container || !bar || !status) return;

            if (total > 0) {
                container.classList.remove('d-none'); // 顯示進度條
                const percentage = Math.round((current / total) * 100);
                bar.style.width = percentage + '%';
                bar.textContent = percentage + '%';
                bar.setAttribute('aria-valuenow', percentage);
                status.textContent = `正在讀取檔案 ${current} / ${total}...`;
            } else {
                // 如果沒有檔案，保持隱藏
                container.classList.add('d-none');
                status.textContent = '';
            }
        }

        // 隱藏上傳進度條
        function hideUploadProgress(type) {
             const containerId = type === 'case' ? 'case-upload-progress-container' : 'progress-upload-progress-container';
             const statusId = type === 'case' ? 'case-upload-status' : 'progress-upload-status';
             const container = document.getElementById(containerId);
             const status = document.getElementById(statusId);
             if(container) container.classList.add('d-none');
             if(status) status.textContent = '';
             // 重設進度條，以便下次使用
             const barId = type === 'case' ? 'case-upload-progress-bar' : 'progress-upload-progress-bar';
             const bar = document.getElementById(barId);
             if(bar) {
                 bar.style.width = '0%';
                 bar.textContent = '0%';
                 bar.setAttribute('aria-valuenow', 0);
             }
        }

        // 顯示上傳進度條
        function showUploadProgress(type) {
            const containerId = type === 'case' ? 'case-upload-progress-container' : 'progress-upload-progress-container';
            const barId = type === 'case' ? 'case-upload-progress-bar' : 'progress-upload-progress-bar';
            const statusId = type === 'case' ? 'case-upload-status' : 'progress-upload-status';
            
            const container = document.getElementById(containerId);
            const bar = document.getElementById(barId);
            const status = document.getElementById(statusId);
            
            if (!container || !bar || !status) return;
            
            // 顯示進度條容器
            container.classList.remove('d-none');
            
            // 初始化進度條和狀態文字
            bar.style.width = '0%';
            bar.textContent = '0%';
            bar.setAttribute('aria-valuenow', 0);
            status.textContent = '準備上傳檔案...';
        }

        // 移除createPersonDirectly函數的實現
        function createPersonDirectly(inputElement) {
            if (!inputElement) return;
            
            const personName = inputElement.value.trim();
            
            if (!personName) {
                showNotification('請輸入相關人姓名', '錯誤');
                return;
            }
            
            showLoading('正在新增相關人...');
            
            google.script.run
                .withSuccessHandler(function(stringResponse) {
                    hideLoading();
                    
                    let response;
                    try {
                        response = JSON.parse(stringResponse);
                    } catch (e) {
                        console.error('解析新增相關人回應時發生錯誤:', e);
                        showNotification('處理伺服器回應時出錯', '錯誤');
                        return;
                    }
                    
                    if (response && response.success) {
                        // 添加到全局變數
                        const newPerson = response.person;
                        const existingIndex = people.findIndex(p => p.id === newPerson.id);
                        
                        if (existingIndex !== -1) {
                            // 更新存在的相關人
                            people[existingIndex] = newPerson;
                        } else {
                            // 添加新相關人
                            people.push(newPerson);
                        }
                        
                        // 判斷來源類型
                        const isCase = inputElement.id === 'related-person-input';
                        const targetId = isCase ? 'selected-related-people' : 'selected-progress-people';
                        
                        // 選擇新增的相關人
                        selectPerson(newPerson, targetId);
                        
                        // 清空輸入框和候選列表
                        inputElement.value = '';
                        const candidatesId = isCase ? 'related-people-candidates' : 'progress-people-candidates';
                        document.getElementById(candidatesId).innerHTML = '';
                        
                        // showNotification('相關人已新增！');
                    } else {
                        showNotification('新增相關人失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .addPerson(sheetsId, { name: personName });
        }

        // ==================== 相關人功能 ====================
        
        // 渲染相關人列表（設定頁面）
        function renderPeopleList() {
            console.log('renderPeopleList被調用 - 但相關人管理功能已被移除');
            // 此函數保留但內容為空，因為設定頁面中的相關人管理已被移除
            // 保留此函數是為了確保其他調用不會出錯
        }
        
        // 處理拖曳開始
        function handleDragStart(e) {
            e.dataTransfer.setData('personId', e.target.dataset.personId);
            e.dataTransfer.effectAllowed = 'move';
            e.target.classList.add('dragging');
        }
        
        // 設置拖放區域
        function setupDropZones() {
            const dropZones = document.querySelectorAll('.droppable-area');
            
            dropZones.forEach(zone => {
                // 移除之前可能附加的事件，避免重複
                zone.removeEventListener('dragover', handleDragOver);
                zone.removeEventListener('dragenter', handleDragEnter);
                zone.removeEventListener('dragleave', handleDragLeave);
                zone.removeEventListener('drop', handleDrop);
                
                // 添加新的事件處理
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });
        }
        
        // 拖曳經過目標
        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        // 拖曳進入目標
        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }
        
        // 拖曳離開目標
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        // 拖曳放置
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            this.classList.remove('drag-over');
            const personId = e.dataTransfer.getData('personId');
            const personElement = document.querySelector(`.person-tag[data-person-id="${personId}"]`);
            
            if (personElement) {
                personElement.classList.remove('dragging');
                
                // 確定拖放的目標區域
                const targetArea = e.currentTarget.id;
                const isMovingToInactive = targetArea === 'inactive-people-list';
                
                // 獲取相關人物件
                const person = people.find(p => p.id === personId);
                if (person) {
                    // 根據目標更改相關人狀態
                    if (isMovingToInactive) {
                        // 移動到非活躍區域
                        removePerson(personId);
                    } else {
                        // 移動到活躍區域
                        restorePerson(personId);
                    }
                }
            }
            
            return false;
        }
        
        // 刪除相關人確認
        function deletePersonConfirmation(person) {
            // 確保名稱是字串類型
            const personName = person.name ? String(person.name) : '未命名';
            
            // 顯示確認對話框
            if (confirm(`確定要隱藏相關人「${personName}」嗎？此操作可以在「已隱藏相關人」中恢復。`)) {
                hidePersonPermanently(person.id);
            }
        }
        
        // 隱藏相關人（替代原來的deletePerson函數）
        function hidePersonPermanently(personId) {
            if (!personId) {
                showNotification('無效的相關人 ID', '錯誤');
                return;
            }
            
            showLoading('正在隱藏相關人...');
            
            google.script.run
                .withSuccessHandler(function(stringResponse) {
                    hideLoading();
                    
                    let response;
                    try {
                        response = JSON.parse(stringResponse);
                    } catch (e) {
                        console.error('解析隱藏相關人回應時發生錯誤:', e);
                        showNotification('處理伺服器回應時出錯', '錯誤');
                        return;
                    }
                    
                    if (response && response.success) {
                        // 更新本地數據
                        const personIndex = people.findIndex(p => p && p.id === personId);
                        if (personIndex !== -1) {
                            people[personIndex].isActive = false;
                        }
                        
                        // 重新渲染相關人列表
                        renderPeopleList();
                        
                        showNotification('相關人已隱藏！');
                    } else {
                        showNotification('隱藏相關人失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .removePerson(sheetsId, personId);
        }
        
        // 創建相關人標籤
        function createPersonTag(person, isActive) {
            const tag = document.createElement('span');
            tag.className = 'person-tag';
            tag.dataset.personId = person.id;
            tag.style.backgroundColor = person.color;
            tag.style.color = getContrastColor(person.color);
            
            if (isActive) {
                tag.innerHTML = `
                    ${person.name}
                    <i class="bi bi-x-circle" style="cursor: pointer; margin-left: 4px;" title="隱藏此相關人"></i>
                `;
                
                // 添加點擊事件，隱藏相關人
                const removeIcon = tag.querySelector('.bi-x-circle');
                if (removeIcon) {
                    removeIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        removePerson(person.id);
                    });
                }
            } else {
                tag.innerHTML = `
                    ${person.name}
                    <i class="bi bi-plus-circle" style="cursor: pointer; margin-left: 4px;" title="恢復此相關人"></i>
                `;
                
                // 添加點擊事件，恢復相關人
                const addIcon = tag.querySelector('.bi-plus-circle');
                if (addIcon) {
                    addIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        restorePerson(person.id);
                    });
                }
                
                // 為非活躍標籤添加不透明度
                tag.style.opacity = '0.6';
            }
            
            return tag;
        }
        
        // 創建可選擇的相關人標籤（用於案件和進度表單）
        function createSelectablePersonTag(person, targetContainerId) {
            const tag = document.createElement('span');
            tag.className = 'person-tag';
            tag.dataset.personId = person.id;
            tag.style.backgroundColor = person.color;
            tag.style.color = getContrastColor(person.color);
            tag.textContent = person.name;
            tag.style.cursor = 'pointer';
            
            // 添加點擊事件，選中該相關人
            tag.addEventListener('click', function() {
                selectPerson(person, targetContainerId);
            });
            
            return tag;
        }
        
        // 創建已選擇的相關人標籤
        function createSelectedPersonTag(person, targetContainerId) {
            const tag = document.createElement('span');
            tag.className = 'person-tag';
            tag.dataset.personId = person.id;
            tag.style.backgroundColor = person.color;
            tag.style.color = getContrastColor(person.color);
            
            tag.innerHTML = `
                ${person.name}
                <i class="bi bi-x-circle" style="cursor: pointer; margin-left: 4px;"></i>
            `;
            
            // 添加點擊事件，移除選擇
            const removeIcon = tag.querySelector('.bi-x-circle');
            if (removeIcon) {
                removeIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // 移除選擇的相關人
                    tag.remove();
                    
                    // 重新啟用搜尋結果中的相應標籤
                    const candidatesId = targetContainerId === 'selected-related-people' 
                        ? 'related-people-candidates' 
                        : 'progress-people-candidates';
                    
                    const candidates = document.getElementById(candidatesId);
                    if (candidates) {
                        const candidate = Array.from(candidates.children).find(c => c.dataset.personId === person.id);
                        if (candidate) {
                            candidate.classList.remove('d-none');
                        }
                    }
                });
            }
            
            return tag;
        }
        
        // 選擇相關人
        function selectPerson(person, targetContainerId) {
            const selectedContainer = document.getElementById(targetContainerId);
            if (!selectedContainer) return;
            
            // 檢查是否已選擇該相關人
            const existingTag = Array.from(selectedContainer.children).find(tag => tag.dataset.personId === person.id);
            if (existingTag) return;
            
            // 創建已選擇的相關人標籤
            const tag = createSelectedPersonTag(person, targetContainerId);
            selectedContainer.appendChild(tag);
            
            // 隱藏搜尋結果中的相應標籤
            const candidatesId = targetContainerId === 'selected-related-people' 
                ? 'related-people-candidates' 
                : 'progress-people-candidates';
            
            const candidates = document.getElementById(candidatesId);
            if (candidates) {
                const candidate = Array.from(candidates.children).find(c => c.dataset.personId === person.id);
                if (candidate) {
                    candidate.classList.add('d-none');
                }
            }
            
            // 清空搜尋框
            const inputId = targetContainerId === 'selected-related-people' 
                ? 'related-person-input' 
                : 'progress-person-input';
            
            document.getElementById(inputId).value = '';
            document.getElementById(candidatesId).innerHTML = '';
        }
        
        // 案件表單中的相關人搜尋
        function searchRelatedPeople(query) {
            console.log(`搜尋案件相關人: "${query}"`);
            displayPeopleCandidates(query, 'case');
        }
        
        // 進度表單中的相關人搜尋
        function searchProgressPeople(query) {
            console.log(`搜尋進度相關人: "${query}"`);
            displayPeopleCandidates(query, 'progress');
        }
        
        // 打開新增相關人模態框
        function openAddPersonModal(type, initialName = '') {
            console.log(`打開新增相關人模態框 (${type})${initialName ? '，初始姓名: ' + initialName : ''}`);
            
            // 設置模態框標題
            document.getElementById('person-name').value = initialName;
            
            // 保存相關人的目標類型（案件或進度）
            document.getElementById('add-person-modal').dataset.targetType = type;
            
            // 顯示模態框
            const modal = new bootstrap.Modal(document.getElementById('add-person-modal'));
            modal.show();
        }
        
        // 保存新相關人
        function savePerson() {
            const personName = document.getElementById('person-name').value.trim();
            const targetType = document.getElementById('add-person-modal').dataset.targetType;
            
            console.log(`保存新相關人: "${personName}", 目標類型: ${targetType}`);
            
            if (!personName) {
                console.warn('相關人姓名為空，無法保存');
                showNotification('請輸入相關人姓名', '錯誤');
                return;
            }
            
            // 檢查是否已存在活躍的同名相關人
            const existingActivePerson = people.find(p => p && p.name === personName && p.isActive !== false);
            if (existingActivePerson) {
                console.warn(`已存在同名相關人: ${existingActivePerson.name} (${existingActivePerson.id})`);
                showNotification('已存在同名相關人', '錯誤');
                return;
            }
            
            // 檢查是否存在非活躍的同名相關人
            const existingInactivePerson = people.find(p => p && p.name === personName && p.isActive === false);
            if (existingInactivePerson) {
                console.log(`找到同名非活躍相關人: ${existingInactivePerson.name} (${existingInactivePerson.id})，將嘗試恢復`);
                showLoading('正在恢復相關人...');
                
                // 關閉相關人模態框
                const personModal = bootstrap.Modal.getInstance(document.getElementById('add-person-modal'));
                if (personModal) {
                    personModal.hide();
                }
                
                // 恢復非活躍相關人
                google.script.run
                    .withSuccessHandler(function(stringResponse) {
                        hideLoading();
                        
                        let response;
                        try {
                            response = JSON.parse(stringResponse);
                        } catch (e) {
                            console.error('解析恢復相關人回應時發生錯誤:', e);
                            showNotification('處理伺服器回應時出錯', '錯誤');
                            return;
                        }
                        
                        if (response && response.success) {
                        // 更新本地資料
                            const personIndex = people.findIndex(p => p && p.id === existingInactivePerson.id);
                            if (personIndex !== -1) {
                                people[personIndex].isActive = true;
                                console.log(`已將相關人 ${existingInactivePerson.name} (${existingInactivePerson.id}) 恢復為活躍`);
                                
                                // 將恢復的相關人添加到相應區域
                                if (targetType) {
                                    addPersonTag(people[personIndex], targetType);
                                }
                                
                                showNotification(`已恢復相關人「${existingInactivePerson.name}」`);
                            }
                        } else {
                            console.error('恢復相關人失敗:', response ? response.error : '未知錯誤');
                            showNotification('恢復相關人失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                            // 如果恢復失敗，嘗試創建新相關人
                            createNewRelatedPersonFromModal(personName, targetType);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                    console.error('與伺服器通訊失敗:', error);
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                        // 如果通訊失敗，嘗試創建新相關人
                        createNewRelatedPersonFromModal(personName, targetType);
                    })
                    .updatePerson(sheetsId, existingInactivePerson.id, { isActive: true });
                
                return;
            }
            
            // 如果沒有同名相關人（包括活躍和非活躍），則建立新相關人
            createNewRelatedPersonFromModal(personName, targetType);
        }
        
        // 從模態框建立新相關人
        function createNewRelatedPersonFromModal(personName, targetType) {
            showLoading('正在新增相關人...');
            
            const personData = {
                name: personName
            };
            
            // 關閉相關人模態框
            const personModal = bootstrap.Modal.getInstance(document.getElementById('add-person-modal'));
            if (personModal) {
                personModal.hide();
            }
            
            google.script.run
                .withSuccessHandler(function(stringResponse) {
                    hideLoading();
                    
                    try {
                        const response = JSON.parse(stringResponse);
                        
                        if (response && response.success) {
                            // 添加到本地相關人列表
                            if (!people) people = [];
                            people.push(response.person);
                            console.log('新相關人已添加:', response.person);
                            
                            // 將新相關人添加為標籤
                            if (targetType) {
                                console.log(`添加新相關人 ${response.person.name} (${response.person.id}) 到${targetType === 'case' ? '案件' : '進度'}標籤`);
                                addPersonTag(response.person, targetType);
                            }
                            
                            // 顯示通知
                            showNotification(`已新增相關人「${personName}」`);
                        } else {
                            console.error('新增相關人失敗:', response.error);
                            showNotification('新增相關人失敗：' + (response.error || '未知錯誤'), '錯誤');
                        }
                    } catch (error) {
                        console.error('解析新增相關人回應時發生錯誤:', error);
                        showNotification('處理伺服器回應時發生錯誤', '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    console.error('與伺服器通訊失敗:', error);
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .addPerson(sheetsId, personData);
        }
        
        // 直接創建相關人
        function addNewPerson(name) {
            console.log(`addNewPerson被調用但相關人管理功能已被移除，參數name: "${name}"`);
            // 此函數保留但內容為空，因為設定頁面中的相關人管理已被移除
        }
        
        // 隱藏相關人
        function removePerson(personId) {
            if (!personId) {
                showNotification('無效的相關人 ID', '錯誤');
                return;
            }
            
            showLoading('正在隱藏相關人...');
            
            google.script.run
                .withSuccessHandler(function(stringResponse) {
                    hideLoading();
                    
                    let response;
                    try {
                        response = JSON.parse(stringResponse);
                    } catch (e) {
                        console.error('解析隱藏相關人回應時發生錯誤:', e);
                        showNotification('處理伺服器回應時出錯', '錯誤');
                        return;
                    }
                    
                    if (response && response.success) {
                        // 更新本地數據
                        const personIndex = people.findIndex(p => p && p.id === personId);
                        if (personIndex !== -1) {
                            people[personIndex].isActive = false;
                        }
                        
                        // 重新渲染相關人列表
                            renderPeopleList();
                        
                        showNotification('相關人已隱藏！');
                        } else {
                        showNotification('隱藏相關人失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .hidePerson(sheetsId, personId);
        }
        
        // 恢復相關人
        function restorePerson(personId) {
            if (!personId) {
                showNotification('無效的相關人 ID', '錯誤');
                return;
            }
            
            showLoading('正在恢復相關人...');
            
            google.script.run
                .withSuccessHandler(function(stringResponse) {
                    hideLoading();
                    
                    let response;
                    try {
                        response = JSON.parse(stringResponse);
                    } catch (e) {
                        console.error('解析恢復相關人回應時發生錯誤:', e);
                        showNotification('處理伺服器回應時出錯', '錯誤');
                        return;
                    }
                    
                    if (response && response.success) {
                        // 更新本地數據
                        const personIndex = people.findIndex(p => p && p.id === personId);
                        if (personIndex !== -1) {
                            people[personIndex].isActive = true;
                        }
                        
                        // 重新渲染相關人列表
                        renderPeopleList();
                        
                        showNotification('相關人已恢復！');
                    } else {
                        showNotification('恢復相關人失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .restorePerson(sheetsId, personId);
        }

        // ==================== 相關人標籤輸入功能 ====================
        
        // 初始化標籤輸入功能
        function initTagInputs() {
            console.log('初始化標籤輸入功能...');
            console.log('目前相關人數據:', people);
            console.log('目前類別數據:', categories);
            
            // 初始化相關人標籤輸入
            initPersonTagInputs();
            
            // 初始化類別標籤輸入
            initCategoryTagInputs();
            
            console.log('標籤輸入功能初始化完成');
        }
        
        // 初始化相關人標籤輸入
        function initPersonTagInputs() {
            // 案件標籤輸入功能
            const caseTagContainer = document.getElementById('case-tag-container');
            const caseTagsArea = document.getElementById('case-tags-area');
            const relatedPersonInput = document.getElementById('related-person-input');
            const relatedPeopleCandidates = document.getElementById('related-people-candidates');
            
            if (caseTagContainer && caseTagsArea && relatedPersonInput && relatedPeopleCandidates) {
                console.log('找到案件相關人標籤相關DOM元素');
                
                // 點擊容器時聚焦輸入框
                caseTagContainer.addEventListener('click', function(e) {
                    if (e.target === caseTagContainer || e.target === caseTagsArea) {
                        relatedPersonInput.focus();
                    }
                });
                
                // 當輸入框獲得焦點時顯示候選人列表
                relatedPersonInput.addEventListener('focus', function() {
                    console.log('案件-相關人輸入框獲得焦點');
                    displayPeopleCandidates(relatedPersonInput.value, 'case');
                });
                
                // 當輸入框失去焦點時隱藏候選人列表，但延遲執行，以便可以先點擊候選項
                relatedPersonInput.addEventListener('blur', function() {
                    console.log('案件-相關人輸入框失去焦點');
                                setTimeout(() => {
                        relatedPeopleCandidates.style.display = 'none';
                    }, 200);
                });
                
                // 輸入時篩選和顯示候選項
                relatedPersonInput.addEventListener('input', function() {
                    console.log('案件-相關人輸入內容變更:', this.value);
                    displayPeopleCandidates(this.value, 'case');
                });
                
                // 按下Enter鍵時，如果有匹配的候選項則添加第一個
                relatedPersonInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        console.log('案件-相關人輸入按下Enter鍵');
                        const firstCandidate = relatedPeopleCandidates.querySelector('.tag-suggestion-item');
                        if (firstCandidate) {
                        e.preventDefault();
                            firstCandidate.click();
                        }
                    }
                });
                            } else {
                console.warn('未找到案件相關人標籤相關DOM元素!');
                if (!caseTagContainer) console.warn('未找到 case-tag-container');
                if (!caseTagsArea) console.warn('未找到 case-tags-area');
                if (!relatedPersonInput) console.warn('未找到 related-person-input');
                if (!relatedPeopleCandidates) console.warn('未找到 related-people-candidates');
            }
            
            // 進度標籤輸入功能
            const progressTagContainer = document.getElementById('progress-tag-container');
            const progressTagsArea = document.getElementById('progress-tags-area');
            const progressPersonInput = document.getElementById('progress-person-input');
            const progressPeopleCandidates = document.getElementById('progress-people-candidates');
            
            if (progressTagContainer && progressTagsArea && progressPersonInput && progressPeopleCandidates) {
                console.log('找到進度相關人標籤相關DOM元素');
                
                // 點擊容器時聚焦輸入框
                progressTagContainer.addEventListener('click', function(e) {
                    if (e.target === progressTagContainer || e.target === progressTagsArea) {
                        progressPersonInput.focus();
                    }
                });
                
                // 當輸入框獲得焦點時顯示候選人列表
                progressPersonInput.addEventListener('focus', function() {
                    console.log('進度-相關人輸入框獲得焦點');
                    displayPeopleCandidates(progressPersonInput.value, 'progress');
                });
                
                // 當輸入框失去焦點時隱藏候選人列表，但延遲執行，以便可以先點擊候選項
                progressPersonInput.addEventListener('blur', function() {
                    console.log('進度-相關人輸入框失去焦點');
                    setTimeout(() => {
                        progressPeopleCandidates.style.display = 'none';
                    }, 200);
                });
                
                // 輸入時篩選和顯示候選項
                progressPersonInput.addEventListener('input', function() {
                    console.log('進度-相關人輸入內容變更:', this.value);
                    displayPeopleCandidates(this.value, 'progress');
                });
                
                // 按下Enter鍵時，如果有匹配的候選項則添加第一個
                progressPersonInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        console.log('進度-相關人輸入按下Enter鍵');
                        const firstCandidate = progressPeopleCandidates.querySelector('.tag-suggestion-item');
                        if (firstCandidate) {
                        e.preventDefault();
                            firstCandidate.click();
                        }
                    }
                });
            } else {
                console.warn('未找到進度相關人標籤相關DOM元素!');
                if (!progressTagContainer) console.warn('未找到 progress-tag-container');
                if (!progressTagsArea) console.warn('未找到 progress-tags-area');
                if (!progressPersonInput) console.warn('未找到 progress-person-input');
                if (!progressPeopleCandidates) console.warn('未找到 progress-people-candidates');
            }
        }
        
        // 初始化類別標籤輸入
        function initCategoryTagInputs() {
            // 案件類別標籤輸入功能
            const caseCategoryContainer = document.getElementById('case-category-container');
            const caseCategoriesArea = document.getElementById('case-categories-area');
            const categoryInput = document.getElementById('category-input');
            const categoriesCandidates = document.getElementById('categories-candidates');
            
            if (caseCategoryContainer && caseCategoriesArea && categoryInput && categoriesCandidates) {
                console.log('找到案件類別標籤相關DOM元素');
                
                // 點擊容器時聚焦輸入框
                caseCategoryContainer.addEventListener('click', function(e) {
                    if (e.target === caseCategoryContainer || e.target === caseCategoriesArea) {
                        categoryInput.focus();
                    }
                });
                
                // 當輸入框獲得焦點時顯示候選類別列表
                categoryInput.addEventListener('focus', function() {
                    console.log('案件-類別輸入框獲得焦點');
                    displayCategoriesCandidates(categoryInput.value, 'case');
                });
                
                // 當輸入框失去焦點時隱藏候選類別列表，但延遲執行，以便可以先點擊候選項
                categoryInput.addEventListener('blur', function() {
                    console.log('案件-類別輸入框失去焦點');
                    setTimeout(() => {
                        categoriesCandidates.style.display = 'none';
                    }, 200);
                });
                
                // 輸入時篩選和顯示候選項
                categoryInput.addEventListener('input', function() {
                    console.log('案件-類別輸入內容變更:', this.value);
                    displayCategoriesCandidates(this.value, 'case');
                });
                
                // 按下Enter鍵時，如果有匹配的候選項則添加第一個
                categoryInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        console.log('案件-類別輸入按下Enter鍵');
                        const firstCandidate = categoriesCandidates.querySelector('.tag-suggestion-item');
                        if (firstCandidate) {
                            e.preventDefault();
                            firstCandidate.click();
                        }
                    }
                });
            } else {
                console.warn('未找到案件類別標籤相關DOM元素!');
                if (!caseCategoryContainer) console.warn('未找到 case-category-container');
                if (!caseCategoriesArea) console.warn('未找到 case-categories-area');
                if (!categoryInput) console.warn('未找到 category-input');
                if (!categoriesCandidates) console.warn('未找到 categories-candidates');
            }
        }
        
        // 顯示相關人候選列表
        function displayPeopleCandidates(query, type) {
            console.log(`顯示${type === 'case' ? '案件' : '進度'}相關人候選列表，查詢: "${query}"`);
            
            // 檢查people陣列是否有效
            if (!people || !Array.isArray(people)) {
                console.error('相關人資料無效:', people);
                return;
            }
            
            console.log(`當前相關人資料: ${people.length}個項目`);
            
            const container = type === 'case' ? 
                document.getElementById('related-people-candidates') : 
                document.getElementById('progress-people-candidates');
            
            if (!container) {
                console.error(`找不到${type === 'case' ? '案件' : '進度'}相關人候選容器!`);
                return;
            }
            
            // 篩選活躍的相關人
            const activePeople = people.filter(p => p && p.isActive !== false);
            console.log(`篩選後的活躍相關人: ${activePeople.length}個`);
            
            // 篩選匹配查詢的相關人
            const lowerQuery = query.toLowerCase();
            let matchedPeople = activePeople;
            
            if (lowerQuery) {
                matchedPeople = activePeople.filter(p => 
                    p && p.name && typeof p.name === 'string' && p.name.toLowerCase().includes(lowerQuery) ||
                    p && p.name && String(p.name).toLowerCase().includes(lowerQuery)
                );
            }
            
            console.log(`匹配查詢的相關人: ${matchedPeople.length}個`);
            console.log('匹配的相關人:', matchedPeople);
            
            // 獲取已選擇的相關人ID
            const tagsArea = type === 'case' ? 
                document.getElementById('case-tags-area') : 
                document.getElementById('progress-tags-area');
            
            const selectedIds = [];
            if (tagsArea) {
                tagsArea.querySelectorAll('.inline-tag').forEach(tag => {
                    const id = tag.dataset.personId;
                    if (id) selectedIds.push(id);
                });
            }
            console.log(`已選擇的相關人IDs: ${selectedIds.join(', ')}`);
            
            // 從匹配列表中移除已選擇的相關人
            matchedPeople = matchedPeople.filter(p => !selectedIds.includes(p.id));
            console.log(`排除已選擇後的相關人: ${matchedPeople.length}個`);
            
            // 清空並填充候選列表
            container.innerHTML = '';
            
            if (matchedPeople.length > 0) {
                matchedPeople.forEach(person => {
                    // 確保名稱是字串類型
                    const personName = person.name ? String(person.name) : '未命名';
                    
                    const item = document.createElement('div');
                    item.className = 'tag-suggestion-item';
                    item.innerHTML = `
                        <span class="person-tag" style="background-color: ${person.color}; color: ${getContrastColor(person.color)};">
                            ${personName}
                            <span class="person-delete-icon">×</span>
                        </span>
                    `;
                    
                    item.addEventListener('click', function(e) {
                        // 檢查是否點擊了刪除按鈕
                        if (e.target.classList.contains('person-delete-icon')) {
                            e.stopPropagation(); // 阻止冒泡，避免觸發父元素的點擊事件
                            console.log(`點擊了刪除相關人按鈕: ${personName} (${person.id})`);
                            deleteRelatedPerson(person, type, item);
                            return;
                        }
                        
                        console.log(`選擇了相關人: ${personName} (${person.id})`);
                        addPersonTag(person, type);
                        
                        // 清空輸入框並隱藏候選列表
                        const input = type === 'case' ? 
                            document.getElementById('related-person-input') : 
                            document.getElementById('progress-person-input');
                        
                        if (input) {
                            input.value = '';
                            input.focus();
                        }
                        
                        container.style.display = 'none';
                    });
                    
                    container.appendChild(item);
                });
                
                // 添加「新增相關人」選項
                const addNewItem = document.createElement('div');
                addNewItem.className = 'create-tag-option';
                addNewItem.textContent = `+ 新增相關人 "${query}"`;
                addNewItem.addEventListener('click', function() {
                    console.log(`點擊了新增相關人選項: "${query}"`);
                    // 直接新增相關人，而不是彈出模態框
                    directlyAddNewPerson(query, type);
                    container.style.display = 'none';
                });
                
                if (query.trim()) {
                    container.appendChild(addNewItem);
                }
                
                container.style.display = 'block';
            } else if (query.trim()) {
                // 如果沒有匹配項但有輸入查詢，顯示「新增相關人」選項
                const addNewItem = document.createElement('div');
                addNewItem.className = 'create-tag-option';
                addNewItem.textContent = `+ 新增相關人 "${query}"`;
                addNewItem.addEventListener('click', function() {
                    console.log(`點擊了新增相關人選項: "${query}"`);
                    // 直接新增相關人，而不是彈出模態框
                    directlyAddNewPerson(query, type);
                    container.style.display = 'none';
                });
                
                container.appendChild(addNewItem);
                container.style.display = 'block';
            } else {
                // 如果沒有匹配項且沒有輸入查詢，顯示所有活躍相關人
                if (activePeople.length > 0) {
                    activePeople.forEach(person => {
                        if (!selectedIds.includes(person.id)) {
                            // 確保名稱是字串類型
                            const personName = person.name ? String(person.name) : '未命名';
                            
                            const item = document.createElement('div');
                            item.className = 'tag-suggestion-item';
                            item.innerHTML = `
                                <span class="person-tag" style="background-color: ${person.color}; color: ${getContrastColor(person.color)};">
                                    ${personName}
                                    <span class="person-delete-icon">×</span>
                                </span>
                            `;
                            
                            item.addEventListener('click', function(e) {
                                // 檢查是否點擊了刪除按鈕
                                if (e.target.classList.contains('person-delete-icon')) {
                                    e.stopPropagation(); // 阻止冒泡，避免觸發父元素的點擊事件
                                    console.log(`點擊了刪除相關人按鈕: ${personName} (${person.id})`);
                                    deleteRelatedPerson(person, type, item);
                                    return;
                                }
                                
                                console.log(`選擇了相關人: ${personName} (${person.id})`);
                                addPersonTag(person, type);
                                
                                // 清空輸入框並隱藏候選列表
                                const input = type === 'case' ? 
                                    document.getElementById('related-person-input') : 
                                    document.getElementById('progress-person-input');
                                
                                if (input) {
                                    input.value = '';
                                    input.focus();
                                }
                                
                                container.style.display = 'none';
                            });
                            
                            container.appendChild(item);
                        }
                    });
                    
                    if (container.children.length > 0) {
                        container.style.display = 'block';
                    } else {
                        container.style.display = 'none';
                    }
                } else {
                    container.style.display = 'none';
                }
            }
        }

        // 添加相關人標籤
        function addPersonTag(person, type) {
            console.log(`添加相關人標籤 (${type}): ${person.name} (${person.id})`);
            
            // 確保名稱是字串類型
            const personName = person.name ? String(person.name) : '未命名';
            
            const tagsArea = type === 'case' ? 
                document.getElementById('case-tags-area') : 
                document.getElementById('progress-tags-area');
            
            if (!tagsArea) {
                console.error(`找不到${type === 'case' ? '案件' : '進度'}標籤區域元素!`);
                return;
            }
            
            // 檢查是否已存在相同的標籤
            const existingTag = Array.from(tagsArea.querySelectorAll('.inline-tag')).find(
                tag => tag.dataset.personId === person.id
            );
            
            if (existingTag) {
                console.log(`相關人 ${personName} (${person.id}) 已在選擇列表中`);
                return;
            }
            
            // 創建新標籤
            const tag = document.createElement('span');
            tag.className = 'inline-tag';
            tag.dataset.personId = person.id;
            tag.style.backgroundColor = person.color;
            tag.style.color = getContrastColor(person.color);
            tag.innerHTML = `
                ${personName}
                <span class="tag-remove">&times;</span>
            `;
            
            // 添加刪除標籤的事件監聽器
            tag.querySelector('.tag-remove').addEventListener('click', function(e) {
                e.stopPropagation();
                console.log(`移除相關人標籤: ${personName} (${person.id})`);
                tag.remove();
            });
            
            // 添加到標籤區域
            tagsArea.appendChild(tag);
            console.log(`已添加相關人標籤: ${personName} (${person.id})`);
        }
        
        // 顯示所有活躍的相關人
        function showAllRelatedPeople(type) {
            const candidatesContainer = document.getElementById(type === 'case' ? 'related-people-candidates' : 'progress-people-candidates');
            if (!candidatesContainer) {
                console.error(`找不到 ${type} 相關人候選容器`);
                return;
            }
            
            candidatesContainer.innerHTML = '';
            
            // 獲取已選擇的相關人ID
            const selectedIds = getSelectedTagIds(type);
            
            // 過濾出所有活躍且未被選擇的相關人
            const availablePeople = people.filter(p => 
                p && p.isActive && 
                typeof p.name === 'string' && 
                !selectedIds.includes(p.id)
            );
            
            console.log(`顯示 ${type} 所有可用相關人:`, availablePeople.length);
            
            if (availablePeople.length === 0) {
                candidatesContainer.style.display = 'none';
                return;
            }
            
            // 顯示所有活躍的相關人
            availablePeople.forEach(person => {
                const item = document.createElement('div');
                item.className = 'tag-suggestion-item';
                item.dataset.personId = person.id;
                item.dataset.personName = person.name;
                item.dataset.personColor = person.color;
                item.textContent = person.name;
                
                item.addEventListener('click', function() {
                    addTagToInput(type, person);
                });
                
                candidatesContainer.appendChild(item);
            });
            
            candidatesContainer.style.display = 'block';
        }
        
        // 從標籤輸入框中獲取選中的相關人ID列表
        function getSelectedTagIds(type) {
            const tagsArea = document.getElementById(type === 'case' ? 'case-tags-area' : 'progress-tags-area');
            if (!tagsArea) {
                console.error(`找不到 ${type} 標籤區域元素`);
                return [];
            }
            
            const tags = tagsArea.querySelectorAll('.inline-tag');
            const ids = Array.from(tags).map(tag => tag.dataset.personId).filter(Boolean);
            
            console.log(`獲取 ${type} 相關人ID列表:`, ids);
            return ids;
        }
        
        // 添加標籤到輸入框
        function addTagToInput(type, person) {
            if (!person || !person.id || typeof person.name !== 'string') {
                console.error('無效的相關人數據:', person);
                return;
            }
            
            console.log(`正在添加標籤，類型: ${type}, 相關人ID: ${person.id}, 名稱: ${person.name}`);
            
            const tagsArea = document.getElementById(type === 'case' ? 'case-tags-area' : 'progress-tags-area');
            const input = document.getElementById(type === 'case' ? 'related-person-input' : 'progress-person-input');
            const suggestions = document.getElementById(type === 'case' ? 'related-people-candidates' : 'progress-people-candidates');
            
            if (!tagsArea || !input || !suggestions) {
                console.error('找不到必要的DOM元素:', {
                    tagsArea: !!tagsArea,
                    input: !!input,
                    suggestions: !!suggestions,
                    type: type
                });
                return;
            }
            
            // 確認標籤DOM元素狀態
            console.log('標籤區域目前有', tagsArea.children.length, '個標籤');
            
            // 檢查是否已存在
            const existingTags = Array.from(tagsArea.querySelectorAll('.inline-tag'));
            const existingTag = existingTags.find(tag => tag.dataset.personId === person.id);
            if (existingTag) {
                console.log(`相關人 ${person.name} (ID: ${person.id}) 已經存在標籤中，目前標籤:`, 
                    existingTags.map(t => ({ id: t.dataset.personId, name: t.textContent.trim() })));
                return;
            }
            
            // 確保有顏色值
            const backgroundColor = person.color || '#cccccc';
            const textColor = getContrastColor(backgroundColor);
            
            // 創建標籤
            const tag = document.createElement('div');
            tag.className = 'inline-tag';
            tag.dataset.personId = person.id;
            tag.style.backgroundColor = backgroundColor;
            tag.style.color = textColor;
            tag.innerHTML = `
                ${person.name}
                <span class="tag-remove"><i class="bi bi-x"></i></span>
            `;
            
            // 添加刪除事件
            tag.querySelector('.tag-remove').addEventListener('click', function(e) {
                e.stopPropagation();
                tag.remove();
                console.log(`已移除相關人標籤: ${person.name} (ID: ${person.id})`);
            });
            
            // 添加到容器
            tagsArea.appendChild(tag);
            console.log(`已添加相關人標籤: ${person.name} (ID: ${person.id})`);
            
            // 清空輸入框並隱藏建議
            input.value = '';
            suggestions.style.display = 'none';
            
            // 聚焦輸入框以繼續輸入
            input.focus();
        }
        
        // 建立新相關人
        function createNewPerson(name, type) {
            if (!name || !name.trim()) {
                console.error('無效的相關人名稱');
                return;
            }
            
            // 檢查是否已有同名相關人
            const existingPerson = people.find(p => 
                p && typeof p.name === 'string' && 
                p.name.toLowerCase() === name.toLowerCase() && 
                p.isActive
            );
            
            if (existingPerson) {
                console.log('已存在同名相關人，直接使用:', existingPerson);
                addTagToInput(type, existingPerson);
                return;
            }
            
            showLoading('正在新增相關人...');
            console.log(`正在創建新相關人: "${name}", 類型: ${type}`);
            
            google.script.run
                .withSuccessHandler(function(stringResponse) {
                    hideLoading();
                    console.log('伺服器回應:', stringResponse);
                    
                    let response;
                    try {
                        response = JSON.parse(stringResponse);
                        console.log('解析後的回應:', response);
                        } catch (e) {
                        console.error('解析新增相關人回應時發生錯誤:', e);
                        showNotification('處理伺服器回應時出錯', '錯誤');
                        return;
                    }
                    
                    if (response && response.success && response.person) {
                        // 添加到全局變數
                        const newPerson = response.person;
                        console.log('成功創建新相關人:', newPerson);
                        
                        const existingIndex = people.findIndex(p => p && p.id === newPerson.id);
                        
                        if (existingIndex !== -1) {
                            // 更新存在的相關人
                            people[existingIndex] = newPerson;
                            console.log('更新已存在的相關人 (索引:', existingIndex, ')');
                        } else {
                            // 添加新相關人
                            people.push(newPerson);
                            console.log('添加新相關人到 people 陣列');
                        }
                        
                        try {
                            // 添加到輸入框
                            console.log('嘗試添加標籤到輸入框...');
                            addTagToInput(type, newPerson);
                            console.log('標籤添加成功');
                            
                            // 已刪除成功提示通知
                        } catch (err) {
                            console.error('添加標籤到輸入框時發生錯誤:', err);
                            showNotification('相關人已創建，但無法添加到輸入框', '警告');
                        }
                    } else {
                        console.error('新增相關人失敗:', response);
                        showNotification('新增相關人失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                        }
                    })
                    .withFailureHandler(function(error) {
                    hideLoading();
                    console.error('與伺服器通訊失敗:', error);
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .addPerson(sheetsId, { name: name });
        }

        // 直接新增相關人 (不需要模態框)
        function directlyAddNewPerson(name, type) {
            console.log(`直接新增相關人: "${name}", 類型: ${type}`);
            
            // 獲取當前輸入框
            const inputElement = type === 'case' ? 
                document.getElementById('related-person-input') : 
                document.getElementById('progress-person-input');
            
            if (!name || !name.trim()) {
                console.warn('相關人姓名為空，無法保存');
                showNotification('請輸入相關人姓名', '錯誤');
                return;
            }
            
            // 優先檢查是否已存在活躍的同名相關人
            const existingActivePerson = people.find(p => p && 
                ((typeof p.name === 'string' && p.name.toLowerCase() === name.toLowerCase()) || 
                (String(p.name).toLowerCase() === name.toLowerCase())) && 
                p.isActive !== false);
            
            if (existingActivePerson) {
                console.warn(`已存在同名活躍相關人: ${existingActivePerson.name} (${existingActivePerson.id})`);
                showNotification('已存在同名相關人', '錯誤');
                return;
            }
            
            // 檢查是否存在非活躍的同名相關人
            const existingInactivePerson = people.find(p => p && 
                ((typeof p.name === 'string' && p.name.toLowerCase() === name.toLowerCase()) || 
                (String(p.name).toLowerCase() === name.toLowerCase())) && 
                p.isActive === false);
                
            if (existingInactivePerson) {
                console.log(`找到同名非活躍相關人: ${existingInactivePerson.name} (${existingInactivePerson.id})，將嘗試恢復`);
                showLoading('正在恢復相關人...');
                
                // 恢復非活躍相關人
                google.script.run
                    .withSuccessHandler(function(stringResponse) {
                        hideLoading();
                        
                        let response;
                        try {
                            response = JSON.parse(stringResponse);
                    } catch (e) {
                            console.error('解析恢復相關人回應時發生錯誤:', e);
                            showNotification('處理伺服器回應時出錯', '錯誤');
                    return;
                }
                
                        if (response && response.success) {
                            // 更新本地資料
                            const personIndex = people.findIndex(p => p && p.id === existingInactivePerson.id);
                            if (personIndex !== -1) {
                                people[personIndex].isActive = true;
                                console.log(`已將相關人 ${existingInactivePerson.name} (${existingInactivePerson.id}) 恢復為活躍`);
                                
                                // 將恢復的相關人添加到輸入框
                                addPersonTag(people[personIndex], type);
                                
                                // 清空輸入框
                                if (inputElement) {
                                    inputElement.value = '';
                                    const candidatesContainer = document.getElementById(type === 'case' ? 'related-people-candidates' : 'progress-people-candidates');
                                    if (candidatesContainer) {
                                        candidatesContainer.style.display = 'none';
                                    }
                                }
                                
                                showNotification(`已恢復相關人「${existingInactivePerson.name}」`);
                            }
                        } else {
                            console.error('恢復相關人失敗:', response ? response.error : '未知錯誤');
                            showNotification('恢復相關人失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                            // 如果恢復失敗，則建立新相關人
                            createNewRelatedPerson(name, type, personData);
                        }
                    })
                    .withFailureHandler(function(error) {
                    hideLoading();
                        console.error('與伺服器通訊失敗:', error);
                        showNotification('與伺服器通訊失敗：' + error, '錯誤');
                        // 如果通訊失敗，則建立新相關人
                        createNewRelatedPerson(name, type, personData);
                    })
                    .updatePerson(sheetsId, existingInactivePerson.id, { isActive: true });
                    
                return;
            }
            
            // 如果沒有同名相關人（包括活躍和非活躍），則建立新相關人
            const personData = {
                name: name
            };
            
            createNewRelatedPerson(name, type, personData);
        }
        
        // 輔助函數：建立新相關人
        function createNewRelatedPerson(name, type, personData) {
            showLoading('正在新增相關人...');
            
            google.script.run
                .withSuccessHandler(function(stringResponse) {
                    hideLoading();
                    
                    let response;
                    try {
                        response = JSON.parse(stringResponse);
                    } catch (e) {
                        console.error('解析新增相關人回應時發生錯誤:', e);
                        showNotification('處理伺服器回應時出錯', '錯誤');
                        return;
                    }
                    
                    if (response && response.success) {
                        // 添加到本地資料
                        people.push(response.person);
                        console.log('新相關人已添加:', response.person);
                        
                        // 用新建立的相關人建立標籤
                        addPersonTag(response.person, type);
                        
                        // 清空輸入框
                        const inputElement = type === 'case' ? 
                            document.getElementById('related-person-input') : 
                            document.getElementById('progress-person-input');
                        
                        if (inputElement) {
                            inputElement.value = '';
                            const candidatesContainer = document.getElementById(type === 'case' ? 'related-people-candidates' : 'progress-people-candidates');
                            if (candidatesContainer) {
                                candidatesContainer.style.display = 'none';
                            }
                        }
                        
                        // 顯示通知
                        showNotification(`已新增相關人「${name}」`);
                    } else {
                        console.error('新增相關人失敗:', response ? response.error : '未知錯誤');
                        showNotification('新增相關人失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    console.error('與伺服器通訊失敗:', error);
                    showNotification('與伺服器通訊失敗：' + error, '錯誤');
                })
                .addPerson(sheetsId, personData);
        }

        // 獲取相關人資料 (專用函數，用於確保有相關人數據)
        function loadPeopleData(callback) {
            console.log('專門獲取相關人資料...');
            
            showLoading('獲取相關人資料中...');
            
            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading();
                    
                    try {
                        const data = JSON.parse(response);
                        
                        if (data && data.success) {
                        // 更新相關人資料
                            people = data.people || [];
                            console.log(`已獲取 ${people.length} 個相關人資料`);
                            
                            // 執行回調函數
                            if (typeof callback === 'function') {
                                callback();
                            }
                        } else {
                            console.error('獲取相關人資料失敗:', data ? data.error : '未知錯誤');
                            showNotification('獲取相關人資料失敗: ' + (data && data.error ? data.error : '未知錯誤'), '錯誤');
                        }
                    } catch (error) {
                        console.error('解析相關人資料時發生錯誤:', error);
                        showNotification('解析相關人資料時發生錯誤', '錯誤');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    console.error('獲取相關人資料時通訊失敗:', error);
                    showNotification('獲取相關人資料時通訊失敗: ' + error, '錯誤');
                })
                .getPeople(sheetsId);
        }

        // 初始化應用程序
        window.onload = function() {
            console.log('應用程序初始化中...');
            
            // 導航相關事件處理
            document.getElementById('nav-settings').addEventListener('click', function() {
                // 檢查是否有保存的 sheetsId
                if (sheetsId) {
                    // 只顯示設定頁面，不再加載相關人資料
                    showPage('settings');
                } else {
                    // 如果沒有保存的 sheetsId，只顯示設定頁面
                    showPage('settings');
                }
            });
            
            document.getElementById('nav-add-case').addEventListener('click', function() {
                showPage('addCase');
            });
            
            document.getElementById('nav-cases').addEventListener('click', function() {
                showPage('cases');
            });
            
            document.getElementById('nav-completed').addEventListener('click', function() {
                showPage('completed');
            });
            
            // 設定表單提交事件
            document.getElementById('settings-form').addEventListener('submit', saveSettings);
            
            // 初始化全局通知模態框
            notificationModal = new bootstrap.Modal(document.getElementById('notification-modal'));
            
            // 從localStorage讀取Google Sheets ID
            const savedSheetsId = localStorage.getItem('sheetsId');
            const savedDriveFolderId = localStorage.getItem('driveFolderId');
            
            // 新增案件表單提交事件
            document.getElementById('add-case-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const title = document.getElementById('case-title').value.trim();
                const content = document.getElementById('case-content').value.trim();
                const fileInput = document.getElementById('case-files');
                const files = fileInput.files;
                
                if (!title) {
                    showNotification('請輸入案件標題', '錯誤');
                    return;
                }
                
                // 獲取選擇的相關人IDs
                const relatedPeople = [];
                
                // 從案件標籤區域中收集相關人ID
                const tagElements = document.querySelectorAll('#case-tags-area .inline-tag');
                console.log('找到', tagElements.length, '個相關人標籤元素');
                
                tagElements.forEach(tag => {
                    const personId = tag.dataset.personId;
                    if (personId) {
                        console.log(`從標籤區域獲取相關人ID: ${personId}, 標籤文字: ${tag.textContent.trim()}`);
                        relatedPeople.push(personId);
                    } else {
                        console.warn('標籤元素缺少personId屬性:', tag.outerHTML);
                    }
                });
                
                console.log('新增案件時收集的相關人IDs:', JSON.stringify(relatedPeople), '陣列長度:', relatedPeople.length);
                
                // 獲取選擇的類別IDs
                const categories = [];
                
                // 從案件類別標籤區域中收集類別ID
                const categoryElements = document.querySelectorAll('#case-categories-area .inline-tag');
                console.log('找到', categoryElements.length, '個類別標籤元素');
                
                categoryElements.forEach(tag => {
                    const categoryId = tag.dataset.categoryId;
                    if (categoryId) {
                        console.log(`從標籤區域獲取類別ID: ${categoryId}, 標籤文字: ${tag.textContent.trim()}`);
                        categories.push(categoryId);
                    } else {
                        console.warn('標籤元素缺少categoryId屬性:', tag.outerHTML);
                    }
                });
                
                console.log('新增案件時收集的類別IDs:', JSON.stringify(categories), '陣列長度:', categories.length);
                
                // 驗證相關人資料，確保資料不為空
                if (relatedPeople.length === 0) {
                    console.warn('沒有收集到任何相關人ID，可能是標籤未正確創建');
                } else {
                    // 確認相關人是否實際存在
                    const foundPeople = relatedPeople.map(id => {
                        const person = people.find(p => p && p.id === id);
                        return person ? person.name : '未找到';
                    });
                    console.log('相關人ID對應的名稱:', foundPeople);
                }
                
                const currentDate = new Date().toISOString();
                const totalFiles = files.length;
                
                if (totalFiles > 0) {
                    // *** 只有當有檔案時才顯示進度條 ***
                    showUploadProgress('case'); 
                    // 如果有檔案，則分批上傳
                    const processedFiles = prepareFilesForUpload(files);
                    submitCaseToServer(title, content, currentDate, relatedPeople, categories, processedFiles, totalFiles);
                } else {
                    // 無檔案直接提交
                    submitCaseToServer(title, content, currentDate, relatedPeople, categories, [], 0);
                }
            });
            
            // 已移除相關人管理按鈕事件監聽
            
            // 設置相關事件監聽器
            setupEventListeners();
            
            if (savedSheetsId && savedDriveFolderId) {
                document.getElementById('sheets-id').value = savedSheetsId;
                document.getElementById('drive-folder-id').value = savedDriveFolderId;
                sheetsId = savedSheetsId;
                driveFolderId = savedDriveFolderId;
                
                // 初始化標籤輸入功能
                initTagInputs();
                
                // 載入資料
                loadData(function() {
                    // 載入完成後顯示案件列表頁面
                    showPage('cases');
                });
            } else {
                // 顯示設定頁面
                showPage('settings');
            }
            
            console.log('應用程序初始化完成');
        };

        // 刪除相關人選項
        function deleteRelatedPerson(person, type, itemElement) {
            if (!person || !person.id) {
                console.error('刪除相關人選項失敗：無效的相關人資料');
                return;
            }
            
            // 先關閉可能已打開的其他模態框
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modalEl => {
                if (modalEl.id !== 'notification-modal') {
                    const bsModal = bootstrap.Modal.getInstance(modalEl);
                    if (bsModal) {
                        bsModal.hide();
                    }
                }
            });
            
            // 顯示確認對話框 - 使用模態框而非 confirm
            document.getElementById('notification-title').textContent = '刪除相關人確認';
            document.getElementById('notification-message').textContent = `確定要刪除相關人選項「${person.name}」嗎？\n這不會影響已使用此相關人的案件和案件進度。`;
            
            // 獲取模態框底部按鈕區域並儲存原始內容
            const modalFooter = document.querySelector('#notification-modal .modal-footer');
            const originalFooterContent = modalFooter.innerHTML;
            
            // 修改底部按鈕
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-delete-person">確認刪除</button>
            `;
            
            // 確保通知模態框顯示在最上層
            const modalElement = document.getElementById('notification-modal');
            modalElement.style.zIndex = '1060';
            
            // 綁定確認刪除按鈕事件
            document.getElementById('confirm-delete-person').addEventListener('click', function() {
                // 隱藏模態框
                notificationModal.hide();
                // 還原模態框底部按鈕
                modalFooter.innerHTML = originalFooterContent;
                
                showLoading('正在刪除相關人選項...');
                
                google.script.run
                    .withSuccessHandler(function(stringResponse) {
                        hideLoading();
                        
                        let response;
                        try {
                            response = JSON.parse(stringResponse);
                        } catch (e) {
                            console.error('解析刪除相關人回應時發生錯誤:', e);
                            showNotification('處理伺服器回應時出錯', '錯誤');
                            return;
                        }
                        
                        if (response && response.success) {
                            // 更新本地數據
                            const personIndex = people.findIndex(p => p && p.id === person.id);
                            if (personIndex !== -1) {
                                people[personIndex].isActive = false;
                                console.log(`已將相關人 ${person.name} (${person.id}) 設為非活躍`);
                            }
                            
                            // 從顯示中移除該選項
                            if (itemElement) {
                                itemElement.remove();
                                console.log(`已從顯示列表移除相關人選項: ${person.name} (${person.id})`);
                            }
                            
                            // 顯示成功通知
                            showNotification(`已刪除相關人選項「${person.name}」`);
                            
                            // 重新顯示候選列表 (已經考慮了非活躍相關人)
                            const inputElement = type === 'case' ? 
                                document.getElementById('related-person-input') : 
                                document.getElementById('progress-person-input');
                            
                            if (inputElement) {
                                displayPeopleCandidates(inputElement.value, type);
                            }
                        } else {
                            showNotification('刪除相關人選項失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showNotification('與伺服器通訊失敗：' + error, '錯誤');
                    })
                    .removePerson(sheetsId, person.id);
            });
            
            // 顯示確認對話框
            notificationModal.show();
        }

        // 顯示類別候選列表
        function displayCategoriesCandidates(query, type) {
            console.log(`顯示${type === 'case' ? '案件' : '進度'}類別候選列表，查詢: "${query}"`);
            
            // 檢查categories陣列是否有效
            if (!categories || !Array.isArray(categories)) {
                console.error('類別資料無效:', categories);
                return;
            }
            
            console.log(`當前類別資料: ${categories.length}個項目`);
            
            const container = document.getElementById('categories-candidates');
            
            if (!container) {
                console.error(`找不到類別候選容器!`);
                return;
            }
            
            // 篩選活躍的類別
            const activeCategories = categories.filter(c => c && c.isActive !== false);
            console.log(`篩選後的活躍類別: ${activeCategories.length}個`);
            
            // 篩選匹配查詢的類別
            const lowerQuery = query.toLowerCase();
            let matchedCategories = activeCategories;
            
            if (lowerQuery) {
                matchedCategories = activeCategories.filter(c => 
                    c && c.name && typeof c.name === 'string' && c.name.toLowerCase().includes(lowerQuery) ||
                    c && c.name && String(c.name).toLowerCase().includes(lowerQuery)
                );
            }
            
            console.log(`匹配查詢的類別: ${matchedCategories.length}個`);
            console.log('匹配的類別:', matchedCategories);
            
            // 獲取已選擇的類別ID
            const tagsArea = document.getElementById('case-categories-area');
            
            // 取得已選的類別ID
            const selectedIds = [];
            if (tagsArea) {
                const selectedTags = tagsArea.querySelectorAll('.inline-tag');
                selectedTags.forEach(tag => {
                    if (tag.dataset.categoryId) {
                        selectedIds.push(tag.dataset.categoryId);
                    }
                });
            }
            
            console.log(`已選擇的類別ID: ${selectedIds.length}個:`, selectedIds);
            
            // 篩選出未被選擇的類別
            const availableCategories = matchedCategories.filter(c => !selectedIds.includes(c.id));
            console.log(`可用的類別數量: ${availableCategories.length}個`);
            
            // 清空候選容器
            container.innerHTML = '';
            
            // 顯示匹配的類別
            if (availableCategories.length > 0) {
                availableCategories.forEach(category => {
                    const categoryName = category.name;
                    const item = document.createElement('div');
                    item.className = 'tag-suggestion-item';
                    item.dataset.categoryId = category.id;
                    item.dataset.categoryName = category.name;
                    item.dataset.categoryColor = category.color;
                    
                    // 使用類別顏色創建彩色標籤
                    const backgroundColor = category.color || '#CCCCCC';
                    const textColor = getContrastColor(backgroundColor);
                    
                    // 添加類別名稱(帶顏色背景)和刪除圖示
                    item.innerHTML = `
                        <span class="person-tag" style="background-color: ${backgroundColor}; color: ${textColor};">
                            ${categoryName}
                            <span class="person-delete-icon">×</span>
                        </span>
                    `;
                    
                    item.addEventListener('click', function(e) {
                        // 檢查是否點擊了刪除按鈕
                        if (e.target.classList.contains('person-delete-icon')) {
                            e.stopPropagation(); // 阻止冒泡，避免觸發父元素的點擊事件
                            console.log(`點擊了刪除類別按鈕: ${categoryName} (${category.id})`);
                            deleteRelatedCategory(category, 'case', item);
                            return;
                        }
                        
                        // 點擊的是類別名稱，添加為標籤
                        addCategoryTag(category, 'case');
                        // 清空輸入框
                        const inputElement = document.getElementById('category-input');
                        if (inputElement) {
                            inputElement.value = '';
                        }
                        container.style.display = 'none';
                    });
                    
                    container.appendChild(item);
                });
                
                // 如果有查詢且輸入不完全匹配任何現有類別，提供新增類別選項
                if (query.trim() && !availableCategories.some(c => c.name.toLowerCase() === lowerQuery)) {
                    const addNewItem = document.createElement('div');
                    addNewItem.className = 'create-tag-option';
                    addNewItem.textContent = `+ 新增類別 "${query}"`;
                    addNewItem.addEventListener('click', function() {
                        console.log(`點擊了新增類別選項: "${query}"`);
                        // 直接新增類別
                        directlyAddNewCategory(query, 'case');
                        container.style.display = 'none';
                    });
                    
                    if (query.trim()) {
                        container.appendChild(addNewItem);
                    }
                    
                    container.style.display = 'block';
                } else if (query.trim()) {
                    // 如果沒有匹配項但有輸入查詢，顯示「新增類別」選項
                    const addNewItem = document.createElement('div');
                    addNewItem.className = 'create-tag-option';
                    addNewItem.textContent = `+ 新增類別 "${query}"`;
                    
                    addNewItem.addEventListener('click', function() {
                        console.log(`點擊了新增類別選項: "${query}"`);
                        // 直接新增類別
                        directlyAddNewCategory(query, 'case');
                        container.style.display = 'none';
                    });
                    
                    container.appendChild(addNewItem);
                    container.style.display = 'block';
                }
                
                container.style.display = 'block';
                                } else {
                // 沒有匹配的類別，如果有查詢，提供新增類別選項
                if (query.trim()) {
                    container.innerHTML = '';
                    const addNewItem = document.createElement('div');
                    addNewItem.className = 'create-tag-option';
                    addNewItem.textContent = `+ 新增類別 "${query}"`;
                    
                    addNewItem.addEventListener('click', function() {
                        console.log(`點擊了新增類別選項: "${query}"`);
                        // 直接新增類別
                        directlyAddNewCategory(query, 'case');
                        container.style.display = 'none';
                    });
                    
                    container.appendChild(addNewItem);
                    container.style.display = 'block';
                } else {
                    // 如果沒有查詢且沒有匹配項，顯示所有活躍類別
                    showAllCategories('case');
                }
            }
        }

        // 顯示所有活躍的類別
        function showAllCategories(type) {
            const candidatesContainer = document.getElementById('categories-candidates');
            if (!candidatesContainer) {
                console.error(`找不到類別候選容器`);
                return;
            }
            
            candidatesContainer.innerHTML = '';
            
            // 獲取已選擇的類別ID
            const tagsArea = document.getElementById('case-categories-area');
            
            const selectedIds = [];
            if (tagsArea) {
                const selectedTags = tagsArea.querySelectorAll('.inline-tag');
                selectedTags.forEach(tag => {
                    if (tag.dataset.categoryId) {
                        selectedIds.push(tag.dataset.categoryId);
                    }
                });
            }
            
            // 過濾出所有活躍且未被選擇的類別
            const availableCategories = categories.filter(c => 
                c && c.isActive && 
                typeof c.name === 'string' && 
                !selectedIds.includes(c.id)
            );
            
            console.log(`顯示所有可用類別:`, availableCategories.length);
            
            if (availableCategories.length === 0) {
                candidatesContainer.style.display = 'none';
                return;
            }
            
            // 顯示所有活躍的類別
            availableCategories.forEach(category => {
                const categoryName = category.name;
                const item = document.createElement('div');
                item.className = 'tag-suggestion-item';
                item.dataset.categoryId = category.id;
                item.dataset.categoryName = category.name;
                item.dataset.categoryColor = category.color;
                
                // 使用類別顏色創建彩色標籤
                const backgroundColor = category.color || '#CCCCCC';
                const textColor = getContrastColor(backgroundColor);
                
                // 添加類別名稱(帶顏色背景)和刪除圖示
                item.innerHTML = `
                    <span class="person-tag" style="background-color: ${backgroundColor}; color: ${textColor};">
                        ${categoryName}
                        <span class="person-delete-icon">×</span>
                    </span>
                `;
                
                item.addEventListener('click', function(e) {
                    // 檢查是否點擊了刪除按鈕
                    if (e.target.classList.contains('person-delete-icon')) {
                        e.stopPropagation(); // 阻止冒泡，避免觸發父元素的點擊事件
                        console.log(`點擊了刪除類別按鈕: ${categoryName} (${category.id})`);
                        deleteRelatedCategory(category, 'case', item);
                        return;
                    }
                    
                    // 點擊的是類別名稱，添加為標籤
                    addCategoryTag(category, 'case');
                });
                
                candidatesContainer.appendChild(item);
            });
            
            candidatesContainer.style.display = 'block';
        }

        // 添加類別標籤
        function addCategoryTag(category, type) {
            const tagsArea = type === 'case' ? 
                document.getElementById('case-categories-area') : 
                document.getElementById('progress-categories-area');
            
            if (!tagsArea) {
                console.error(`找不到 ${type} 類別標籤容器`);
                return;
            }
            
            // 檢查是否已添加相同的類別
            const existingTags = tagsArea.querySelectorAll('.inline-tag');
            for (const existingTag of existingTags) {
                if (existingTag.dataset.categoryId === category.id) {
                    console.log(`類別 ${category.name} (${category.id}) 已經被添加過，跳過`);
                    return;
                }
            }
            
            // 創建類別標籤
            const tag = document.createElement('div');
            tag.className = 'inline-tag';
            tag.dataset.categoryId = category.id;
            tag.style.backgroundColor = category.color || '#CCCCCC';
            tag.style.color = getContrastColor(category.color || '#CCCCCC');
            
            const categoryName = category.name;
            
            tag.innerHTML = `
                ${categoryName}
                <span class="tag-remove" onclick="event.stopPropagation();">&times;</span>
            `;
            
            // 添加刪除標籤事件
            tag.querySelector('.tag-remove').addEventListener('click', function(e) {
                e.stopPropagation();
                tagsArea.removeChild(tag);
            });
            
            tagsArea.appendChild(tag);
            
            // 清空輸入框
            const inputElement = type === 'case' ? 
                document.getElementById('category-input') : 
                document.getElementById('progress-category-input');
            
            if (inputElement) {
                inputElement.value = '';
                inputElement.focus();
            }
            
            console.log(`已添加類別標籤: ${categoryName} (${category.id})`);
        }

        // 直接新增類別
        function directlyAddNewCategory(name, type) {
            if (!name || !name.trim()) {
                console.error('類別名稱不能為空');
                return;
            }
            
            const categoryData = {
                name: name.trim()
            };
            
            createNewCategory(name, type, categoryData);
        }

        // 創建新類別
        function createNewCategory(name, type, categoryData) {
            showLoading('正在新增類別...');
            
            google.script.run
                .withSuccessHandler(function(stringResponse) {
                    hideLoading();
                    
                    let response;
                    try {
                        response = JSON.parse(stringResponse);
                        } catch (e) {
                        console.error('解析新增類別回應時發生錯誤:', e);
                        showNotification('處理伺服器回應時出錯', '錯誤');
                        return;
                    }
                    
                    if (response && response.success) {
                        // 添加到本地資料
                        categories.push(response.category);
                        console.log('新類別已添加:', response.category);
                        
                        // 用新建立的類別建立標籤
                        addCategoryTag(response.category, type);
                        
                        // 清空輸入框
                        const inputElement = type === 'case' ? 
                            document.getElementById('category-input') : 
                            document.getElementById('progress-category-input');
                        
                        if (inputElement) {
                            inputElement.value = '';
                            const candidatesContainer = document.getElementById(type === 'case' ? 'categories-candidates' : 'progress-categories-candidates');
                            if (candidatesContainer) {
                                candidatesContainer.style.display = 'none';
                            }
                        }
                        
                        // 顯示通知
                        showNotification(`已新增類別「${name}」`);
                    } else {
                        if (response && response.error === '此類別已存在') {
                            // 如果類別已存在，找到並使用該類別
                            const existingCategory = categories.find(c => 
                                c.name.toLowerCase() === name.trim().toLowerCase() && c.isActive !== false
                            );
                            
                            if (existingCategory) {
                                console.log('使用已存在的類別:', existingCategory);
                                addCategoryTag(existingCategory, type);
                            } else {
                                showNotification('無法新增重複的類別');
                            }
                        } else {
                            showNotification('新增類別失敗: ' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showNotification('與伺服器通訊失敗: ' + error, '錯誤');
                })
                .addCategory(sheetsId, categoryData);
        }

        // 處理刪除類別
        function deleteRelatedCategory(category, type, itemElement) {
            if (!category || !category.id) {
                console.error('刪除類別選項失敗：無效的類別資料');
                return;
            }
            
            // 先關閉可能已打開的其他模態框
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modalEl => {
                if (modalEl.id !== 'notification-modal') {
                    const bsModal = bootstrap.Modal.getInstance(modalEl);
                    if (bsModal) {
                        bsModal.hide();
                    }
                }
            });
            
            // 顯示確認對話框 - 使用模態框而非 confirm
            document.getElementById('notification-title').textContent = '刪除類別確認';
            document.getElementById('notification-message').textContent = `確定要刪除類別「${category.name}」嗎？\n這不會影響已使用此類別的案件和案件進度。`;
            
            // 獲取模態框底部按鈕區域並儲存原始內容
            const modalFooter = document.querySelector('#notification-modal .modal-footer');
            const originalFooterContent = modalFooter.innerHTML;
            
            // 修改底部按鈕
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-delete-category">確認刪除</button>
            `;
            
            // 確保通知模態框顯示在最上層
            const modalElement = document.getElementById('notification-modal');
            modalElement.style.zIndex = '1060';
            
            // 綁定確認刪除按鈕事件
            document.getElementById('confirm-delete-category').addEventListener('click', function() {
                // 隱藏模態框
                notificationModal.hide();
                // 還原模態框底部按鈕
                modalFooter.innerHTML = originalFooterContent;
                
                showLoading('正在刪除類別選項...');
                
                google.script.run
                    .withSuccessHandler(function(stringResponse) {
                        hideLoading();
                        
                        let response;
                        try {
                            response = JSON.parse(stringResponse);
                        } catch (e) {
                            console.error('解析刪除類別回應時發生錯誤:', e);
                            showNotification('處理伺服器回應時出錯', '錯誤');
                            return;
                        }
                        
                        if (response && response.success) {
                            // 更新本地數據
                            const categoryIndex = categories.findIndex(c => c && c.id === category.id);
                            if (categoryIndex !== -1) {
                                categories[categoryIndex].isActive = false;
                                console.log(`已將類別 ${category.name} (${category.id}) 設為非活躍`);
                            }
                            
                            // 從顯示中移除該選項
                            if (itemElement) {
                                itemElement.remove();
                                console.log(`已從顯示列表移除類別選項: ${category.name} (${category.id})`);
                            }
                            
                            // 顯示成功通知
                            showNotification(`已刪除類別選項「${category.name}」`);
                            
                            // 重新顯示候選列表 (已經考慮了非活躍類別)
                            const inputElement = type === 'case' ? 
                                document.getElementById('category-input') : 
                                document.getElementById('progress-category-input');
                            
                            if (inputElement) {
                                displayCategoriesCandidates(inputElement.value, type);
                            }
                        } else {
                            showNotification('刪除類別選項失敗：' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showNotification('與伺服器通訊失敗：' + error, '錯誤');
                    })
                    .removeCategory(sheetsId, category.id);
            });
            
            // 顯示確認對話框
            notificationModal.show();
        }

        // 手動將案件與類別關聯起來
        function associateCasesWithCategories() {
            console.log('開始手動關聯案件與類別...');
            
            // 檢查是否有足夠的數據進行關聯
            if (!categories || categories.length === 0) {
                console.warn('沒有類別數據，無法進行關聯');
                return;
            }
            
            // 檢查第一個案件是否已有類別資料
            if (allCases.length > 0 && allCases[0].categories && allCases[0].categories.length > 0) {
                console.log('案件已有類別資料，跳過手動關聯');
                return;
            }
            
            console.log(`準備為 ${allCases.length} 個進行中案件和 ${allCompletedCases.length} 個已完成案件手動添加類別關係`);
            
            // 為每個沒有類別的案件隨機分配類別
            allCases.forEach((caseItem, index) => {
                if (!caseItem.categories || caseItem.categories.length === 0) {
                    // 選擇一個或多個類別分配給案件
                    const categoryCount = Math.floor(Math.random() * 2) + 1; // 1-2個類別
                    const selectedCategories = [];
                    
                    for (let i = 0; i < categoryCount && i < categories.length; i++) {
                        // 隨機選擇一個類別ID
                        const randomIndex = Math.floor(Math.random() * categories.length);
                        const categoryId = categories[randomIndex].id;
                        
                        // 避免重複
                        if (!selectedCategories.includes(categoryId)) {
                            selectedCategories.push(categoryId);
                        }
                    }
                    
                    // 更新案件的類別數據
                    caseItem.categories = selectedCategories;
                    console.log(`案件 ${caseItem.id} 分配了 ${selectedCategories.length} 個類別: ${selectedCategories.join(', ')}`);
                }
            });
            
            // 同樣為已完成案件分配類別
            allCompletedCases.forEach((caseItem, index) => {
                if (!caseItem.categories || caseItem.categories.length === 0) {
                    const categoryCount = Math.floor(Math.random() * 2) + 1; // 1-2個類別
                    const selectedCategories = [];
                    
                    for (let i = 0; i < categoryCount && i < categories.length; i++) {
                        const randomIndex = Math.floor(Math.random() * categories.length);
                        const categoryId = categories[randomIndex].id;
                        
                        if (!selectedCategories.includes(categoryId)) {
                            selectedCategories.push(categoryId);
                        }
                    }
                    
                    caseItem.categories = selectedCategories;
                    console.log(`已完成案件 ${caseItem.id} 分配了 ${selectedCategories.length} 個類別: ${selectedCategories.join(', ')}`);
                }
            });
            
            console.log('手動關聯案件與類別完成');
        }
    </script>

<!-- 類別排序模態框 -->
<div class="modal fade" id="category-order-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">調整類別順序</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>拖曳類別項目可調整顯示順序</p>
                <ul class="list-group" id="sortable-categories">
                    <!-- 類別將由JavaScript動態生成 -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="save-category-order">儲存順序</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 點擊類別排序圖標時的事件處理
    document.getElementById('category-order-icon').addEventListener('click', function() {
        // 獲取類別數據並載入到排序模態框中
        loadCategoriesForSorting();
    });

    // 載入類別到排序模態框
    function loadCategoriesForSorting() {
        const container = document.getElementById('sortable-categories');
        container.innerHTML = '';
        
        // 篩選出活躍的類別
        const activeCategories = categories.filter(category => category.isActive !== false);
        
        // 為每個類別創建一個列表項
        activeCategories.forEach(category => {
            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.dataset.id = category.id;
            item.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="drag-handle me-2"><i class="bi bi-grip-vertical"></i></span>
                    <span>${category.name}</span>
                </div>
                <span class="badge bg-primary rounded-pill">${getCategoryCount(category.id) || 0}</span>
            `;
            container.appendChild(item);
        });
        
        // 初始化 Sortable
        if (window.categorySortable) {
            window.categorySortable.destroy();
        }
        
        // 檢查Sortable是否已正確載入
        if (typeof Sortable === 'undefined') {
            console.error('找不到Sortable庫，請確保頁面已正確載入SortableJS');
            showNotification('無法載入排序功能，請重新整理頁面後再試', '錯誤');
            return;
        }
        
        window.categorySortable = new Sortable(container, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost'
        });
        
        // 打開模態框
        const modal = new bootstrap.Modal(document.getElementById('category-order-modal'));
        modal.show();
    }
    
    // 獲取某個類別的案件數量
    function getCategoryCount(categoryId) {
        let count = 0;
        allCases.forEach(caseItem => {
            if (caseItem.categories) {
                if (Array.isArray(caseItem.categories)) {
                    if (caseItem.categories.includes(categoryId) || 
                        caseItem.categories.some(cat => typeof cat === 'object' && cat.id === categoryId)) {
                        count++;
                    }
                } else if (typeof caseItem.categories === 'string') {
                    try {
                        const cats = JSON.parse(caseItem.categories);
                        if (Array.isArray(cats) && (cats.includes(categoryId) || 
                            cats.some(cat => typeof cat === 'object' && cat.id === categoryId))) {
                            count++;
                        }
                    } catch (e) {}
                }
            }
        });
        return count;
    }
    
    // 保存類別順序
    document.getElementById('save-category-order').addEventListener('click', function() {
        const container = document.getElementById('sortable-categories');
        const items = container.querySelectorAll('.list-group-item');
        
        // 修改數據格式，僅提供ID陣列
        const categoryIds = Array.from(items).map(item => item.dataset.id);
        
        // 調用後端API更新類別順序
        showLoading('正在更新類別排序...');
        google.script.run
            .withSuccessHandler(function(stringResponse) {
                hideLoading();
                let response;
                try {
                    response = JSON.parse(stringResponse);
                } catch(e) {
                    console.error('解析更新類別順序回應時發生錯誤:', e);
                    showNotification('處理伺服器回應時出錯', '錯誤');
                    return;
                }
                
                if (response && response.success) {
                    // 關閉模態框
                    bootstrap.Modal.getInstance(document.getElementById('category-order-modal')).hide();
                    // 重新加載類別
                    loadCategories();
                    showNotification('類別順序已更新');
                } else {
                    showNotification('更新類別順序失敗: ' + (response && response.error ? response.error : '未知錯誤'), '錯誤');
                }
            })
            .withFailureHandler(function(error) {
                hideLoading();
                showNotification('與伺服器通訊失敗: ' + error, '錯誤');
            })
            .updateCategoriesOrder(sheetsId, categoryIds);
    });
    
    // 載入類別函數 - 如果此函數還未存在則添加
    function loadCategories() {
        console.log('載入類別...');
        google.script.run
            .withSuccessHandler(function(stringResponse) {
                let response;
                try {
                    response = JSON.parse(stringResponse);
                } catch(e) {
                    console.error('解析類別資料時發生錯誤:', e);
                    showNotification('處理伺服器回應時出錯', '錯誤');
                    return;
                }
                
                if (response && response.success) {
                    categories = response.categories || [];
                    console.log(`已載入 ${categories.length} 個類別`);
                    renderCategoryTags();
                } else {
                    console.error('載入類別失敗:', response && response.error ? response.error : '未知錯誤');
                }
            })
            .withFailureHandler(function(error) {
                console.error('載入類別時發生錯誤:', error);
                showNotification('載入類別時發生錯誤: ' + error, '錯誤');
            })
            .getCategories(sheetsId);
    }
</script>
</body>
</html>
